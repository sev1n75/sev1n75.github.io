<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
    <title>
      MIT 6.S081 2020 学习笔记 | sev1n75 | Binary Exploit</title>

  
  <meta name="author" content="sev1n75">
  

  
  <meta name="description" content="CTF Pwn 选手，以此博客分享技术和学习过程">
  

  
  
  <meta name="keywords" content="OS,MIT,Experiment">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="MIT 6.S081 2020 学习笔记"/>

  <meta property="og:site_name" content="sev1n75"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/images/favicon.png" type="image/png" rel="icon">
  <link href="/images/favicon.png" rel="apple-touch-icon" sizes="76x76">
  <link rel="alternate" href="/atom.xml" title="sev1n75" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  
  <link href="https://fonts.lug.ustc.edu.cn/css?family=Lato|Rubik" rel="stylesheet">
  <script src="/js/pangu-407.min.js"></script>
<meta name="generator" content="Hexo 6.3.0"></head>
<script>
  document.addEventListener(' DOMContentLoaded', () => {
    pangu.autoSpacingPage();
  });
</script>

<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">
        sev1n75's Tech Blog
      </a>
    </h1>
    <p class="site-description">
      
        路漫漫其修远兮，吾将上下而求索
          
    </p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">
            主页
          </a></li>
        
        <li><a href="/archives">
            归档
          </a></li>
        
        <li><a href="/tags">
            标签
          </a></li>
        
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>MIT 6.S081 2020 学习笔记</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2024/03/13/MIT-6-S081-2020-Note/" rel="bookmark">
        <time class="entry-date published" datetime="2024-03-13T07:36:07.000Z">
          2024-03-13
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        

<script type="text/javascript">
    function convertRemToPixels(rem) {    
        return rem * parseFloat(getComputedStyle(document.documentElement).fontSize);
    }
    window.onscroll = function() {
        var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        if (scrollTop > convertRemToPixels(40)) {
            document.getElementsByClassName('toc-article')[0].style.visibility = 'visible';
        } else {
            document.getElementsByClassName('toc-article')[0].style.visibility = 'hidden';
        }
    }
</script>


<div id="toc" class="toc-article">
      <div class="toc-content">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-%E5%89%8D%E8%A8%80"><span class="toc-text">| 0 | 前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Lab-util-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 1 | Lab util 相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-LEC-1-amp-Chapter-1-note"><span class="toc-text">| 1.1 | LEC 1  &amp; Chapter 1 note</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-LEC-2-note"><span class="toc-text">| 1.2 | LEC 2 note</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-Lab-Xv6-and-Unix-utilities"><span class="toc-text">| 1.3 | Lab: Xv6 and Unix utilities</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-1-Boot-xv6-easy"><span class="toc-text">| 1.3.1 | Boot xv6 (easy)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-sleep-easy"><span class="toc-text">| 1.3.2 | sleep (easy)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-3-pingpong-easy"><span class="toc-text">| 1.3.3 | pingpong (easy)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-4-primes-moderate-x2F-hard"><span class="toc-text">| 1.3.4 | primes (moderate)&#x2F;(hard)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-5-find-moderate"><span class="toc-text">| 1.3.5 | find (moderate)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-6-xargs-moderate"><span class="toc-text">| 1.3.6 | xargs (moderate)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Lab-syscall-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 2 | Lab syscall 相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Chapter-2-note-amp-LEC-3-note"><span class="toc-text">| 2.1 | Chapter 2 note &amp; LEC 3 note</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-Abstracting-physical-resources"><span class="toc-text">| 2.1.1 | Abstracting physical resources</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-User-mode-supervisor-mode-and-system-calls"><span class="toc-text">| 2.1.2 | User mode, supervisor mode, and system calls</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-3-Kernel-organization"><span class="toc-text">| 2.1.3 | Kernel organization</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-4-Process-overview"><span class="toc-text">| 2.1.4 | Process overview</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-5-Code-starting-xv6-and-the-first-process"><span class="toc-text">| 2.1.5 | Code: starting xv6 and the first process</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Lab-system-calls"><span class="toc-text">| 2.2 | Lab: system calls</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-System-call-tracing-moderate"><span class="toc-text">| 2.2.1 | System call tracing (moderate)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-Sysinfo-moderate"><span class="toc-text">| 2.2.2 | Sysinfo (moderate)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Lab-pgtbl-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 3 | Lab pgtbl 相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Chapter-3-amp-LEC-4-note"><span class="toc-text">| 3.1 | Chapter 3 &amp; LEC 4 note</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-Paging-hardware"><span class="toc-text">| 3.1.1 | Paging hardware</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-Kernel-address-space"><span class="toc-text">| 3.1.2 | Kernel address space</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-3-Code-creating-an-address-space"><span class="toc-text">| 3.1.3 | Code: creating an address space</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-4-Code-exec"><span class="toc-text">| 3.1.4 | Code: exec</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-LEC-5-note"><span class="toc-text">| 3.2 | LEC 5 note</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-Lab-page-tables"><span class="toc-text">| 3.3 | Lab: page tables</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-Print-a-page-table-easy"><span class="toc-text">| 3.3.1 | Print a page table (easy)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2-A-kernel-page-table-per-process-hard"><span class="toc-text">| 3.3.2 | A kernel page table per process (hard)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-3-Simplify-copyin-copyinstr-hard"><span class="toc-text">| 3.3.3 | Simplify copyin&#x2F;copyinstr (hard)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Lab-trap-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 4 | Lab trap 相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-Chapter-4-amp-LEC-6-note"><span class="toc-text">| 4.1 | Chapter 4 &amp; LEC 6 note</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-RISC-V-trap-machinery"><span class="toc-text">| 4.1.1 | RISC-V trap machinery</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-Traps-from-user-space"><span class="toc-text">| 4.1.2 | Traps from user space</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-3-Traps-from-kernel-space"><span class="toc-text">| 4.1.3 | Traps from kernel space</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-Lab-traps"><span class="toc-text">| 4.3 | Lab: traps</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-1-RISC-V-assembly-easy"><span class="toc-text">| 4.3.1 | RISC-V assembly (easy)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-2-Backtrace-moderate"><span class="toc-text">| 4.3.2 | Backtrace (moderate)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3-3-Alarm-hard"><span class="toc-text">| 4.3.3 | Alarm (hard)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Lab-lazy-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 5 | Lab lazy 相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-Chapter-4-6-amp-LEC-8-note"><span class="toc-text">| 5.1 | Chapter 4.6 &amp; LEC 8 note</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-1-Lazy-Allocation"><span class="toc-text">| 5.1.1 | Lazy Allocation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-2-Copy-On-Write-COW-fork"><span class="toc-text">| 5.1.2 | Copy-On-Write (COW) fork</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-3-%E5%85%B6%E4%BB%96"><span class="toc-text">| 5.1.3 | 其他</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-Chapter-5-amp-LEC-9-note"><span class="toc-text">| 5.2 | Chapter 5 &amp; LEC 9 note</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-Code-Console-input-x2F-output"><span class="toc-text">| 5.2.1 | Code: Console input&#x2F;output</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-Timer-interrupts"><span class="toc-text">| 5.2.2 | Timer interrupts</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-Lab-xv6-lazy-page-allocation"><span class="toc-text">| 5.3 | Lab: xv6 lazy page allocation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-1-Lazy-allocation-moderate-amp-amp-Lazytests-and-Usertests-moderate"><span class="toc-text">| 5.3.1 | Lazy allocation (moderate) &amp;&amp; Lazytests and Usertests (moderate)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Lab-cow-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 6 | Lab cow 相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-Lab-Copy-on-Write-Fork-for-xv6"><span class="toc-text">| 6.1 | Lab: Copy-on-Write Fork for xv6</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Lab-thread-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 7 | Lab thread 相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-Chapter-6-amp-LEC-10-note"><span class="toc-text">| 7.1 | Chapter 6 &amp; LEC 10 note</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-Chapter-7-amp-LEC-11-note-amp-LEC-13-note"><span class="toc-text">| 7.2 | Chapter 7 &amp; LEC 11 note &amp; LEC 13 note</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-Lab-Multithreading"><span class="toc-text">| 7.3 | Lab: Multithreading</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Lab-lock-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 8 | Lab lock 相关</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-Lab-locks"><span class="toc-text">| 8.1 | Lab: locks</span></a></li></ol></li></ol>
      </div>
</div>
<style>
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>



        <h2 id="0-前言"><a href="#0-前言" class="headerlink" title="| 0 | 前言"></a>| 0 | 前言</h2><p>MIT 6.S081<del>(6.828?6.1810?)</del> 是 MIT 一门操作系统课程（<u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/schedule.html">2020年课程网址</a></u>）这是我的学习笔记，包含课程 LEC, xv6 Book 以及 Lab。</p>
<p>实验环境为: Ubuntu 22.04 LTS</p>
<blockquote>
<p>✅ 持续更新</p>
</blockquote>
<span id="more"></span>

<blockquote>
<p>笔记中像这样引用的句子为课程中的原文。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/sev1n75/xv6-riscv">🔗我的 Lab 代码链接</a></p>
<h2 id="1-Lab-util-相关"><a href="#1-Lab-util-相关" class="headerlink" title="| 1 | Lab util 相关"></a>| 1 | Lab util 相关</h2><h3 id="1-1-LEC-1-amp-Chapter-1-note"><a href="#1-1-LEC-1-amp-Chapter-1-note" class="headerlink" title="| 1.1 | LEC 1  &amp; Chapter 1 note"></a>| 1.1 | LEC 1  &amp; Chapter 1 note</h3><ul>
<li><p>exec</p>
<img alt="图 0" src="/images/image-20240215105112.png" />  
</li>
<li><p>redirect</p>
<img alt="redirect" src="/images/image-20240215105920.png" />  

<ul>
<li><p><code>cat &lt; input.txt</code></p>
<img alt="图 5" src="/images/image-20240215025128.png" /></li>
</ul>
<blockquote>
<p>The <code>2&gt;&amp;1</code> tells the shell to give the command a file descriptor 2 that is a duplicate of descriptor 1</p>
</blockquote>
</li>
<li><p>pipe</p>
<img alt="图 2" src="/images/image-20240215110731.png" />  

<img alt="图 3" src="/images/image-20240215111726.png" />  

<p>在 <code>fork</code> 之前创建  <code>pipe</code> 然后把 <code>ls</code> 的 <code>stdout(1)</code> 换成 <code>pipefd[1]</code>; <code>grep</code> 的 <code>stdin(0)</code> 换成 <code>pipefd[0]</code> 。</p>
</li>
<li><p>File System</p>
<ul>
<li><p>list</p>
<img alt="图 4" src="/images/image-20240215112407.png" />  
</li>
<li><p>a file</p>
<img alt="图 6" src="/images/image-20240215031307.png" />  

<blockquote>
<p>The file’s <strong>inode and the disk space</strong> holding its content are only <strong>freed</strong> when the file’s link count is zero <strong>and</strong> no file descriptors refer to it.</p>
</blockquote>
</li>
<li><p>cd</p>
<img alt="图 7" src="/images/image-20240215032040.png" /></li>
</ul>
</li>
</ul>
<h3 id="1-2-LEC-2-note"><a href="#1-2-LEC-2-note" class="headerlink" title="| 1.2 | LEC 2 note"></a>| 1.2 | LEC 2 note</h3><ul>
<li><p>Use GNU debugger</p>
<ul>
<li><p>Conditional breakpoints</p>
<blockquote>
<p><code>break &lt;location&gt; if &lt;condition&gt;</code> sets a breakpoint at the specified location, but only breaks if the condition is satisfied.</p>
<p><code>cond &lt;number&gt; &lt;condition&gt;</code> adds a condition on an existing breakpoint.</p>
</blockquote>
</li>
<li><p>Watchpoints</p>
<blockquote>
<p><code>watch &lt;expression&gt;</code> will stop execution whenever the expression’s value changes.</p>
<p><code>watch -l &lt;address&gt;</code> will stop execution whenever the contents of the specified memory address change.</p>
<p>What’s the difference between wa var and wa -l &amp;var?</p>
<p><code>rwatch [-l] &lt;expression&gt;</code> will stop execution whenever the value of the expression is read.</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="1-3-Lab-Xv6-and-Unix-utilities"><a href="#1-3-Lab-Xv6-and-Unix-utilities" class="headerlink" title="| 1.3 | Lab: Xv6 and Unix utilities"></a>| 1.3 | <u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/labs/util.html">Lab: Xv6 and Unix utilities</a></u></h3><blockquote>
<p>This lab will familiarize you with xv6 and its system calls.</p>
</blockquote>
<h4 id="1-3-1-Boot-xv6-easy"><a href="#1-3-1-Boot-xv6-easy" class="headerlink" title="| 1.3.1 | Boot xv6 (easy)"></a>| 1.3.1 | Boot xv6 (easy)</h4><ul>
<li><p><code>sudo apt-get install qemu-system-misc=1:4.2-3ubuntu6</code> 失败</p>
<p>参考下面的手动编译方法编译 qemu</p>
<ul>
<li>补充： <code>sudo apt-get install libpixman-1-dev</code> 安装 pixman devel packag</li>
</ul>
</li>
</ul>
<img alt="图 9" src="/images/image-20240215045015.png" style="zoom:60%" />  

<h4 id="1-3-2-sleep-easy"><a href="#1-3-2-sleep-easy" class="headerlink" title="| 1.3.2 | sleep (easy)"></a>| 1.3.2 | sleep (easy)</h4><img alt="图 10" src="/images/image-20240215075032.png" />  

<h4 id="1-3-3-pingpong-easy"><a href="#1-3-3-pingpong-easy" class="headerlink" title="| 1.3.3 | pingpong (easy)"></a>| 1.3.3 | pingpong (easy)</h4><p>为了阻止 parent 在向管道写了数据后立刻把数据读出来，使得 child 不能读到数据，可以在 parent 调用 <code>write(pipefds[1], &quot;c&quot;, 1);</code> 后接着调用 <code>sleep</code> 。</p>
<img alt="图 11" src="/images/image-20240215083157.png" />  

<h4 id="1-3-4-primes-moderate-x2F-hard"><a href="#1-3-4-primes-moderate-x2F-hard" class="headerlink" title="| 1.3.4 | primes (moderate)&#x2F;(hard)"></a>| 1.3.4 | primes (moderate)&#x2F;(hard)</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user/user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">  <span class="type">int</span> numcnt, fds_1[<span class="number">2</span>], fds_2[<span class="number">2</span>], fds_3[<span class="number">2</span>], curnum;</span><br><span class="line">  <span class="type">char</span> tmp[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  pipe(fds_1);</span><br><span class="line">  pipe(fds_3);</span><br><span class="line">  <span class="keyword">if</span> (fork() != <span class="number">0</span>) &#123; <span class="comment">// 排除 2 的倍数</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;prime %d\n&quot;</span>, <span class="number">2</span>);</span><br><span class="line">    close(fds_1[<span class="number">0</span>]);</span><br><span class="line">    close(fds_3[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">for</span> (numcnt = <span class="number">3</span>; numcnt &lt;= <span class="number">35</span>; numcnt++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (numcnt % <span class="number">2</span> != <span class="number">0</span>) &#123; <span class="comment">// 不是 2 的倍数</span></span><br><span class="line">        write(fds_1[<span class="number">1</span>], (<span class="type">char</span>*)&amp;numcnt, <span class="number">4</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fds_1[<span class="number">1</span>]);  <span class="comment">// 使得第 33 行可以返回 0</span></span><br><span class="line">    <span class="keyword">while</span>(read(fds_3[<span class="number">0</span>], tmp, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    close(fds_1[<span class="number">1</span>]);</span><br><span class="line">    close(fds_3[<span class="number">0</span>]);</span><br><span class="line">    pipe(fds_2);  <span class="comment">// 先 close 再 pipe</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fork() != <span class="number">0</span>) &#123; <span class="comment">// 排除 3 的倍数</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;prime %d\n&quot;</span>, <span class="number">3</span>);</span><br><span class="line">      close(fds_2[<span class="number">0</span>]);</span><br><span class="line">      close(fds_3[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span>(read(fds_1[<span class="number">0</span>], (<span class="type">char</span>*)&amp;curnum, <span class="number">4</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (curnum % <span class="number">3</span> != <span class="number">0</span>) &#123;</span><br><span class="line">          write(fds_2[<span class="number">1</span>], (<span class="type">char</span>*)&amp;curnum, <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      close(fds_2[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 排除 5 的倍数</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;prime %d\n&quot;</span>, <span class="number">5</span>);</span><br><span class="line">      close(fds_1[<span class="number">0</span>]);</span><br><span class="line">      close(fds_2[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span>(read(fds_2[<span class="number">0</span>], (<span class="type">char</span>*)&amp;curnum, <span class="number">4</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (curnum % <span class="number">5</span> != <span class="number">0</span>)</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;prime %d\n&quot;</span>, curnum);</span><br><span class="line">      &#125;</span><br><span class="line">      close(fds_3[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//printf(&quot;%d exit&quot;, getpid());</span></span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img alt="图 12" src="/images/image-20240215100148.png" />  

<h4 id="1-3-5-find-moderate"><a href="#1-3-5-find-moderate" class="headerlink" title="| 1.3.5 | find (moderate)"></a>| 1.3.5 | find (moderate)</h4><blockquote>
<p>后补</p>
</blockquote>
<h4 id="1-3-6-xargs-moderate"><a href="#1-3-6-xargs-moderate" class="headerlink" title="| 1.3.6 | xargs (moderate)"></a>| 1.3.6 | xargs (moderate)</h4><blockquote>
<p>后补</p>
</blockquote>
<h2 id="2-Lab-syscall-相关"><a href="#2-Lab-syscall-相关" class="headerlink" title="| 2 | Lab syscall 相关"></a>| 2 | Lab syscall 相关</h2><h3 id="2-1-Chapter-2-note-amp-LEC-3-note"><a href="#2-1-Chapter-2-note-amp-LEC-3-note" class="headerlink" title="| 2.1 | Chapter 2 note &amp; LEC 3 note"></a>| 2.1 | Chapter 2 note &amp; LEC 3 note</h3><blockquote>
<p>Thus an operating system must fulfill three requirements: <strong>multiplexing</strong>, <strong>isolation</strong>, and <strong>interaction</strong>.</p>
</blockquote>
<p>Multiplexing 也就是 time-sharing，防止某个进程持续占有 CPU。</p>
<p>Isolation 为减少某些不受信任的应用对其他的影响。</p>
<p>Interaction 为实现进程之间的信息交互，实现更复杂的功能。</p>
<h4 id="2-1-1-Abstracting-physical-resources"><a href="#2-1-1-Abstracting-physical-resources" class="headerlink" title="| 2.1.1 | Abstracting physical resources"></a>| 2.1.1 | Abstracting physical resources</h4><blockquote>
<p>To achieve strong <strong>isolation</strong> it’s helpful to forbid applications from directly accessing sensitive hardware resources, and instead to <u>abstract the resources into services.</u></p>
<p>Unix <u>transparently switches hardware CPUs among processes</u>, saving and restor- ing register state as necessary</p>
<p>Many forms of <strong>interaction</strong> among Unix processes occur <u>via file descriptors</u>.</p>
</blockquote>
<h4 id="2-1-2-User-mode-supervisor-mode-and-system-calls"><a href="#2-1-2-User-mode-supervisor-mode-and-system-calls" class="headerlink" title="| 2.1.2 | User mode, supervisor mode, and system calls"></a>| 2.1.2 | User mode, supervisor mode, and system calls</h4><blockquote>
<p><strong>RISC-V</strong> has three modes in which the CPU can execute instructions: <strong><i>machine mode, supervisor mode, and user mode</i></strong>.</p>
<p>An application can execute only user-mode instructions is said to be running in <i>user space</i>.</p>
<p>The software in supervisor mode can also execute privileged instructions and is said to be running in <i>kernel space</i>.</p>
<p>The software running in <i>kernel space </i>(or in supervisor mode) is called the <i>kernel</i>.</p>
<p>CPUs provide a special instruction that switches the CPU <u>from user mode to supervisor mode</u> and enters the kernel at an entry point specified <u>by the kernel</u>. (RISC-V provides the <code>ecall</code> instruction)</p>
</blockquote>
<h4 id="2-1-3-Kernel-organization"><a href="#2-1-3-Kernel-organization" class="headerlink" title="| 2.1.3 | Kernel organization"></a>| 2.1.3 | Kernel organization</h4><blockquote>
<p><strong>monolithic kernel</strong>: entire operating system resides in the kernel</p>
</blockquote>
<p>在 monolithic kernel 情况下，kernel 等于操作系统。</p>
<blockquote>
<p>bad: <u>no isolation</u> within (subsystems)</p>
</blockquote>
<p>microkernel 暂时不考虑。</p>
<h4 id="2-1-4-Process-overview"><a href="#2-1-4-Process-overview" class="headerlink" title="| 2.1.4 | Process overview"></a>| 2.1.4 | Process overview</h4><blockquote>
<p>The unit of <strong>isolation</strong> in Unix is a <strong>process</strong>.</p>
</blockquote>
<p>隔离包括 processes 之间的隔离，以及 process 和 kernel 之间的隔离。</p>
<p>进程提供了一个<strong>看上去私有</strong>的内存空间(address space)。</p>
<p>address space 通过 <strong>page tables</strong> 实现。</p>
<h4 id="2-1-5-Code-starting-xv6-and-the-first-process"><a href="#2-1-5-Code-starting-xv6-and-the-first-process" class="headerlink" title="| 2.1.5 | Code: starting xv6 and the first process"></a>| 2.1.5 | Code: starting xv6 and the first process</h4><p><code>_entry</code> -&gt; <code>start</code> -&gt; <code>main</code> -&gt; <code>userinit</code> -&gt; <code>/init</code></p>
<h3 id="2-2-Lab-system-calls"><a href="#2-2-Lab-system-calls" class="headerlink" title="| 2.2 | Lab: system calls"></a>| 2.2 | <u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/labs/syscall.html">Lab: system calls</a></u></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sev1n@ubuntu2204 ~/f/6/xv6-labs-2020&gt; ./grade-lab-syscall                                                     syscall!?</span><br><span class="line">make: <span class="string">&#x27;kernel/kernel&#x27;</span> is up to <span class="built_in">date</span>.</span><br><span class="line">== Test trace 32 grep == trace 32 grep: OK (1.4s)</span><br><span class="line">== Test trace all grep == trace all grep: OK (1.1s)</span><br><span class="line">== Test trace nothing == trace nothing: OK (0.9s)</span><br><span class="line">== Test trace children == trace children: OK (16.6s)</span><br><span class="line">== Test sysinfotest == sysinfotest: OK (2.8s)</span><br><span class="line">== Test time ==</span><br><span class="line">time: OK</span><br><span class="line">Score: 35/35</span><br></pre></td></tr></table></figure>

<h4 id="2-2-1-System-call-tracing-moderate"><a href="#2-2-1-System-call-tracing-moderate" class="headerlink" title="| 2.2.1 | System call tracing (moderate)"></a>| 2.2.1 | System call tracing (moderate)</h4><p>注意 <code>sys_trace</code> 成功时返回值为 0</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">sev1n@ubuntu2204 ~/f/6/xv6-labs-2020&gt; git diff syscall</span><br><span class="line"><span class="comment">diff --git a/kernel/proc.c b/kernel/proc.c</span></span><br><span class="line"><span class="comment">index 6afafa1..348fc50 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/proc.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/proc.c</span></span><br><span class="line"><span class="meta">@@ -277,6 +277,8 @@</span> fork(void)</span><br><span class="line"></span><br><span class="line">   np-&gt;parent = p;</span><br><span class="line"></span><br><span class="line"><span class="addition">+  np-&gt;trace_mask = p-&gt;trace_mask;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   // copy saved user registers.</span><br><span class="line">   *(np-&gt;trapframe) = *(p-&gt;trapframe);</span><br><span class="line"></span><br><span class="line"><span class="comment">diff --git a/kernel/proc.h b/kernel/proc.h</span></span><br><span class="line"><span class="comment">index 9c16ea7..78ff58a 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/proc.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/proc.h</span></span><br><span class="line"><span class="meta">@@ -103,4 +103,5 @@</span> struct proc &#123;</span><br><span class="line">   struct file *ofile[NOFILE];  // Open files</span><br><span class="line">   struct inode *cwd;           // Current directory</span><br><span class="line">   char name[16];               // Process name (debugging)</span><br><span class="line"><span class="addition">+  int trace_mask;</span></span><br><span class="line"> &#125;;</span><br><span class="line"><span class="comment">diff --git a/kernel/syscall.c b/kernel/syscall.c</span></span><br><span class="line"><span class="comment">index c1b3670..d845045 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/syscall.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/syscall.c</span></span><br><span class="line"><span class="meta">@@ -104,6 +104,7 @@</span> extern uint64 sys_unlink(void);</span><br><span class="line"> extern uint64 sys_wait(void);</span><br><span class="line"> extern uint64 sys_write(void);</span><br><span class="line"> extern uint64 sys_uptime(void);</span><br><span class="line"><span class="addition">+extern uint64 sys_trace(void);</span></span><br><span class="line"></span><br><span class="line"> static uint64 (*syscalls[])(void) = &#123;</span><br><span class="line"> [SYS_fork]    sys_fork,</span><br><span class="line"><span class="meta">@@ -127,6 +128,32 @@</span> static uint64 (*syscalls[])(void) = &#123;</span><br><span class="line"> [SYS_link]    sys_link,</span><br><span class="line"> [SYS_mkdir]   sys_mkdir,</span><br><span class="line"> [SYS_close]   sys_close,</span><br><span class="line"><span class="addition">+[SYS_trace]   sys_trace,</span></span><br><span class="line"><span class="addition">+&#125;;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+static char* syscall_names[]= &#123;</span></span><br><span class="line"><span class="addition">+[SYS_fork]    &quot;fork&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_exit]    &quot;exit&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_wait]    &quot;wait&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_pipe]    &quot;pipe&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_read]    &quot;read&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_kill]    &quot;kill&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_exec]    &quot;exec&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_fstat]   &quot;fstat&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_chdir]   &quot;chdir&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_dup]     &quot;dup&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_getpid]  &quot;getpid&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_sbrk]    &quot;sbrk&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_sleep]   &quot;sleep&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_uptime]  &quot;uptime&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_open]    &quot;open&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_write]   &quot;write&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_mknod]   &quot;mknod&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_unlink]  &quot;unlink&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_link]    &quot;link&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_mkdir]   &quot;mkdir&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_close]   &quot;close&quot;,</span></span><br><span class="line"><span class="addition">+[SYS_trace]   &quot;trace&quot;,</span></span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> void</span><br><span class="line"><span class="meta">@@ -138,6 +165,9 @@</span> syscall(void)</span><br><span class="line">   num = p-&gt;trapframe-&gt;a7;</span><br><span class="line">   if(num &gt; 0 &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;</span><br><span class="line">     p-&gt;trapframe-&gt;a0 = syscalls[num]();</span><br><span class="line"><span class="addition">+    // if mask is set</span></span><br><span class="line"><span class="addition">+    if(p-&gt;trace_mask &amp; (1 &lt;&lt; num))</span></span><br><span class="line"><span class="addition">+      printf(&quot;%d: syscall %s -&gt; %d\n&quot;, p-&gt;pid, syscall_names[num], p-&gt;trapframe-&gt;a0);</span></span><br><span class="line">   &#125; else &#123;</span><br><span class="line">     printf(&quot;%d %s: unknown sys call %d\n&quot;,</span><br><span class="line">             p-&gt;pid, p-&gt;name, num);</span><br><span class="line"><span class="comment">diff --git a/kernel/syscall.h b/kernel/syscall.h</span></span><br><span class="line"><span class="comment">index bc5f356..cc112b9 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/syscall.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/syscall.h</span></span><br><span class="line"><span class="meta">@@ -20,3 +20,4 @@</span></span><br><span class="line"> #define SYS_link   19</span><br><span class="line"> #define SYS_mkdir  20</span><br><span class="line"> #define SYS_close  21</span><br><span class="line"><span class="addition">+#define SYS_trace  22</span></span><br><span class="line"><span class="comment">diff --git a/kernel/sysproc.c b/kernel/sysproc.c</span></span><br><span class="line"><span class="comment">index e8bcda9..84939d7 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/sysproc.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/sysproc.c</span></span><br><span class="line"><span class="meta">@@ -95,3 +95,13 @@</span> sys_uptime(void)</span><br><span class="line">   release(&amp;tickslock);</span><br><span class="line">   return xticks;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+uint64</span></span><br><span class="line"><span class="addition">+sys_trace(void)</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+  int n;</span></span><br><span class="line"><span class="addition">+  if(argint(0, &amp;n) &lt; 0)</span></span><br><span class="line"><span class="addition">+    return -1;</span></span><br><span class="line"><span class="addition">+  myproc()-&gt;trace_mask = n;</span></span><br><span class="line"><span class="addition">+  return 0;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="comment">diff --git a/user/user.h b/user/user.h</span></span><br><span class="line"><span class="comment">index b71ecda..fdeeefc 100644</span></span><br><span class="line"><span class="comment">--- a/user/user.h</span></span><br><span class="line"><span class="comment">+++ b/user/user.h</span></span><br><span class="line"><span class="meta">@@ -23,6 +23,7 @@</span> int getpid(void);</span><br><span class="line"> char* sbrk(int);</span><br><span class="line"> int sleep(int);</span><br><span class="line"> int uptime(void);</span><br><span class="line"><span class="addition">+int trace(int);</span></span><br><span class="line"></span><br><span class="line"> // ulib.c</span><br><span class="line"> int stat(const char*, struct stat*);</span><br><span class="line"><span class="comment">diff --git a/user/usys.pl b/user/usys.pl</span></span><br><span class="line"><span class="comment">index 01e426e..9c97b05 100755</span></span><br><span class="line"><span class="comment">--- a/user/usys.pl</span></span><br><span class="line"><span class="comment">+++ b/user/usys.pl</span></span><br><span class="line"><span class="meta">@@ -36,3 +36,4 @@</span> entry(&quot;getpid&quot;);</span><br><span class="line"> entry(&quot;sbrk&quot;);</span><br><span class="line"> entry(&quot;sleep&quot;);</span><br><span class="line"> entry(&quot;uptime&quot;);</span><br><span class="line"><span class="addition">+entry(&quot;trace&quot;);</span></span><br></pre></td></tr></table></figure>

<h4 id="2-2-2-Sysinfo-moderate"><a href="#2-2-2-Sysinfo-moderate" class="headerlink" title="| 2.2.2 | Sysinfo (moderate)"></a>| 2.2.2 | Sysinfo (moderate)</h4><ul>
<li><p>xv6 的内存管理机制</p>
<p>通过单链表 <code>freelist</code> 连接所有闲置的 PAGE，每次从头(<code>kmem-&gt;freelist</code>)存取</p>
</li>
</ul>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">sev1n@ubuntu2204 ~/f/6/xv6-labs-2020&gt; git diff syscall</span><br><span class="line"><span class="comment">diff --git a/kernel/kalloc.c b/kernel/kalloc.c</span></span><br><span class="line"><span class="comment">index fa6a0ac..62ce964 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/kalloc.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/kalloc.c</span></span><br><span class="line"><span class="meta">@@ -80,3 +80,15 @@</span> kalloc(void)</span><br><span class="line">     memset((char*)r, 5, PGSIZE); // fill with junk</span><br><span class="line">   return (void*)r;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+int count_freemem(void) &#123;</span></span><br><span class="line"><span class="addition">+  int page_count = 0;</span></span><br><span class="line"><span class="addition">+  struct run *r;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  acquire(&amp;kmem.lock);</span></span><br><span class="line"><span class="addition">+  for(r = kmem.freelist; r; r = r-&gt;next)</span></span><br><span class="line"><span class="addition">+    page_count++;</span></span><br><span class="line"><span class="addition">+  release(&amp;kmem.lock);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  return (page_count*PGSIZE);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="comment">diff --git a/kernel/proc.c b/kernel/proc.c</span></span><br><span class="line"><span class="comment">index 348fc50..2b4435c 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/proc.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/proc.c</span></span><br><span class="line"><span class="meta">@@ -695,3 +695,11 @@</span> procdump(void)</span><br><span class="line">     printf(&quot;\n&quot;);</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+int count_nproc(void) &#123;</span></span><br><span class="line"><span class="addition">+  int i, count=0;</span></span><br><span class="line"><span class="addition">+  for(i = 0; i &lt; NPROC; i++)</span></span><br><span class="line"><span class="addition">+    if(proc[i].state != UNUSED)</span></span><br><span class="line"><span class="addition">+      count++;</span></span><br><span class="line"><span class="addition">+  return count;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="comment">diff --git a/kernel/syscall.c b/kernel/syscall.c</span></span><br><span class="line"><span class="comment">index d845045..0f7149b 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/syscall.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/syscall.c</span></span><br><span class="line"><span class="meta">@@ -105,6 +105,7 @@</span> extern uint64 sys_wait(void);</span><br><span class="line"> extern uint64 sys_write(void);</span><br><span class="line"> extern uint64 sys_uptime(void);</span><br><span class="line"> extern uint64 sys_trace(void);</span><br><span class="line"><span class="addition">+extern uint64 sys_sysinfo(void);</span></span><br><span class="line"></span><br><span class="line"> static uint64 (*syscalls[])(void) = &#123;</span><br><span class="line"> [SYS_fork]    sys_fork,</span><br><span class="line"><span class="meta">@@ -129,6 +130,7 @@</span> static uint64 (*syscalls[])(void) = &#123;</span><br><span class="line"> [SYS_mkdir]   sys_mkdir,</span><br><span class="line"> [SYS_close]   sys_close,</span><br><span class="line"> [SYS_trace]   sys_trace,</span><br><span class="line"><span class="addition">+[SYS_sysinfo] sys_sysinfo,</span></span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> static char* syscall_names[]= &#123;</span><br><span class="line"><span class="meta">@@ -154,6 +156,7 @@</span> static char* syscall_names[]= &#123;</span><br><span class="line"> [SYS_mkdir]   &quot;mkdir&quot;,</span><br><span class="line"> [SYS_close]   &quot;close&quot;,</span><br><span class="line"> [SYS_trace]   &quot;trace&quot;,</span><br><span class="line"><span class="addition">+[SYS_sysinfo] &quot;sysinfo&quot;,</span></span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> void</span><br><span class="line"><span class="comment">diff --git a/kernel/syscall.h b/kernel/syscall.h</span></span><br><span class="line"><span class="comment">index cc112b9..0dfedc7 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/syscall.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/syscall.h</span></span><br><span class="line"><span class="meta">@@ -21,3 +21,4 @@</span></span><br><span class="line"> #define SYS_mkdir  20</span><br><span class="line"> #define SYS_close  21</span><br><span class="line"> #define SYS_trace  22</span><br><span class="line"><span class="addition">+#define SYS_sysinfo 23</span></span><br><span class="line"><span class="comment">diff --git a/kernel/sysproc.c b/kernel/sysproc.c</span></span><br><span class="line"><span class="comment">index 84939d7..593dc9b 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/sysproc.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/sysproc.c</span></span><br><span class="line"><span class="meta">@@ -6,6 +6,7 @@</span></span><br><span class="line"> #include &quot;memlayout.h&quot;</span><br><span class="line"> #include &quot;spinlock.h&quot;</span><br><span class="line"> #include &quot;proc.h&quot;</span><br><span class="line"><span class="addition">+#include &quot;sysinfo.h&quot;</span></span><br><span class="line"></span><br><span class="line"> uint64</span><br><span class="line"> sys_exit(void)</span><br><span class="line"><span class="meta">@@ -105,3 +106,21 @@</span> sys_trace(void)</span><br><span class="line">   myproc()-&gt;trace_mask = n;</span><br><span class="line">   return 0;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+extern int count_nproc(void);</span></span><br><span class="line"><span class="addition">+extern int count_freemem(void);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+uint64</span></span><br><span class="line"><span class="addition">+sys_sysinfo(void)</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+  struct sysinfo info = &#123;0&#125;;</span></span><br><span class="line"><span class="addition">+  uint64 addr;</span></span><br><span class="line"><span class="addition">+  struct proc *p = myproc();</span></span><br><span class="line"><span class="addition">+  if(argaddr(0, &amp;addr) &lt; 0)</span></span><br><span class="line"><span class="addition">+    return -1;</span></span><br><span class="line"><span class="addition">+  info.freemem = count_freemem();</span></span><br><span class="line"><span class="addition">+  info.nproc = count_nproc();</span></span><br><span class="line"><span class="addition">+  if(copyout(p-&gt;pagetable, addr, (char *)&amp;info, sizeof(info)) &lt; 0)</span></span><br><span class="line"><span class="addition">+    return -1;</span></span><br><span class="line"><span class="addition">+  return 0;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="comment">diff --git a/user/user.h b/user/user.h</span></span><br><span class="line"><span class="comment">index fdeeefc..c82ca1f 100644</span></span><br><span class="line"><span class="comment">--- a/user/user.h</span></span><br><span class="line"><span class="comment">+++ b/user/user.h</span></span><br><span class="line"><span class="meta">@@ -24,6 +24,8 @@</span> char* sbrk(int);</span><br><span class="line"> int sleep(int);</span><br><span class="line"> int uptime(void);</span><br><span class="line"> int trace(int);</span><br><span class="line"><span class="addition">+struct sysinfo;</span></span><br><span class="line"><span class="addition">+int sysinfo(struct sysinfo *);</span></span><br><span class="line"></span><br><span class="line"> // ulib.c</span><br><span class="line"> int stat(const char*, struct stat*);</span><br><span class="line"><span class="comment">diff --git a/user/usys.pl b/user/usys.pl</span></span><br><span class="line"><span class="comment">index 9c97b05..bc109fd 100755</span></span><br><span class="line"><span class="comment">--- a/user/usys.pl</span></span><br><span class="line"><span class="comment">+++ b/user/usys.pl</span></span><br><span class="line"><span class="meta">@@ -37,3 +37,4 @@</span> entry(&quot;sbrk&quot;);</span><br><span class="line"> entry(&quot;sleep&quot;);</span><br><span class="line"> entry(&quot;uptime&quot;);</span><br><span class="line"> entry(&quot;trace&quot;);</span><br><span class="line"><span class="addition">+entry(&quot;sysinfo&quot;);</span></span><br></pre></td></tr></table></figure>

<h2 id="3-Lab-pgtbl-相关"><a href="#3-Lab-pgtbl-相关" class="headerlink" title="| 3 | Lab pgtbl 相关"></a>| 3 | Lab pgtbl 相关</h2><h3 id="3-1-Chapter-3-amp-LEC-4-note"><a href="#3-1-Chapter-3-amp-LEC-4-note" class="headerlink" title="| 3.1 | Chapter 3 &amp; LEC 4 note"></a>| 3.1 | Chapter 3 &amp; LEC 4 note</h3><h4 id="3-1-1-Paging-hardware"><a href="#3-1-1-Paging-hardware" class="headerlink" title="| 3.1.1 | Paging hardware"></a>| 3.1.1 | Paging hardware</h4><img alt="图 0" src="/images/image-20240306030218.png" />  

<blockquote>
<p><code>PTE_U</code> controls whether instructions in <u>user mode are allowed to access the page</u>;</p>
</blockquote>
<p><code>satp</code> 寄存器保存 l2 页表的<strong>物理地址</strong></p>
<p>虚拟地址到物理地址的翻译过程：</p>
<ul>
<li>当前 process 的 satp 寄存器找到 l2 页表物理地址</li>
<li>通过 l2 的 9 bits(和 2^9&#x3D;512 个 PTE 一一对应)找到对应的 44 bits PPN<ul>
<li><code>l2_pte = l2_pgtbl[PX(2, va)]</code></li>
</ul>
</li>
<li>通过 l2 PPN 找到 l1 页表的物理地址<ul>
<li><code>l1_pgtbl = PTE2PA(l2_pte)</code></li>
</ul>
</li>
<li>通过 l1 的 9 bits 找到 l0 页表的物理地址<ul>
<li><code>l0_pgtbl = PTE2PA(l1_pgtbl[PX(1, va)])</code></li>
</ul>
</li>
<li>通过 l0 的 9 bits 找到对应页的物理地址(A)<ul>
<li><code>l0_pte = l0_pgtbl[PX(0, va)]</code></li>
</ul>
</li>
<li>得到最终物理地址<ul>
<li><code>pa = PTE2PA(l0_pte) | (va &amp; PGSHIFT)</code></li>
</ul>
</li>
</ul>
<p>为什么多级页表可以节省内存？</p>
<ul>
<li>使用多级页表，程序一开始只需要三个页表(3*512 PAGE)，l2,l1,页表内都只有一个 pte，其他空余的位置不需要分配 pte，等需要的时候再分配。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/riscv.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGSIZE 4096 <span class="comment">// bytes per page</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGSHIFT 12  <span class="comment">// bits of offset **within** a page</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGROUNDUP(sz)  (((sz)+PGSIZE-1) &amp; ~(PGSIZE-1))  <span class="comment">// 向上取整对其 page</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGROUNDDOWN(a) (((a)) &amp; ~(PGSIZE-1))  <span class="comment">// 向下取整对其 page</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_V (1L &lt;&lt; 0) <span class="comment">// valid</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_R (1L &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_W (1L &lt;&lt; 2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_X (1L &lt;&lt; 3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_U (1L <span class="string">&lt;&lt; 4) // 1 -&gt;</span> user can access</span></span><br><span class="line"><span class="comment">// 只用了这几个 bit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// shift a physical address to the right place for a PTE.</span></span><br><span class="line"><span class="comment">// 12 即 PGSHIFT，10 是因为低 10 bit 是 Flags</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PA2PTE(pa) ((((uint64)pa) &gt;&gt; 12) &lt;&lt; 10)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE2PA(pte) (((pte) &gt;&gt; 10) &lt;&lt; 12)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 0x3FF 10 bits</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_FLAGS(pte) ((pte) &amp; 0x3FF)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// extract the three 9-bit page table indices from a virtual address.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PXMASK          0x1FF <span class="comment">// 9 bits</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PXSHIFT(level)  (PGSHIFT+(9*(level)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PX(level, va) ((((uint64) (va)) &gt;&gt; PXSHIFT(level)) &amp; PXMASK)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// one beyond the highest possible virtual address.</span></span><br><span class="line"><span class="comment">// MAXVA is actually one bit less than the max allowed by</span></span><br><span class="line"><span class="comment">// Sv39, to avoid having to sign-extend virtual addresses</span></span><br><span class="line"><span class="comment">// that have the high bit set.</span></span><br><span class="line"><span class="comment">// 即最高有效位</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXVA (1L &lt;&lt; (9 + 9 + 9 + 12 - 1))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> uint64 <span class="type">pte_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> uint64 *<span class="type">pagetable_t</span>; <span class="comment">// 512 PTEs</span></span><br><span class="line"><span class="keyword">typedef</span> uint64 *<span class="type">pagetable_t</span>; <span class="comment">// 512 PTEs 0~2^9</span></span><br></pre></td></tr></table></figure>

<h4 id="3-1-2-Kernel-address-space"><a href="#3-1-2-Kernel-address-space" class="headerlink" title="| 3.1.2 | Kernel address space"></a>| 3.1.2 | Kernel address space</h4><img alt="图 1" src="/images/image-20240306080809.png" />  

<h4 id="3-1-3-Code-creating-an-address-space"><a href="#3-1-3-Code-creating-an-address-space" class="headerlink" title="| 3.1.3 | Code: creating an address space"></a>| 3.1.3 | Code: creating an address space</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kinit-&gt;kvminit-&gt;kvminithart-&gt;procinit</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kinit</code> 把 kernel end address 到 PHYSTOP 之间的地址分页，组织到 <code>freelist</code> 链表里</li>
<li><code>kvminit</code><ul>
<li>首先调用 <code>kalloc</code> 分配一个 PAGE 作为 kernel_pagetable</li>
<li>调用 <code>kvmmap</code> 映射上一节(3.1.3)的地址</li>
<li><code>kvmmap</code> 调用 <code>mappages(kernel_pagetable, va, sz, pa, perm)</code></li>
<li><code>mappages</code> 调用 <code>pte = walk(pagetable, a, 1)</code> 把虚拟地址 va 映射到 kernel_pagetable</li>
</ul>
</li>
<li><code>kvminithart</code> 设置 <code>satp</code> 寄存器并清空 TLB</li>
<li><code>procinit</code><ul>
<li>调用 <code>kvmmap</code> 给 <code>KSTACK</code> 宏计算出来的 kernel_stack 虚拟地址映射物理地址</li>
<li>调用 <code>kvminithart</code></li>
</ul>
</li>
</ul>
<p>注意：</p>
<ul>
<li><code>kalloc</code> 分配的一个 PAGE 可以作为一个 pagetable。因为 PAGESIZE 是 4096B 也就是 8*512B，pte 只用了 54 bit 不到 8B，所以是够的。</li>
<li><code>procinit</code> 最后还要再调用一次 <code>kvminithart</code> 因为”当内核修改页表时，它需要通知硬件关于这些变化，以便处理器能够使用最新的页表进行地址转换。” (by chatGPT)。存疑？</li>
</ul>
<h4 id="3-1-4-Code-exec"><a href="#3-1-4-Code-exec" class="headerlink" title="| 3.1.4 | Code: exec"></a>| 3.1.4 | Code: exec</h4><p>把存在文件系统的一个<strong>文件</strong>加载到内存同时初始化<strong>用户 address space</strong></p>
<p>在检查完文件格式后 <code>exec</code> 会分配一个新的 pagetale，给每个 ELF segment 分配并加载到内存。</p>
<blockquote>
<p><code>Exec</code> <u><strong>allocates</strong> a <strong>new page table</strong> with no user mappings</u> with <code>proc_pagetable</code>, <u><strong>allocates</strong> memory for each ELF <strong>segment</strong></u> with <code>uvmalloc</code>, and <u><strong>loads</strong> each segment into memory</u> with <code>loadseg</code>. <code>loadseg</code> uses <code>walkaddr</code> to find the physical address of the allocated memory at which to write each page of the ELF segment, and <code>readi</code> to read from the file.</p>
</blockquote>
<p>给 userstack 分配一页然后初始化。</p>
<blockquote>
<p><code>Exec</code> <strong>copies</strong> the argument strings to the <strong>top</strong> of the stack one at a time, recording the pointers to them in <code>ustack</code>. It places a null pointer at the end of what will be the <code>argv</code> list passed to <code>main</code>. The first three entries in <code>ustack</code> are the <strong>fake return program counter</strong>, <code>argc</code> and <code>argv</code> pointer.</p>
</blockquote>
<p>分配一个 guard page 在 <code>ustack</code> 的上方</p>
<img alt="图 0" src="/images/image-20240315041134.png" />

<h3 id="3-2-LEC-5-note"><a href="#3-2-LEC-5-note" class="headerlink" title="| 3.2 | LEC 5 note"></a>| 3.2 | LEC 5 note</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">reg    | name  | saver  | description</span><br><span class="line">-------+-------+--------+------------</span><br><span class="line">x0     | zero  |        | hardwired zero</span><br><span class="line">x1     | ra    | caller | return address</span><br><span class="line">x2     | sp    | callee | stack pointer</span><br><span class="line">x3     | gp    |        | global pointer</span><br><span class="line">x4     | tp    |        | thread pointer</span><br><span class="line">x5-7   | t0-2  | caller | temporary registers</span><br><span class="line">x8     | s0/fp | callee | saved register / frame pointer</span><br><span class="line">x9     | s1    | callee | saved register</span><br><span class="line">x10-11 | a0-1  | caller | function arguments / return values</span><br><span class="line">x12-17 | a2-7  | caller | function arguments</span><br><span class="line">x18-27 | s2-11 | callee | saved registers</span><br><span class="line">x28-31 | t3-6  | caller | temporary registers</span><br><span class="line">pc     |       |        | program counter</span><br></pre></td></tr></table></figure>

<h3 id="3-3-Lab-page-tables"><a href="#3-3-Lab-page-tables" class="headerlink" title="| 3.3 | Lab: page tables"></a>| 3.3 | <u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/labs/pgtbl.html">Lab: page tables</a></u></h3><img alt="图 1" src="/images/image-20240318031850.png" />

<p>(把超时改长了点，电脑太拉了 300 秒跑不完)</p>
<h4 id="3-3-1-Print-a-page-table-easy"><a href="#3-3-1-Print-a-page-table-easy" class="headerlink" title="| 3.3.1 | Print a page table (easy)"></a>| 3.3.1 | Print a page table (easy)</h4><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/kernel/defs.h b/kernel/defs.h</span></span><br><span class="line"><span class="comment">index a73b4f7..ebc4cad 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/defs.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/defs.h</span></span><br><span class="line"><span class="meta">@@ -178,6 +178,7 @@</span> uint64          walkaddr(pagetable_t, uint64);</span><br><span class="line"> int             copyout(pagetable_t, uint64, char *, uint64);</span><br><span class="line"> int             copyin(pagetable_t, char *, uint64, uint64);</span><br><span class="line"> int             copyinstr(pagetable_t, char *, uint64, uint64);</span><br><span class="line"><span class="addition">+void            vmprint(pagetable_t);</span></span><br><span class="line"></span><br><span class="line"> // plic.c</span><br><span class="line"> void            plicinit(void);</span><br><span class="line"><span class="comment">diff --git a/kernel/exec.c b/kernel/exec.c</span></span><br><span class="line"><span class="comment">index 0e8762f..9ee3620 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/exec.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/exec.c</span></span><br><span class="line"><span class="meta">@@ -116,6 +116,8 @@</span> exec(char *path, char **argv)</span><br><span class="line">   p-&gt;trapframe-&gt;sp = sp; // initial stack pointer</span><br><span class="line">   proc_freepagetable(oldpagetable, oldsz);</span><br><span class="line"></span><br><span class="line"><span class="addition">+  if(p-&gt;pid == 1) vmprint(p-&gt;pagetable);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   return argc; // this ends up in a0, the first argument to main(argc, argv)</span><br><span class="line"></span><br><span class="line">  bad:</span><br><span class="line"><span class="comment">diff --git a/kernel/vm.c b/kernel/vm.c</span></span><br><span class="line"><span class="comment">index bccb405..59c4f2c 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/vm.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/vm.c</span></span><br><span class="line"><span class="meta">@@ -440,3 +440,29 @@</span> copyinstr(pagetable_t pagetable, char *dst, uint64 srcva, uint64 max)</span><br><span class="line">     return -1;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+void vmprint(pagetable_t pagetable) &#123;</span></span><br><span class="line"><span class="addition">+  printf(&quot;page table %p\n&quot;, pagetable);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  for(int i = 0; i &lt; 512; i++) &#123;</span></span><br><span class="line"><span class="addition">+    pte_t pte = pagetable[i];</span></span><br><span class="line"><span class="addition">+    if(pte &amp; PTE_V) &#123;</span></span><br><span class="line"><span class="addition">+      printf(&quot;..%d: pte %p pa %p\n&quot;, i, pte, PTE2PA(pte));</span></span><br><span class="line"><span class="addition">+      pagetable_t pagetable_l1 = (pagetable_t)PTE2PA(pte);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+      for(int j = 0; j&lt; 512; j++) &#123;</span></span><br><span class="line"><span class="addition">+        pte_t pte = pagetable_l1[j];</span></span><br><span class="line"><span class="addition">+        if(pte &amp; PTE_V) &#123;</span></span><br><span class="line"><span class="addition">+          printf(&quot;.. ..%d: pte %p pa %p\n&quot;, j, pte, PTE2PA(pte));</span></span><br><span class="line"><span class="addition">+          pagetable_t pagetable_l0 = (pagetable_t)PTE2PA(pte);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+          for(int k = 0; k &lt; 512; k++) &#123;</span></span><br><span class="line"><span class="addition">+            pte_t pte = pagetable_l0[k];</span></span><br><span class="line"><span class="addition">+            if(pte &amp; PTE_V)</span></span><br><span class="line"><span class="addition">+              printf(&quot;.. .. ..%d: pte %p pa %p\n&quot;, k, pte, PTE2PA(pte));</span></span><br><span class="line"><span class="addition">+          &#125;</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+      &#125;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-3-2-A-kernel-page-table-per-process-hard"><a href="#3-3-2-A-kernel-page-table-per-process-hard" class="headerlink" title="| 3.3.2 | A kernel page table per process (hard)"></a>| 3.3.2 | A kernel page table per process (hard)</h4><p>为什么每个进程都需要一个 kernel page table？</p>
<ul>
<li>user pagetable 使得用户态可以直接访问虚拟地址(由硬件来翻译)</li>
<li>但是当陷入内核态时，内核的页表没有用户态的虚拟地址，所以不能直接访问用户虚拟地址</li>
<li>为了访问用户虚拟地址，xv6 通过 <code>walk</code> 函数把来自用户态的虚拟地址转换成内核可操作的物理地址</li>
<li>当每个进程有自己的 kpagetable 的时候，把 <code>satp</code>设置成 kpagetable 就可以直接访问用户态虚拟地址了</li>
</ul>
<p>所以 <code>proc</code> 结构体在初始化时，多维护一个 <code>kpagetable</code>，首先 map kernel space，然后当用户 pagetable 更新时，同时更新 kpagetable；在切换进程时也需要切换 kpagetable。</p>
<p>需要注意的几点：</p>
<ul>
<li>每个进程在创建时都需要设置好 kpagetable，包含一下几点，分配 kpagetable 空间，映射 kernel space<ul>
<li>进程的创建在 <code>allocproc</code>，被 <code>userinit</code> 和 <code>fork</code> 调用</li>
</ul>
</li>
<li>每个 process 都有 kstack，在之前的版本，所有的 kstack 都被(<code>procinit</code>)映射到唯一一个 kernel pagetable。现在映射 kstack 需要在分配好 kpagetable 之后</li>
<li>这一节只需要保持 <code>kpagetable</code> 和全局变量<code>kernel_pagetable</code> 一致，所以还要再把 kstack 映射到全局 kernel pagetable，不用同步更新 kpagetable</li>
</ul>
<p>释放 kernel pagetable(参考 <code>proc_freepagetable</code>)</p>
<ul>
<li>清理叶子结点</li>
<li>调用 <code>freewalk</code> 释放 pagetable 占的物理页框</li>
</ul>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/kernel/defs.h b/kernel/defs.h</span></span><br><span class="line"><span class="comment">index ebc4cad..c1975c8 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/defs.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/defs.h</span></span><br><span class="line"><span class="meta">@@ -159,9 +159,11 @@</span> int             uartgetc(void);</span><br><span class="line"></span><br><span class="line"> // vm.c</span><br><span class="line"> void            kvminit(void);</span><br><span class="line"><span class="addition">+pagetable_t     kvm_pagetable(void);</span></span><br><span class="line"><span class="addition">+void            kvm_freepagetable(pagetable_t);</span></span><br><span class="line"> void            kvminithart(void);</span><br><span class="line"> uint64          kvmpa(uint64);</span><br><span class="line"><span class="deletion">-void            kvmmap(uint64, uint64, uint64, int);</span></span><br><span class="line"><span class="addition">+void            kvmmap(pagetable_t, uint64, uint64, uint64, int);</span></span><br><span class="line"> int             mappages(pagetable_t, uint64, uint64, uint64, int);</span><br><span class="line"> pagetable_t     uvmcreate(void);</span><br><span class="line"> void            uvminit(pagetable_t, uchar *, uint);</span><br><span class="line"><span class="comment">diff --git a/kernel/proc.c b/kernel/proc.c</span></span><br><span class="line"><span class="comment">index dab1e1d..3bc6bb8 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/proc.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/proc.c</span></span><br><span class="line"><span class="meta">@@ -20,6 +20,7 @@</span> static void wakeup1(struct proc *chan);</span><br><span class="line"> static void freeproc(struct proc *p);</span><br><span class="line"></span><br><span class="line"> extern char trampoline[]; // trampoline.S</span><br><span class="line"><span class="addition">+extern pagetable_t kernel_pagetable;  // vm.c</span></span><br><span class="line"></span><br><span class="line"> // initialize the proc table at boot time.</span><br><span class="line"> void</span><br><span class="line"><span class="meta">@@ -31,15 +32,6 @@</span> procinit(void)</span><br><span class="line">   for(p = proc; p &lt; &amp;proc[NPROC]; p++) &#123;</span><br><span class="line">       initlock(&amp;p-&gt;lock, &quot;proc&quot;);</span><br><span class="line"></span><br><span class="line"><span class="deletion">-      // Allocate a page for the process&#x27;s kernel stack.</span></span><br><span class="line"><span class="deletion">-      // Map it high in memory, followed by an invalid</span></span><br><span class="line"><span class="deletion">-      // guard page.</span></span><br><span class="line"><span class="deletion">-      char *pa = kalloc();</span></span><br><span class="line"><span class="deletion">-      if(pa == 0)</span></span><br><span class="line"><span class="deletion">-        panic(&quot;kalloc&quot;);</span></span><br><span class="line"><span class="deletion">-      uint64 va = KSTACK((int) (p - proc));</span></span><br><span class="line"><span class="deletion">-      kvmmap(va, (uint64)pa, PGSIZE, PTE_R | PTE_W);</span></span><br><span class="line"><span class="deletion">-      p-&gt;kstack = va;</span></span><br><span class="line">   &#125;</span><br><span class="line">   kvminithart();</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta">@@ -93,6 +85,7 @@</span> static struct proc*</span><br><span class="line"> allocproc(void)</span><br><span class="line"> &#123;</span><br><span class="line">   struct proc *p;</span><br><span class="line"><span class="addition">+  char *pa;</span></span><br><span class="line"></span><br><span class="line">   for(p = proc; p &lt; &amp;proc[NPROC]; p++) &#123;</span><br><span class="line">     acquire(&amp;p-&gt;lock);</span><br><span class="line"><span class="meta">@@ -105,6 +98,17 @@</span> allocproc(void)</span><br><span class="line">   return 0;</span><br><span class="line"></span><br><span class="line"> found:</span><br><span class="line"><span class="addition">+  p-&gt;kpagetable = kvm_pagetable();</span></span><br><span class="line"><span class="addition">+  // Allocate a page for the process&#x27;s kernel stack.</span></span><br><span class="line"><span class="addition">+  // Map it high in memory, followed by an invalid</span></span><br><span class="line"><span class="addition">+  // guard page.</span></span><br><span class="line"><span class="addition">+  pa = kalloc();</span></span><br><span class="line"><span class="addition">+  if(pa == 0)</span></span><br><span class="line"><span class="addition">+    panic(&quot;kalloc&quot;);</span></span><br><span class="line"><span class="addition">+  uint64 va = KSTACK((int) (p - proc));</span></span><br><span class="line"><span class="addition">+  kvmmap(p-&gt;kpagetable, va, (uint64)pa, PGSIZE, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  kvmmap(kernel_pagetable, va, (uint64)pa, PGSIZE, PTE_R | PTE_W);  // to make two kernel pagetable identical</span></span><br><span class="line"><span class="addition">+  p-&gt;kstack = va;</span></span><br><span class="line">   p-&gt;pid = allocpid();</span><br><span class="line"></span><br><span class="line">   // Allocate a trapframe page.</span><br><span class="line"><span class="meta">@@ -141,6 +145,14 @@</span> freeproc(struct proc *p)</span><br><span class="line">   p-&gt;trapframe = 0;</span><br><span class="line">   if(p-&gt;pagetable)</span><br><span class="line">     proc_freepagetable(p-&gt;pagetable, p-&gt;sz);</span><br><span class="line"><span class="addition">+  if(p-&gt;kstack) &#123;</span></span><br><span class="line"><span class="addition">+    uvmunmap(p-&gt;kpagetable, p-&gt;kstack, PGSIZE/PGSIZE, 0);</span></span><br><span class="line"><span class="addition">+    uvmunmap(kernel_pagetable, p-&gt;kstack, PGSIZE/PGSIZE, 1);</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+  if(p-&gt;kpagetable)</span></span><br><span class="line"><span class="addition">+    kvm_freepagetable(p-&gt;kpagetable);</span></span><br><span class="line"><span class="addition">+  p-&gt;kpagetable = 0;</span></span><br><span class="line"><span class="addition">+  p-&gt;kstack = 0;</span></span><br><span class="line">   p-&gt;pagetable = 0;</span><br><span class="line">   p-&gt;sz = 0;</span><br><span class="line">   p-&gt;pid = 0;</span><br><span class="line"><span class="meta">@@ -473,11 +485,16 @@</span> scheduler(void)</span><br><span class="line">         // before jumping back to us.</span><br><span class="line">         p-&gt;state = RUNNING;</span><br><span class="line">         c-&gt;proc = p;</span><br><span class="line"><span class="addition">+        w_satp(MAKE_SATP(p-&gt;kpagetable));</span></span><br><span class="line"><span class="addition">+        sfence_vma();</span></span><br><span class="line">         swtch(&amp;c-&gt;context, &amp;p-&gt;context);</span><br><span class="line"></span><br><span class="line">         // Process is done running for now.</span><br><span class="line">         // It should have changed its p-&gt;state before coming back.</span><br><span class="line">         c-&gt;proc = 0;</span><br><span class="line"><span class="addition">+        // to satisfy &quot;scheduler() should use kernel_pagetable when no process is running.&quot;</span></span><br><span class="line"><span class="addition">+        w_satp(MAKE_SATP(kernel_pagetable));</span></span><br><span class="line"><span class="addition">+        sfence_vma();</span></span><br><span class="line"></span><br><span class="line">         found = 1;</span><br><span class="line">       &#125;</span><br><span class="line"><span class="comment">diff --git a/kernel/proc.h b/kernel/proc.h</span></span><br><span class="line"><span class="comment">index 9c16ea7..73b72a6 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/proc.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/proc.h</span></span><br><span class="line"><span class="meta">@@ -103,4 +103,5 @@</span> struct proc &#123;</span><br><span class="line">   struct file *ofile[NOFILE];  // Open files</span><br><span class="line">   struct inode *cwd;           // Current directory</span><br><span class="line">   char name[16];               // Process name (debugging)</span><br><span class="line"><span class="addition">+  pagetable_t kpagetable;</span></span><br><span class="line"> &#125;;</span><br><span class="line"><span class="comment">diff --git a/kernel/vm.c b/kernel/vm.c</span></span><br><span class="line"><span class="comment">index 59c4f2c..6682ab3 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/vm.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/vm.c</span></span><br><span class="line"><span class="meta">@@ -25,26 +25,40 @@</span> kvminit()</span><br><span class="line">   memset(kernel_pagetable, 0, PGSIZE);</span><br><span class="line"></span><br><span class="line">   // uart registers</span><br><span class="line"><span class="deletion">-  kvmmap(UART0, UART0, PGSIZE, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  kvmmap(kernel_pagetable, UART0, UART0, PGSIZE, PTE_R | PTE_W);</span></span><br><span class="line"></span><br><span class="line">   // virtio mmio disk interface</span><br><span class="line"><span class="deletion">-  kvmmap(VIRTIO0, VIRTIO0, PGSIZE, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  kvmmap(kernel_pagetable, VIRTIO0, VIRTIO0, PGSIZE, PTE_R | PTE_W);</span></span><br><span class="line"></span><br><span class="line">   // CLINT</span><br><span class="line"><span class="deletion">-  kvmmap(CLINT, CLINT, 0x10000, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  kvmmap(kernel_pagetable, CLINT, CLINT, 0x10000, PTE_R | PTE_W);</span></span><br><span class="line"></span><br><span class="line">   // PLIC</span><br><span class="line"><span class="deletion">-  kvmmap(PLIC, PLIC, 0x400000, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  kvmmap(kernel_pagetable, PLIC, PLIC, 0x400000, PTE_R | PTE_W);</span></span><br><span class="line"></span><br><span class="line">   // map kernel text executable and read-only.</span><br><span class="line"><span class="deletion">-  kvmmap(KERNBASE, KERNBASE, (uint64)etext-KERNBASE, PTE_R | PTE_X);</span></span><br><span class="line"><span class="addition">+  kvmmap(kernel_pagetable, KERNBASE, KERNBASE, (uint64)etext-KERNBASE, PTE_R | PTE_X);</span></span><br><span class="line"></span><br><span class="line">   // map kernel data and the physical RAM we&#x27;ll make use of.</span><br><span class="line"><span class="deletion">-  kvmmap((uint64)etext, (uint64)etext, PHYSTOP-(uint64)etext, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  kvmmap(kernel_pagetable, (uint64)etext, (uint64)etext, PHYSTOP-(uint64)etext, PTE_R | PTE_W);</span></span><br><span class="line"></span><br><span class="line">   // map the trampoline for trap entry/exit to</span><br><span class="line">   // the highest virtual address in the kernel.</span><br><span class="line"><span class="deletion">-  kvmmap(TRAMPOLINE, (uint64)trampoline, PGSIZE, PTE_R | PTE_X);</span></span><br><span class="line"><span class="addition">+  kvmmap(kernel_pagetable, TRAMPOLINE, (uint64)trampoline, PGSIZE, PTE_R | PTE_X);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+// create kpagetable for each process, identical to kernel_pagetable</span></span><br><span class="line"><span class="addition">+pagetable_t kvm_pagetable() &#123;</span></span><br><span class="line"><span class="addition">+  pagetable_t kpagetable = (pagetable_t) kalloc();</span></span><br><span class="line"><span class="addition">+  memset(kpagetable, 0, PGSIZE);</span></span><br><span class="line"><span class="addition">+  kvmmap(kpagetable, UART0, UART0, PGSIZE, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  kvmmap(kpagetable, VIRTIO0, VIRTIO0, PGSIZE, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  kvmmap(kpagetable, CLINT, CLINT, 0x10000, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  kvmmap(kpagetable, PLIC, PLIC, 0x400000, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  kvmmap(kpagetable, KERNBASE, KERNBASE, (uint64)etext-KERNBASE, PTE_R | PTE_X);</span></span><br><span class="line"><span class="addition">+  kvmmap(kpagetable, (uint64)etext, (uint64)etext, PHYSTOP-(uint64)etext, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  kvmmap(kpagetable, TRAMPOLINE, (uint64)trampoline, PGSIZE, PTE_R | PTE_X);</span></span><br><span class="line"><span class="addition">+  return kpagetable;</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> // Switch h/w page table register to the kernel&#x27;s page table,</span><br><span class="line"><span class="meta">@@ -115,9 +129,9 @@</span> walkaddr(pagetable_t pagetable, uint64 va)</span><br><span class="line"> // only used when booting.</span><br><span class="line"> // does not flush TLB or enable paging.</span><br><span class="line"> void</span><br><span class="line"><span class="deletion">-kvmmap(uint64 va, uint64 pa, uint64 sz, int perm)</span></span><br><span class="line"><span class="addition">+kvmmap(pagetable_t pagetable, uint64 va, uint64 pa, uint64 sz, int perm)</span></span><br><span class="line"> &#123;</span><br><span class="line"><span class="deletion">-  if(mappages(kernel_pagetable, va, sz, pa, perm) != 0)</span></span><br><span class="line"><span class="addition">+  if(mappages(pagetable, va, sz, pa, perm) != 0)</span></span><br><span class="line">     panic(&quot;kvmmap&quot;);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@@ -299,6 +313,28 @@</span> uvmfree(pagetable_t pagetable, uint64 sz)</span><br><span class="line">   freewalk(pagetable);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="addition">+// free kpagetable</span></span><br><span class="line"><span class="addition">+// assumming kstack is unmaped and freed</span></span><br><span class="line"><span class="addition">+void kvm_freepagetable(pagetable_t pagetable) &#123;</span></span><br><span class="line"><span class="addition">+  // unmap leaves</span></span><br><span class="line"><span class="addition">+  uint64 page_size;</span></span><br><span class="line"><span class="addition">+  uvmunmap(pagetable, UART0, PGSIZE/PGSIZE, 0);</span></span><br><span class="line"><span class="addition">+  uvmunmap(pagetable, VIRTIO0, PGSIZE/PGSIZE, 0);</span></span><br><span class="line"><span class="addition">+  uvmunmap(pagetable, CLINT, 0x10000/PGSIZE, 0);</span></span><br><span class="line"><span class="addition">+  uvmunmap(pagetable, PLIC, 0x400000/PGSIZE, 0);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  page_size = PGROUNDUP((uint64)etext - KERNBASE);</span></span><br><span class="line"><span class="addition">+  uvmunmap(pagetable, KERNBASE, page_size/PGSIZE, 0);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  page_size = PGROUNDUP(PHYSTOP-(uint64)etext);</span></span><br><span class="line"><span class="addition">+  uvmunmap(pagetable, (uint64)etext, page_size/PGSIZE, 0);</span></span><br><span class="line"><span class="addition">+  uvmunmap(pagetable, TRAMPOLINE, PGSIZE/PGSIZE, 0);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  // free pagetable</span></span><br><span class="line"><span class="addition">+  freewalk(pagetable);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> // Given a parent process&#x27;s page table, copy</span><br></pre></td></tr></table></figure>

<h4 id="3-3-3-Simplify-copyin-copyinstr-hard"><a href="#3-3-3-Simplify-copyin-copyinstr-hard" class="headerlink" title="| 3.3.3 | Simplify copyin/copyinstr (hard)"></a>| 3.3.3 | Simplify <code>copyin/copyinstr</code> (hard)</h4><p>为了防止 userspace 和 kernel space 重叠所以需要限制 user space 上限是0xC000000。为了 kpagetable 能访问用户态虚拟地址，需要保持 kpagetable 和 user pagetable 在 userspace 的一致。之前的 <code>kernel_pagetable</code> 映射了 <code>CLINT</code>(0x2000000)，如果限制 <code>MAXUVA</code> 是 <code>CLINT</code> 的话通过不了 <code>usertests sbrkmuch</code> 所以可以不用映射 <code>CLINT</code> 。</p>
<p>user pagetable 的创建&#x2F;更新过程如下：</p>
<ul>
<li><code>proc_pagetable()</code><ul>
<li>调用 <code>uvmcreate()</code> 获得一个物理页框，</li>
<li>然后 <code>mappages()</code> 映射 <code>trampoline</code> 以及 <code>trapframe</code></li>
</ul>
</li>
<li><code>fork()</code><ul>
<li>先调用 <code>allocproc()</code> 获得一个基本的 user pagetable</li>
<li>然后复制父进程的 pagetable 即可</li>
</ul>
</li>
<li><code>userint()</code><ul>
<li>同样是 <code>allocproc()</code> 起手</li>
<li>然后调用 <code>uvminit</code> 把 initcode 映射到 <code>va=0</code> 的位置</li>
</ul>
</li>
<li><code>exec()</code> 见 <a href="#3-1-4-Code-exec">| 3.1.4 |</a></li>
<li><code>sbrk()</code><ul>
<li><code>growproc()</code> 根据传入参数正负调用<code>uvmalloc/uvmdealloc</code></li>
<li><code>uvmalloc()</code> 从原来的虚拟地址往上分配页</li>
<li><code>uvmdealloc()</code> 从原来的虚拟地址往下减少页</li>
</ul>
</li>
</ul>
<p>kpagetable 应该<strong>只建立相同映射</strong>，<strong>不再分配和释放物理帧</strong>。</p>
<p>user pagetable 释放过程:</p>
<ul>
<li><code>freeproc()</code> 在 <code>proc_freepagetable()</code> 的时候也要对 kpagetable 同样操作</li>
<li><code>exec()</code> 会释放原来的 user pagetable</li>
<li>因为有 <code>kstack</code>, <code>kpagetable</code> 应随着进程的创建释放而创建释放</li>
</ul>
<p>注意：</p>
<ul>
<li><p>限制 user space 地址空间不超过 0xC000000</p>
<ul>
<li><p><code>p-&gt;sz</code> 是当前进程占用内存大小，限制它即可</p>
</li>
<li><p>写 <code>p-&gt;sz</code> 的地方只有两处是用变量赋值的分别是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exec.c:<span class="number">114</span>:<span class="number">3</span>:  p-&gt;sz = sz;</span><br><span class="line">proc.c:<span class="number">264</span>:<span class="number">3</span>:  p-&gt;sz = sz;  <span class="comment">// growproc</span></span><br></pre></td></tr></table></figure>

<p>这两个 <code>sz</code> 都是 <code>uvmalloc()</code> 的返回值，所以在这里限制就可以</p>
</li>
</ul>
</li>
<li><p>当 <code>exec</code> go bad 的时候，<code>kpagetable</code> 必须和刚开始一样</p>
</li>
</ul>
<p><del>梳理完 user pagetable 机制之后终于是清晰了很多，但是 debug 还是痛苦且漫长。做出来之后还是很有成就感(笑)</del></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/kernel/defs.h b/kernel/defs.h</span></span><br><span class="line"><span class="comment">index c1975c8..c9daf08 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/defs.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/defs.h</span></span><br><span class="line"><span class="meta">@@ -92,6 +92,8 @@</span> int             fork(void);</span><br><span class="line"> int             growproc(int);</span><br><span class="line"> pagetable_t     proc_pagetable(struct proc *);</span><br><span class="line"> void            proc_freepagetable(pagetable_t, uint64);</span><br><span class="line"><span class="addition">+void            proc_kpagetable_trapframe(struct proc *);</span></span><br><span class="line"><span class="addition">+void            proc_clear_kpagetable(pagetable_t, uint64);</span></span><br><span class="line"> int             kill(int);</span><br><span class="line"> struct cpu*     mycpu(void);</span><br><span class="line"> struct cpu*     getmycpu(void);</span><br><span class="line"><span class="meta">@@ -166,12 +168,12 @@</span> uint64          kvmpa(uint64);</span><br><span class="line"> void            kvmmap(pagetable_t, uint64, uint64, uint64, int);</span><br><span class="line"> int             mappages(pagetable_t, uint64, uint64, uint64, int);</span><br><span class="line"> pagetable_t     uvmcreate(void);</span><br><span class="line"><span class="deletion">-void            uvminit(pagetable_t, uchar *, uint);</span></span><br><span class="line"><span class="deletion">-uint64          uvmalloc(pagetable_t, uint64, uint64);</span></span><br><span class="line"><span class="deletion">-uint64          uvmdealloc(pagetable_t, uint64, uint64);</span></span><br><span class="line"><span class="addition">+void            uvminit(pagetable_t, pagetable_t, uchar *, uint);</span></span><br><span class="line"><span class="addition">+uint64          uvmalloc(pagetable_t, pagetable_t, uint64, uint64);</span></span><br><span class="line"><span class="addition">+uint64          uvmdealloc(pagetable_t, uint64, uint64, int);</span></span><br><span class="line"> #ifdef SOL_COW</span><br><span class="line"> #else</span><br><span class="line"><span class="deletion">-int             uvmcopy(pagetable_t, pagetable_t, uint64);</span></span><br><span class="line"><span class="addition">+int             uvmcopy(pagetable_t, pagetable_t, pagetable_t, uint64);</span></span><br><span class="line"> #endif</span><br><span class="line"> void            uvmfree(pagetable_t, uint64);</span><br><span class="line"> void            uvmunmap(pagetable_t, uint64, uint64, int);</span><br><span class="line"><span class="meta">@@ -181,6 +183,7 @@</span> int             copyout(pagetable_t, uint64, char *, uint64);</span><br><span class="line"> int             copyin(pagetable_t, char *, uint64, uint64);</span><br><span class="line"> int             copyinstr(pagetable_t, char *, uint64, uint64);</span><br><span class="line"> void            vmprint(pagetable_t);</span><br><span class="line"><span class="addition">+pte_t *         walk(pagetable_t , uint64 , int);</span></span><br><span class="line"></span><br><span class="line"> // plic.c</span><br><span class="line"> void            plicinit(void);</span><br><span class="line"><span class="meta">@@ -193,6 +196,9 @@</span> void            virtio_disk_init(void);</span><br><span class="line"> void            virtio_disk_rw(struct buf *, int);</span><br><span class="line"> void            virtio_disk_intr(void);</span><br><span class="line"></span><br><span class="line"><span class="addition">+// vmcopyin.c</span></span><br><span class="line"><span class="addition">+int             copyin_new(pagetable_t, char *, uint64, uint64);</span></span><br><span class="line"><span class="addition">+int             copyinstr_new(pagetable_t, char *, uint64, uint64);</span></span><br><span class="line"> // number of elements in fixed-size array</span><br><span class="line"> #define NELEM(x) (sizeof(x)/sizeof((x)[0]))</span><br><span class="line"></span><br><span class="line"><span class="comment">diff --git a/kernel/exec.c b/kernel/exec.c</span></span><br><span class="line"><span class="comment">index 9ee3620..9682ef8 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/exec.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/exec.c</span></span><br><span class="line"><span class="meta">@@ -38,6 +38,8 @@</span> exec(char *path, char **argv)</span><br><span class="line">   if((pagetable = proc_pagetable(p)) == 0)</span><br><span class="line">     goto bad;</span><br><span class="line"></span><br><span class="line"><span class="addition">+  uvmunmap(p-&gt;kpagetable, 0, PGROUNDUP(p-&gt;sz)/PGSIZE, 0);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   // Load program into memory.</span><br><span class="line">   for(i=0, off=elf.phoff; i&lt;elf.phnum; i++, off+=sizeof(ph))&#123;</span><br><span class="line">     if(readi(ip, 0, (uint64)&amp;ph, off, sizeof(ph)) != sizeof(ph))</span><br><span class="line"><span class="meta">@@ -49,7 +51,7 @@</span> exec(char *path, char **argv)</span><br><span class="line">     if(ph.vaddr + ph.memsz &lt; ph.vaddr)</span><br><span class="line">       goto bad;</span><br><span class="line">     uint64 sz1;</span><br><span class="line"><span class="deletion">-    if((sz1 = uvmalloc(pagetable, sz, ph.vaddr + ph.memsz)) == 0)</span></span><br><span class="line"><span class="addition">+    if((sz1 = uvmalloc(pagetable, p-&gt;kpagetable, sz, ph.vaddr + ph.memsz)) == 0)</span></span><br><span class="line">       goto bad;</span><br><span class="line">     sz = sz1;</span><br><span class="line">     if(ph.vaddr % PGSIZE != 0)</span><br><span class="line"><span class="meta">@@ -68,7 +70,7 @@</span> exec(char *path, char **argv)</span><br><span class="line">   // Use the second as the user stack.</span><br><span class="line">   sz = PGROUNDUP(sz);</span><br><span class="line">   uint64 sz1;</span><br><span class="line"><span class="deletion">-  if((sz1 = uvmalloc(pagetable, sz, sz + 2*PGSIZE)) == 0)</span></span><br><span class="line"><span class="addition">+  if((sz1 = uvmalloc(pagetable, p-&gt;kpagetable, sz, sz + 2*PGSIZE)) == 0)</span></span><br><span class="line">     goto bad;</span><br><span class="line">   sz = sz1;</span><br><span class="line">   uvmclear(pagetable, sz-2*PGSIZE);</span><br><span class="line"><span class="meta">@@ -121,8 +123,23 @@</span> exec(char *path, char **argv)</span><br><span class="line">   return argc; // this ends up in a0, the first argument to main(argc, argv)</span><br><span class="line"></span><br><span class="line">  bad:</span><br><span class="line"><span class="deletion">-  if(pagetable)</span></span><br><span class="line"><span class="addition">+  if(pagetable) &#123;</span></span><br><span class="line">     proc_freepagetable(pagetable, sz);</span><br><span class="line"><span class="addition">+    uvmunmap(p-&gt;kpagetable, 0, PGROUNDUP(sz)/PGSIZE, 0);  // doing the same when dealing with pagetable</span></span><br><span class="line"><span class="addition">+    // recover userpart of kpagetable</span></span><br><span class="line"><span class="addition">+    pte_t *pte;</span></span><br><span class="line"><span class="addition">+    uint64 pa, i;</span></span><br><span class="line"><span class="addition">+    uint flags;</span></span><br><span class="line"><span class="addition">+    for(i = 0; i &lt; p-&gt;sz; i += PGSIZE)&#123;</span></span><br><span class="line"><span class="addition">+      if((pte = walk(p-&gt;pagetable, i, 0)) == 0)</span></span><br><span class="line"><span class="addition">+        panic(&quot;exec: pte should exist&quot;);</span></span><br><span class="line"><span class="addition">+      if((*pte &amp; PTE_V) == 0)</span></span><br><span class="line"><span class="addition">+        panic(&quot;exec: page not present&quot;);</span></span><br><span class="line"><span class="addition">+      pa = PTE2PA(*pte);</span></span><br><span class="line"><span class="addition">+      flags = PTE_FLAGS(*pte);</span></span><br><span class="line"><span class="addition">+      mappages(p-&gt;kpagetable, i, PGSIZE, (uint64)pa, (flags&amp;(~PTE_U)) );</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line">   if(ip)&#123;</span><br><span class="line">     iunlockput(ip);</span><br><span class="line">     end_op();</span><br><span class="line"><span class="comment">diff --git a/kernel/memlayout.h b/kernel/memlayout.h</span></span><br><span class="line"><span class="comment">index b6e595d..a6d7314 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/memlayout.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/memlayout.h</span></span><br><span class="line"><span class="meta">@@ -65,3 +65,4 @@</span></span><br><span class="line"> //   TRAPFRAME (p-&gt;trapframe, used by the trampoline)</span><br><span class="line"> //   TRAMPOLINE (the same page as in the kernel)</span><br><span class="line"> #define TRAPFRAME (TRAMPOLINE - PGSIZE)</span><br><span class="line"><span class="addition">+#define MAXUVA 0x0c000000L</span></span><br><span class="line"><span class="comment">diff --git a/kernel/proc.c b/kernel/proc.c</span></span><br><span class="line"><span class="comment">index 3bc6bb8..095807f 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/proc.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/proc.c</span></span><br><span class="line"><span class="meta">@@ -124,6 +124,7 @@</span> found:</span><br><span class="line">     release(&amp;p-&gt;lock);</span><br><span class="line">     return 0;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="addition">+  proc_kpagetable_trapframe(p);</span></span><br><span class="line"></span><br><span class="line">   // Set up new context to start executing at forkret,</span><br><span class="line">   // which returns to user space.</span><br><span class="line"><span class="meta">@@ -143,6 +144,8 @@</span> freeproc(struct proc *p)</span><br><span class="line">   if(p-&gt;trapframe)</span><br><span class="line">     kfree((void*)p-&gt;trapframe);</span><br><span class="line">   p-&gt;trapframe = 0;</span><br><span class="line"><span class="addition">+  if(p-&gt;kpagetable)</span></span><br><span class="line"><span class="addition">+    proc_clear_kpagetable(p-&gt;kpagetable, p-&gt;sz);</span></span><br><span class="line">   if(p-&gt;pagetable)</span><br><span class="line">     proc_freepagetable(p-&gt;pagetable, p-&gt;sz);</span><br><span class="line">   if(p-&gt;kstack) &#123;</span><br><span class="line"><span class="meta">@@ -207,6 +210,23 @@</span> proc_freepagetable(pagetable_t pagetable, uint64 sz)</span><br><span class="line">   uvmfree(pagetable, sz);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="addition">+// map current proc-&gt;&gt;trapframe to kpagetable</span></span><br><span class="line"><span class="addition">+void proc_kpagetable_trapframe(struct proc *p)&#123;</span></span><br><span class="line"><span class="addition">+  // map the trapframe just below TRAMPOLINE, for trampoline.S.</span></span><br><span class="line"><span class="addition">+  if(mappages(p-&gt;kpagetable, TRAPFRAME, PGSIZE, (uint64)(p-&gt;trapframe), PTE_R | PTE_W) &lt; 0)</span></span><br><span class="line"><span class="addition">+    panic(&quot;proc_kpagetable_trapframe&quot;);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+// clear user space and trapframe</span></span><br><span class="line"><span class="addition">+// not free kpagetable</span></span><br><span class="line"><span class="addition">+// better be called before proc_freepagetable？not sure</span></span><br><span class="line"><span class="addition">+void proc_clear_kpagetable(pagetable_t kpagetable, uint64 sz) &#123;</span></span><br><span class="line"><span class="addition">+  uvmunmap(kpagetable, TRAPFRAME, 1, 0);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  if(sz &gt; 0)</span></span><br><span class="line"><span class="addition">+    uvmunmap(kpagetable, 0, PGROUNDUP(sz)/PGSIZE, 0);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> // a user program that calls exec(&quot;/init&quot;)</span><br><span class="line"> // od -t xC initcode</span><br><span class="line"> uchar initcode[] = &#123;</span><br><span class="line"><span class="meta">@@ -230,7 +250,8 @@</span> userinit(void)</span><br><span class="line"></span><br><span class="line">   // allocate one user page and copy init&#x27;s instructions</span><br><span class="line">   // and data into it.</span><br><span class="line"><span class="deletion">-  uvminit(p-&gt;pagetable, initcode, sizeof(initcode));</span></span><br><span class="line"><span class="addition">+  // and map to kpagetable</span></span><br><span class="line"><span class="addition">+  uvminit(p-&gt;pagetable, p-&gt;kpagetable, initcode, sizeof(initcode));</span></span><br><span class="line">   p-&gt;sz = PGSIZE;</span><br><span class="line"></span><br><span class="line">   // prepare for the very first &quot;return&quot; from kernel to user.</span><br><span class="line"><span class="meta">@@ -255,11 +276,12 @@</span> growproc(int n)</span><br><span class="line"></span><br><span class="line">   sz = p-&gt;sz;</span><br><span class="line">   if(n &gt; 0)&#123;</span><br><span class="line"><span class="deletion">-    if((sz = uvmalloc(p-&gt;pagetable, sz, sz + n)) == 0) &#123;</span></span><br><span class="line"><span class="addition">+    if((sz = uvmalloc(p-&gt;pagetable, p-&gt;kpagetable, sz, sz + n)) == 0) &#123;</span></span><br><span class="line">       return -1;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125; else if(n &lt; 0)&#123;</span><br><span class="line"><span class="deletion">-    sz = uvmdealloc(p-&gt;pagetable, sz, sz + n);</span></span><br><span class="line"><span class="addition">+    uvmdealloc(p-&gt;kpagetable, sz, sz + n, 0);  // 在这卡了半天，这里不能修改 sz 的值，因为下一行还要继续用</span></span><br><span class="line"><span class="addition">+    sz = uvmdealloc(p-&gt;pagetable, sz, sz + n, 1);</span></span><br><span class="line">   &#125;</span><br><span class="line">   p-&gt;sz = sz;</span><br><span class="line">   return 0;</span><br><span class="line"><span class="meta">@@ -280,7 +302,7 @@</span> fork(void)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   // Copy user memory from parent to child.</span><br><span class="line"><span class="deletion">-  if(uvmcopy(p-&gt;pagetable, np-&gt;pagetable, p-&gt;sz) &lt; 0)&#123;</span></span><br><span class="line"><span class="addition">+  if(uvmcopy(p-&gt;pagetable, np-&gt;pagetable, np-&gt;kpagetable, p-&gt;sz) &lt; 0)&#123;</span></span><br><span class="line">     freeproc(np);</span><br><span class="line">     release(&amp;np-&gt;lock);</span><br><span class="line">     return -1;</span><br><span class="line"><span class="comment">diff --git a/kernel/vm.c b/kernel/vm.c</span></span><br><span class="line"><span class="comment">index 62c2cb9..5c98e8d 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/vm.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/vm.c</span></span><br><span class="line"><span class="meta">@@ -31,7 +31,7 @@</span> kvminit()</span><br><span class="line">   kvmmap(kernel_pagetable, VIRTIO0, VIRTIO0, PGSIZE, PTE_R | PTE_W);</span><br><span class="line"></span><br><span class="line">   // CLINT</span><br><span class="line"><span class="deletion">-  kvmmap(kernel_pagetable, CLINT, CLINT, 0x10000, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  //kvmmap(kernel_pagetable, CLINT, CLINT, 0x10000, PTE_R | PTE_W);</span></span><br><span class="line"></span><br><span class="line">   // PLIC</span><br><span class="line">   kvmmap(kernel_pagetable, PLIC, PLIC, 0x400000, PTE_R | PTE_W);</span><br><span class="line"><span class="meta">@@ -53,7 +53,7 @@</span> pagetable_t kvm_pagetable() &#123;</span><br><span class="line">   memset(kpagetable, 0, PGSIZE);</span><br><span class="line">   kvmmap(kpagetable, UART0, UART0, PGSIZE, PTE_R | PTE_W);</span><br><span class="line">   kvmmap(kpagetable, VIRTIO0, VIRTIO0, PGSIZE, PTE_R | PTE_W);</span><br><span class="line"><span class="deletion">-  kvmmap(kpagetable, CLINT, CLINT, 0x10000, PTE_R | PTE_W);</span></span><br><span class="line"><span class="addition">+  //kvmmap(kpagetable, CLINT, CLINT, 0x10000, PTE_R | PTE_W);</span></span><br><span class="line">   kvmmap(kpagetable, PLIC, PLIC, 0x400000, PTE_R | PTE_W);</span><br><span class="line">   kvmmap(kpagetable, KERNBASE, KERNBASE, (uint64)etext-KERNBASE, PTE_R | PTE_X);</span><br><span class="line">   kvmmap(kpagetable, (uint64)etext, (uint64)etext, PHYSTOP-(uint64)etext, PTE_R | PTE_W);</span><br><span class="line"><span class="meta">@@ -225,7 +225,7 @@</span> uvmcreate()</span><br><span class="line"> // for the very first process.</span><br><span class="line"> // sz must be less than a page.</span><br><span class="line"> void</span><br><span class="line"><span class="deletion">-uvminit(pagetable_t pagetable, uchar *src, uint sz)</span></span><br><span class="line"><span class="addition">+uvminit(pagetable_t pagetable, pagetable_t kpagetable, uchar *src, uint sz)</span></span><br><span class="line"> &#123;</span><br><span class="line">   char *mem;</span><br><span class="line"></span><br><span class="line"><span class="meta">@@ -234,31 +234,42 @@</span> uvminit(pagetable_t pagetable, uchar *src, uint sz)</span><br><span class="line">   mem = kalloc();</span><br><span class="line">   memset(mem, 0, PGSIZE);</span><br><span class="line">   mappages(pagetable, 0, PGSIZE, (uint64)mem, PTE_W|PTE_R|PTE_X|PTE_U);</span><br><span class="line"><span class="addition">+  mappages(kpagetable, 0, PGSIZE, (uint64)mem, PTE_W|PTE_R|PTE_X);</span></span><br><span class="line">   memmove(mem, src, sz);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> // Allocate PTEs and physical memory to grow process from oldsz to</span><br><span class="line"> // newsz, which need not be page aligned.  Returns new size or 0 on error.</span><br><span class="line"> uint64</span><br><span class="line"><span class="deletion">-uvmalloc(pagetable_t pagetable, uint64 oldsz, uint64 newsz)</span></span><br><span class="line"><span class="addition">+uvmalloc(pagetable_t pagetable, pagetable_t kpagetable, uint64 oldsz, uint64 newsz)</span></span><br><span class="line"> &#123;</span><br><span class="line">   char *mem;</span><br><span class="line">   uint64 a;</span><br><span class="line"></span><br><span class="line">   if(newsz &lt; oldsz)</span><br><span class="line">     return oldsz;</span><br><span class="line"><span class="addition">+  if(PGROUNDUP(newsz) &gt;= MAXUVA)</span></span><br><span class="line"><span class="addition">+    return 0;</span></span><br><span class="line"></span><br><span class="line">   oldsz = PGROUNDUP(oldsz);</span><br><span class="line">   for(a = oldsz; a &lt; newsz; a += PGSIZE)&#123;</span><br><span class="line">     mem = kalloc();</span><br><span class="line">     if(mem == 0)&#123;</span><br><span class="line"><span class="deletion">-      uvmdealloc(pagetable, a, oldsz);</span></span><br><span class="line"><span class="addition">+      uvmdealloc(kpagetable, a, oldsz, 0);</span></span><br><span class="line"><span class="addition">+      uvmdealloc(pagetable, a, oldsz, 1);</span></span><br><span class="line">       return 0;</span><br><span class="line">     &#125;</span><br><span class="line">     memset(mem, 0, PGSIZE);</span><br><span class="line">     if(mappages(pagetable, a, PGSIZE, (uint64)mem, PTE_W|PTE_X|PTE_R|PTE_U) != 0)&#123;</span><br><span class="line">       kfree(mem);</span><br><span class="line"><span class="deletion">-      uvmdealloc(pagetable, a, oldsz);</span></span><br><span class="line"><span class="addition">+      uvmdealloc(kpagetable, a, oldsz, 0);</span></span><br><span class="line"><span class="addition">+      uvmdealloc(pagetable, a, oldsz, 1);</span></span><br><span class="line"><span class="addition">+      return 0;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    if(mappages(kpagetable, a, PGSIZE, (uint64)mem, PTE_W|PTE_X|PTE_R) != 0)&#123;</span></span><br><span class="line"><span class="addition">+      kfree(mem);</span></span><br><span class="line"><span class="addition">+      uvmdealloc(kpagetable, a, oldsz, 0);</span></span><br><span class="line"><span class="addition">+      uvmdealloc(pagetable, a, oldsz, 1);</span></span><br><span class="line">       return 0;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">@@ -270,14 +281,14 @@</span> uvmalloc(pagetable_t pagetable, uint64 oldsz, uint64 newsz)</span><br><span class="line"> // need to be less than oldsz.  oldsz can be larger than the actual</span><br><span class="line"> // process size.  Returns the new process size.</span><br><span class="line"> uint64</span><br><span class="line"><span class="deletion">-uvmdealloc(pagetable_t pagetable, uint64 oldsz, uint64 newsz)</span></span><br><span class="line"><span class="addition">+uvmdealloc(pagetable_t pagetable, uint64 oldsz, uint64 newsz, int do_free)</span></span><br><span class="line"> &#123;</span><br><span class="line">   if(newsz &gt;= oldsz)</span><br><span class="line">     return oldsz;</span><br><span class="line"></span><br><span class="line">   if(PGROUNDUP(newsz) &lt; PGROUNDUP(oldsz))&#123;</span><br><span class="line">     int npages = (PGROUNDUP(oldsz) - PGROUNDUP(newsz)) / PGSIZE;</span><br><span class="line"><span class="deletion">-    uvmunmap(pagetable, PGROUNDUP(newsz), npages, 1);</span></span><br><span class="line"><span class="addition">+    uvmunmap(pagetable, PGROUNDUP(newsz), npages, do_free);</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   return newsz;</span><br><span class="line"><span class="meta">@@ -289,6 +300,7 @@</span> void</span><br><span class="line"> freewalk(pagetable_t pagetable)</span><br><span class="line"> &#123;</span><br><span class="line">   // there are 2^9 = 512 PTEs in a page table.</span><br><span class="line"><span class="addition">+  //vmprint(pagetable);</span></span><br><span class="line">   for(int i = 0; i &lt; 512; i++)&#123;</span><br><span class="line">     pte_t pte = pagetable[i];</span><br><span class="line">     if((pte &amp; PTE_V) &amp;&amp; (pte &amp; (PTE_R|PTE_W|PTE_X)) == 0)&#123;</span><br><span class="line"><span class="meta">@@ -320,7 +332,7 @@</span> void kvm_freepagetable(pagetable_t pagetable) &#123;</span><br><span class="line">   uint64 page_size;</span><br><span class="line">   uvmunmap(pagetable, UART0, PGSIZE/PGSIZE, 0);</span><br><span class="line">   uvmunmap(pagetable, VIRTIO0, PGSIZE/PGSIZE, 0);</span><br><span class="line"><span class="deletion">-  uvmunmap(pagetable, CLINT, 0x10000/PGSIZE, 0);</span></span><br><span class="line"><span class="addition">+  //uvmunmap(pagetable, CLINT, 0x10000/PGSIZE, 0);</span></span><br><span class="line">   uvmunmap(pagetable, PLIC, 0x400000/PGSIZE, 0);</span><br><span class="line"></span><br><span class="line">   page_size = PGROUNDUP((uint64)etext - KERNBASE);</span><br><span class="line"><span class="meta">@@ -342,7 +354,7 @@</span> void kvm_freepagetable(pagetable_t pagetable) &#123;</span><br><span class="line"> // returns 0 on success, -1 on failure.</span><br><span class="line"> // frees any allocated pages on failure.</span><br><span class="line"> int</span><br><span class="line"><span class="deletion">-uvmcopy(pagetable_t old, pagetable_t new, uint64 sz)</span></span><br><span class="line"><span class="addition">+uvmcopy(pagetable_t old, pagetable_t new, pagetable_t new_kpagetable, uint64 sz)</span></span><br><span class="line"> &#123;</span><br><span class="line">   pte_t *pte;</span><br><span class="line">   uint64 pa, i;</span><br><span class="line"><span class="meta">@@ -363,10 +375,16 @@</span> uvmcopy(pagetable_t old, pagetable_t new, uint64 sz)</span><br><span class="line">       kfree(mem);</span><br><span class="line">       goto err;</span><br><span class="line">     &#125;</span><br><span class="line"><span class="addition">+    if(mappages(new_kpagetable, i, PGSIZE, (uint64)mem, (flags&amp;(~PTE_U)) ) != 0)&#123;</span></span><br><span class="line"><span class="addition">+      kfree(mem);</span></span><br><span class="line"><span class="addition">+      goto err;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   &#125;</span><br><span class="line">   return 0;</span><br><span class="line"></span><br><span class="line">  err:</span><br><span class="line"><span class="addition">+  uvmunmap(new_kpagetable, 0, i / PGSIZE, 0);</span></span><br><span class="line">   uvmunmap(new, 0, i / PGSIZE, 1);</span><br><span class="line">   return -1;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta">@@ -415,23 +433,7 @@</span> copyout(pagetable_t pagetable, uint64 dstva, char *src, uint64 len)</span><br><span class="line"> int</span><br><span class="line"> copyin(pagetable_t pagetable, char *dst, uint64 srcva, uint64 len)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="deletion">-  uint64 n, va0, pa0;</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-  while(len &gt; 0)&#123;</span></span><br><span class="line"><span class="deletion">-    va0 = PGROUNDDOWN(srcva);</span></span><br><span class="line"><span class="deletion">-    pa0 = walkaddr(pagetable, va0);</span></span><br><span class="line"><span class="deletion">-    if(pa0 == 0)</span></span><br><span class="line"><span class="deletion">-      return -1;</span></span><br><span class="line"><span class="deletion">-    n = PGSIZE - (srcva - va0);</span></span><br><span class="line"><span class="deletion">-    if(n &gt; len)</span></span><br><span class="line"><span class="deletion">-      n = len;</span></span><br><span class="line"><span class="deletion">-    memmove(dst, (void *)(pa0 + (srcva - va0)), n);</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-    len -= n;</span></span><br><span class="line"><span class="deletion">-    dst += n;</span></span><br><span class="line"><span class="deletion">-    srcva = va0 + PGSIZE;</span></span><br><span class="line"><span class="deletion">-  &#125;</span></span><br><span class="line"><span class="deletion">-  return 0;</span></span><br><span class="line"><span class="addition">+  return copyin_new(pagetable, dst, srcva, len);</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> // Copy a null-terminated string from user to kernel.</span><br><span class="line"><span class="meta">@@ -441,40 +443,7 @@</span> copyin(pagetable_t pagetable, char *dst, uint64 srcva, uint64 len)</span><br><span class="line"> int</span><br><span class="line"> copyinstr(pagetable_t pagetable, char *dst, uint64 srcva, uint64 max)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="deletion">-  uint64 n, va0, pa0;</span></span><br><span class="line"><span class="deletion">-  int got_null = 0;</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-  while(got_null == 0 &amp;&amp; max &gt; 0)&#123;</span></span><br><span class="line"><span class="deletion">-    va0 = PGROUNDDOWN(srcva);</span></span><br><span class="line"><span class="deletion">-    pa0 = walkaddr(pagetable, va0);</span></span><br><span class="line"><span class="deletion">-    if(pa0 == 0)</span></span><br><span class="line"><span class="deletion">-      return -1;</span></span><br><span class="line"><span class="deletion">-    n = PGSIZE - (srcva - va0);</span></span><br><span class="line"><span class="deletion">-    if(n &gt; max)</span></span><br><span class="line"><span class="deletion">-      n = max;</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-    char *p = (char *) (pa0 + (srcva - va0));</span></span><br><span class="line"><span class="deletion">-    while(n &gt; 0)&#123;</span></span><br><span class="line"><span class="deletion">-      if(*p == &#x27;\0&#x27;)&#123;</span></span><br><span class="line"><span class="deletion">-        *dst = &#x27;\0&#x27;;</span></span><br><span class="line"><span class="deletion">-        got_null = 1;</span></span><br><span class="line"><span class="deletion">-        break;</span></span><br><span class="line"><span class="deletion">-      &#125; else &#123;</span></span><br><span class="line"><span class="deletion">-        *dst = *p;</span></span><br><span class="line"><span class="deletion">-      &#125;</span></span><br><span class="line"><span class="deletion">-      --n;</span></span><br><span class="line"><span class="deletion">-      --max;</span></span><br><span class="line"><span class="deletion">-      p++;</span></span><br><span class="line"><span class="deletion">-      dst++;</span></span><br><span class="line"><span class="deletion">-    &#125;</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-    srcva = va0 + PGSIZE;</span></span><br><span class="line"><span class="deletion">-  &#125;</span></span><br><span class="line"><span class="deletion">-  if(got_null)&#123;</span></span><br><span class="line"><span class="deletion">-    return 0;</span></span><br><span class="line"><span class="deletion">-  &#125; else &#123;</span></span><br><span class="line"><span class="deletion">-    return -1;</span></span><br><span class="line"><span class="deletion">-  &#125;</span></span><br><span class="line"><span class="addition">+  return copyinstr_new(pagetable, dst, srcva, max);</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> void vmprint(pagetable_t pagetable) &#123;</span><br></pre></td></tr></table></figure>

<h2 id="4-Lab-trap-相关"><a href="#4-Lab-trap-相关" class="headerlink" title="| 4 | Lab trap 相关"></a>| 4 | Lab trap 相关</h2><h3 id="4-1-Chapter-4-amp-LEC-6-note"><a href="#4-1-Chapter-4-amp-LEC-6-note" class="headerlink" title="| 4.1 | Chapter 4 &amp; LEC 6 note"></a>| 4.1 | Chapter 4 &amp; LEC 6 note</h3><blockquote>
<p>There are <strong>three</strong> kinds of event which cause the CPU to set aside ordinary execution of instructions and <u>force a transfer of control to special code</u> that handles the event.</p>
</blockquote>
<ul>
<li>system call(<code>ecall</code>)</li>
<li><em>exception</em></li>
<li>device <em>interrupt</em></li>
</ul>
<p>tarp 应该是 <strong>tansparent</strong>，尤其对于 interrupts 因其随时可能发生。</p>
<blockquote>
<p>While commonality among the three trap types <u>suggests that a kernel could handle all traps with a <strong>single</strong> code path</u>, it turns out to be convenient to have <u>separate assembly vectors and C trap handlers</u> for <strong>three</strong> distinct cases: <u>traps from user space</u>, <u>traps from kernel space</u>, and <u>timer interrupts</u>.</p>
</blockquote>
<h4 id="4-1-1-RISC-V-trap-machinery"><a href="#4-1-1-RISC-V-trap-machinery" class="headerlink" title="| 4.1.1 | RISC-V trap machinery"></a>| 4.1.1 | RISC-V trap machinery</h4><blockquote>
<p>What does the CPU’s “mode” protect?<br>i.e. what does switching mode from user to supervisor <strong>allow</strong>?<br>supervisor can <u>use CPU control registers:</u></p>
<ul>
<li>satp – page table physical address</li>
<li>stvec – ecall jumps here in kernel; points to trampoline</li>
<li>sepc – ecall saves user pc here</li>
<li>sscratch – address of trapframe</li>
<li>scause – a number put by RISC-V that describes the reason for the trap</li>
<li>sstatus: supervisor status register</li>
<li>…..</li>
</ul>
<p>supervisor can <u>use PTEs that have no PTE_U flag</u><br>but supervisor has <strong>no other powers!</strong> e.g.</p>
<ul>
<li><strong>can’t</strong> use addresses that <u>aren’t the in page table</u><br>so kernel has to carefully set things up so it can work</li>
</ul>
</blockquote>
<h4 id="4-1-2-Traps-from-user-space"><a href="#4-1-2-Traps-from-user-space" class="headerlink" title="| 4.1.2 | Traps from user space"></a>| 4.1.2 | Traps from user space</h4><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">preview:</span><br><span class="line">  write()                        write() returns              User</span><br><span class="line">  -----------------------------------------------------------------</span><br><span class="line">  uservec() in trampoline.S      userret() in trampoline.S   Kernel</span><br><span class="line">  usertrap() in trap.c           usertrapret() in trap.c</span><br><span class="line">  syscall() in syscall.c           ^</span><br><span class="line">  sys_write() in sysfile.c      ---|</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>ecall</code> did three things:</p>
<ul>
<li>change mode from user to supervisor</li>
<li>save <code>pc</code> in <code>sepc</code></li>
<li>jump to <code>stvec</code>(the kernel previously set <code>stvec</code>, before jumping to user space)</li>
</ul>
</blockquote>
<ul>
<li><p><code>uservec()</code>:</p>
<ul>
<li>保存 32 个 user registers (用于恢复)</li>
<li>切换到 kernel page table, kstack</li>
<li>jump to <code>usertrap()</code></li>
</ul>
</li>
<li><p><code>usertrap()</code></p>
<ul>
<li>修改 <code>stvec</code> &#x3D; kernelvec</li>
<li>根据 <code>scause</code> 调用不同的 handler</li>
<li><code>usertrapret()</code></li>
</ul>
</li>
<li><p><code>usertrapret()</code></p>
<ul>
<li>设置 <code>stvec</code> &#x3D; uservec</li>
<li>在 trapframe 中保存 kpagetable, kstack, hartid, usertrap 地址</li>
<li>设置 <code>sstatus</code> 寄存器</li>
<li>设置 <code>sepc</code> &#x3D; trapframe-&gt;epc</li>
</ul>
</li>
<li><p><code>userret()</code></p>
<ul>
<li>切换 <code>satp</code> &#x3D; user pagetable</li>
<li>恢复 32 个 user registers</li>
<li><code>sret</code></li>
</ul>
</li>
<li><p><code>sret</code></p>
<ul>
<li>设置 <code>sstatus</code> “previous mode” bit to user</li>
<li>恢复 <code>pc</code> &#x3D; <code>sepc</code></li>
</ul>
</li>
</ul>
<p>中断的开与关：</p>
<blockquote>
<p>后补</p>
</blockquote>
<h4 id="4-1-3-Traps-from-kernel-space"><a href="#4-1-3-Traps-from-kernel-space" class="headerlink" title="| 4.1.3 | Traps from kernel space"></a>| 4.1.3 | Traps from kernel space</h4><ul>
<li><p><code>kernelvec</code></p>
<p>保存 31 个寄存器到 kstack</p>
<p>call <code>kerneltrap</code></p>
<p><code>sret</code></p>
</li>
</ul>
<h3 id="4-3-Lab-traps"><a href="#4-3-Lab-traps" class="headerlink" title="| 4.3 | Lab: traps"></a>| 4.3 | <u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/labs/traps.html">Lab: traps</a></u></h3><img alt="图 2" src="/images/image-20240320063502.png" />

<h4 id="4-3-1-RISC-V-assembly-easy"><a href="#4-3-1-RISC-V-assembly-easy" class="headerlink" title="| 4.3.1 | RISC-V assembly (easy)"></a>| 4.3.1 | RISC-V assembly (easy)</h4><ol>
<li><p><code>a0~a7</code>, <code>a2</code> holds 13 when calling <code>printf</code> in main.</p>
</li>
<li><p><code>f</code> and <code>g</code> is called in compiler.</p>
</li>
<li><p><code>printf</code> is located at <code>0x628</code></p>
</li>
<li><p><code>ra</code> is 0x38</p>
</li>
<li><p>out put is “HE110 Worid”, if big-endian <code>i = 0x726c6400</code>. <code>57616</code> need not to be changed.</p>
</li>
<li><p>after “y&#x3D;”, it will print <code>(int)$a2</code>, because the 2nd arguement of format strings is <code>a2</code>.</p>
</li>
</ol>
<h4 id="4-3-2-Backtrace-moderate"><a href="#4-3-2-Backtrace-moderate" class="headerlink" title="| 4.3.2 | Backtrace (moderate)"></a>| 4.3.2 | Backtrace (moderate)</h4><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/kernel/defs.h b/kernel/defs.h</span></span><br><span class="line"><span class="comment">index 4b9bbc0..137c786 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/defs.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/defs.h</span></span><br><span class="line"><span class="meta">@@ -80,6 +80,7 @@</span> int             pipewrite(struct pipe*, uint64, int);</span><br><span class="line"> void            printf(char*, ...);</span><br><span class="line"> void            panic(char*) __attribute__((noreturn));</span><br><span class="line"> void            printfinit(void);</span><br><span class="line"><span class="addition">+void            backtrace(void);</span></span><br><span class="line"></span><br><span class="line"> // proc.c</span><br><span class="line"> int             cpuid(void);</span><br><span class="line"><span class="comment">diff --git a/kernel/printf.c b/kernel/printf.c</span></span><br><span class="line"><span class="comment">index e1347de..e9e1ccc 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/printf.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/printf.c</span></span><br><span class="line"><span class="meta">@@ -132,3 +132,15 @@</span> printfinit(void)</span><br><span class="line">   initlock(&amp;pr.lock, &quot;pr&quot;);</span><br><span class="line">   pr.locking = 1;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+void backtrace() &#123;</span></span><br><span class="line"><span class="addition">+  printf(&quot;backtrace:\n&quot;);</span></span><br><span class="line"><span class="addition">+  uint64 currfp = r_fp();</span></span><br><span class="line"><span class="addition">+  uint64 stack_top = PGROUNDUP(currfp);</span></span><br><span class="line"><span class="addition">+  while(currfp &lt;= stack_top) &#123;</span></span><br><span class="line"><span class="addition">+    printf(&quot;%p\n&quot;, *(uint64*)(currfp-8));</span></span><br><span class="line"><span class="addition">+    currfp = *(uint64*)(currfp-0x10);</span></span><br><span class="line"><span class="addition">+    if(*(uint64*)(currfp-8) &lt;= PLIC)</span></span><br><span class="line"><span class="addition">+      break;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="comment">diff --git a/kernel/riscv.h b/kernel/riscv.h</span></span><br><span class="line"><span class="comment">index 0aec003..7a443e9 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/riscv.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/riscv.h</span></span><br><span class="line"><span class="meta">@@ -311,6 +311,14 @@</span> r_ra()</span><br><span class="line">   return x;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="addition">+static inline uint64</span></span><br><span class="line"><span class="addition">+r_fp()</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+  uint64 x;</span></span><br><span class="line"><span class="addition">+  asm volatile(&quot;mv %0, s0&quot; : &quot;=r&quot; (x) );</span></span><br><span class="line"><span class="addition">+  return x;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> // flush the TLB.</span><br><span class="line"> static inline void</span><br><span class="line"> sfence_vma()</span><br><span class="line"><span class="comment">diff --git a/kernel/sysproc.c b/kernel/sysproc.c</span></span><br><span class="line"><span class="comment">index e8bcda9..fd19d2a 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/sysproc.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/sysproc.c</span></span><br><span class="line"><span class="meta">@@ -70,6 +70,7 @@</span> sys_sleep(void)</span><br><span class="line">     sleep(&amp;ticks, &amp;tickslock);</span><br><span class="line">   &#125;</span><br><span class="line">   release(&amp;tickslock);</span><br><span class="line"><span class="addition">+  backtrace();</span></span><br><span class="line">   return 0;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-3-3-Alarm-hard"><a href="#4-3-3-Alarm-hard" class="headerlink" title="| 4.3.3 | Alarm (hard)"></a>| 4.3.3 | Alarm (hard)</h4><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/Makefile b/Makefile</span></span><br><span class="line"><span class="comment">index 1fa367e..a74296b 100644</span></span><br><span class="line"><span class="comment">--- a/Makefile</span></span><br><span class="line"><span class="comment">+++ b/Makefile</span></span><br><span class="line"><span class="meta">@@ -175,6 +175,7 @@</span> UPROGS=\</span><br><span class="line">        $U/_grind\</span><br><span class="line">        $U/_wc\</span><br><span class="line">        $U/_zombie\</span><br><span class="line"><span class="addition">+       $U/_alarmtest\</span></span><br><span class="line"></span><br><span class="line"><span class="comment">diff --git a/kernel/proc.c b/kernel/proc.c</span></span><br><span class="line"><span class="comment">index dab1e1d..dcbd6ee 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/proc.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/proc.c</span></span><br><span class="line"><span class="meta">@@ -126,6 +126,7 @@</span> found:</span><br><span class="line">   memset(&amp;p-&gt;context, 0, sizeof(p-&gt;context));</span><br><span class="line">   p-&gt;context.ra = (uint64)forkret;</span><br><span class="line">   p-&gt;context.sp = p-&gt;kstack + PGSIZE;</span><br><span class="line"><span class="addition">+  p-&gt;alarm_state.finish = 1;</span></span><br><span class="line"></span><br><span class="line">   return p;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta">@@ -149,6 +150,10 @@</span> freeproc(struct proc *p)</span><br><span class="line">   p-&gt;chan = 0;</span><br><span class="line">   p-&gt;killed = 0;</span><br><span class="line">   p-&gt;xstate = 0;</span><br><span class="line"><span class="addition">+  p-&gt;alarm_state.finish = 0;</span></span><br><span class="line"><span class="addition">+  p-&gt;alarm_state.nticks = 0;</span></span><br><span class="line"><span class="addition">+  p-&gt;alarm_state.interval = 0;</span></span><br><span class="line"><span class="addition">+  p-&gt;alarm_state.alarm_handler = 0;</span></span><br><span class="line">   p-&gt;state = UNUSED;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">diff --git a/kernel/proc.h b/kernel/proc.h</span></span><br><span class="line"><span class="comment">index 9c16ea7..3f28564 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/proc.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/proc.h</span></span><br><span class="line"><span class="meta">@@ -82,6 +82,13 @@</span> struct trapframe &#123;</span><br><span class="line"></span><br><span class="line"> enum procstate &#123; UNUSED, SLEEPING, RUNNABLE, RUNNING, ZOMBIE &#125;;</span><br><span class="line"></span><br><span class="line"><span class="addition">+struct alarm &#123;</span></span><br><span class="line"><span class="addition">+  uint64 alarm_handler;</span></span><br><span class="line"><span class="addition">+  int nticks;</span></span><br><span class="line"><span class="addition">+  int interval;</span></span><br><span class="line"><span class="addition">+  char finish;</span></span><br><span class="line"><span class="addition">+&#125;;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> // Per-process state</span><br><span class="line"> struct proc &#123;</span><br><span class="line">   struct spinlock lock;</span><br><span class="line"><span class="meta">@@ -103,4 +110,5 @@</span> struct proc &#123;</span><br><span class="line">   struct file *ofile[NOFILE];  // Open files</span><br><span class="line">   struct inode *cwd;           // Current directory</span><br><span class="line">   char name[16];               // Process name (debugging)</span><br><span class="line"><span class="addition">+  struct alarm alarm_state;</span></span><br><span class="line"> &#125;;</span><br><span class="line"><span class="comment">diff --git a/kernel/syscall.c b/kernel/syscall.c</span></span><br><span class="line"><span class="comment">index c1b3670..a74be20 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/syscall.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/syscall.c</span></span><br><span class="line"><span class="meta">@@ -104,6 +104,8 @@</span> extern uint64 sys_unlink(void);</span><br><span class="line"> extern uint64 sys_wait(void);</span><br><span class="line"> extern uint64 sys_write(void);</span><br><span class="line"> extern uint64 sys_uptime(void);</span><br><span class="line"><span class="addition">+extern uint64 sys_sigalarm(void);</span></span><br><span class="line"><span class="addition">+extern uint64 sys_sigreturn(void);</span></span><br><span class="line"></span><br><span class="line"> static uint64 (*syscalls[])(void) = &#123;</span><br><span class="line"> [SYS_fork]    sys_fork,</span><br><span class="line"><span class="meta">@@ -127,6 +129,8 @@</span> static uint64 (*syscalls[])(void) = &#123;</span><br><span class="line"> [SYS_link]    sys_link,</span><br><span class="line"> [SYS_mkdir]   sys_mkdir,</span><br><span class="line"> [SYS_close]   sys_close,</span><br><span class="line"><span class="addition">+[SYS_sigalarm]   sys_sigalarm,</span></span><br><span class="line"><span class="addition">+[SYS_sigreturn]   sys_sigreturn,</span></span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> void</span><br><span class="line"><span class="comment">diff --git a/kernel/syscall.h b/kernel/syscall.h</span></span><br><span class="line"><span class="comment">index bc5f356..93b4622 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/syscall.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/syscall.h</span></span><br><span class="line"><span class="meta">@@ -20,3 +20,5 @@</span></span><br><span class="line"> #define SYS_link   19</span><br><span class="line"> #define SYS_mkdir  20</span><br><span class="line"> #define SYS_close  21</span><br><span class="line"><span class="addition">+#define SYS_sigalarm   22</span></span><br><span class="line"><span class="addition">+#define SYS_sigreturn  23</span></span><br><span class="line"><span class="comment">diff --git a/kernel/sysproc.c b/kernel/sysproc.c</span></span><br><span class="line"><span class="comment">index fd19d2a..6a020a6 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/sysproc.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/sysproc.c</span></span><br><span class="line"><span class="meta">@@ -7,6 +7,8 @@</span></span><br><span class="line"> #include &quot;spinlock.h&quot;</span><br><span class="line"> #include &quot;proc.h&quot;</span><br><span class="line"></span><br><span class="line"><span class="addition">+extern struct trapframe alarm_trapframe;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> uint64</span><br><span class="line"> sys_exit(void)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="meta">@@ -96,3 +98,24 @@</span> sys_uptime(void)</span><br><span class="line">   release(&amp;tickslock);</span><br><span class="line">   return xticks;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+uint64 sys_sigalarm(void) &#123;</span></span><br><span class="line"><span class="addition">+  int ticks;</span></span><br><span class="line"><span class="addition">+  void (*handler)();</span></span><br><span class="line"><span class="addition">+  if(argint(0, &amp;ticks) &lt; 0)</span></span><br><span class="line"><span class="addition">+    return -1;</span></span><br><span class="line"><span class="addition">+  if(argaddr(1, (uint64*)&amp;handler) &lt; 0)</span></span><br><span class="line"><span class="addition">+    return -1;</span></span><br><span class="line"><span class="addition">+  if(ticks &lt; 0)</span></span><br><span class="line"><span class="addition">+    return -1;</span></span><br><span class="line"><span class="addition">+  myproc()-&gt;alarm_state.interval = ticks;</span></span><br><span class="line"><span class="addition">+  myproc()-&gt;alarm_state.alarm_handler= (uint64)handler;</span></span><br><span class="line"><span class="addition">+  return ticks;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+uint64 sys_sigreturn(void) &#123;</span></span><br><span class="line"><span class="addition">+  *myproc()-&gt;trapframe = alarm_trapframe;</span></span><br><span class="line"><span class="addition">+  myproc()-&gt;alarm_state.finish = 1;</span></span><br><span class="line"><span class="addition">+  usertrapret();</span></span><br><span class="line"><span class="addition">+  return 0;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="comment">diff --git a/kernel/trap.c b/kernel/trap.c</span></span><br><span class="line"><span class="comment">index a63249e..5d70b1e 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/trap.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/trap.c</span></span><br><span class="line"><span class="meta">@@ -7,6 +7,7 @@</span></span><br><span class="line"> #include &quot;defs.h&quot;</span><br><span class="line"></span><br><span class="line"> struct spinlock tickslock;</span><br><span class="line"><span class="addition">+struct trapframe alarm_trapframe;</span></span><br><span class="line"> uint ticks;</span><br><span class="line"></span><br><span class="line"> extern char trampoline[], uservec[], userret[];</span><br><span class="line"><span class="meta">@@ -76,6 +77,17 @@</span> usertrap(void)</span><br><span class="line">   if(p-&gt;killed)</span><br><span class="line">     exit(-1);</span><br><span class="line"></span><br><span class="line"><span class="addition">+  if(p-&gt;alarm_state.interval &amp;&amp; which_dev == 2) &#123;</span></span><br><span class="line"><span class="addition">+    p-&gt;alarm_state.nticks++;</span></span><br><span class="line"><span class="addition">+    if(p-&gt;alarm_state.finish &amp;&amp; p-&gt;alarm_state.nticks &gt;= p-&gt;alarm_state.interval) &#123;</span></span><br><span class="line"><span class="addition">+      // save user regs</span></span><br><span class="line"><span class="addition">+      alarm_trapframe = *p-&gt;trapframe;</span></span><br><span class="line"><span class="addition">+      p-&gt;trapframe-&gt;epc = p-&gt;alarm_state.alarm_handler;</span></span><br><span class="line"><span class="addition">+      p-&gt;alarm_state.nticks = 0;</span></span><br><span class="line"><span class="addition">+      p-&gt;alarm_state.finish = 0;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   // give up the CPU if this is a timer interrupt.</span><br><span class="line">   if(which_dev == 2)</span><br><span class="line">     yield();</span><br><span class="line"><span class="comment">diff --git a/time.txt b/time.txt</span></span><br><span class="line">new file mode 100644</span><br><span class="line"><span class="comment">index 0000000..b8626c4</span></span><br><span class="line"><span class="comment">--- /dev/null</span></span><br><span class="line"><span class="comment">+++ b/time.txt</span></span><br><span class="line">@@ -0,0 +1 @@</span><br><span class="line"><span class="addition">+4</span></span><br><span class="line"><span class="comment">diff --git a/user/user.h b/user/user.h</span></span><br><span class="line"><span class="comment">index b71ecda..5f0e83e 100644</span></span><br><span class="line"><span class="comment">--- a/user/user.h</span></span><br><span class="line"><span class="comment">+++ b/user/user.h</span></span><br><span class="line"><span class="meta">@@ -23,6 +23,8 @@</span> int getpid(void);</span><br><span class="line"> char* sbrk(int);</span><br><span class="line"> int sleep(int);</span><br><span class="line"> int uptime(void);</span><br><span class="line"><span class="addition">+int sigalarm(int, void (*handler)());</span></span><br><span class="line"><span class="addition">+int sigreturn(void);</span></span><br><span class="line"></span><br><span class="line"> // ulib.c</span><br><span class="line"> int stat(const char*, struct stat*);</span><br><span class="line"><span class="comment">diff --git a/user/usys.pl b/user/usys.pl</span></span><br><span class="line"><span class="comment">index 01e426e..fa548b0 100755</span></span><br><span class="line"><span class="comment">--- a/user/usys.pl</span></span><br><span class="line"><span class="comment">+++ b/user/usys.pl</span></span><br><span class="line"><span class="meta">@@ -36,3 +36,5 @@</span> entry(&quot;getpid&quot;);</span><br><span class="line"> entry(&quot;sbrk&quot;);</span><br><span class="line"> entry(&quot;sleep&quot;);</span><br><span class="line"> entry(&quot;uptime&quot;);</span><br><span class="line"><span class="addition">+entry(&quot;sigalarm&quot;);</span></span><br><span class="line"><span class="addition">+entry(&quot;sigreturn&quot;);</span></span><br></pre></td></tr></table></figure>

<h2 id="5-Lab-lazy-相关"><a href="#5-Lab-lazy-相关" class="headerlink" title="| 5 | Lab lazy 相关"></a>| 5 | Lab lazy 相关</h2><h3 id="5-1-Chapter-4-6-amp-LEC-8-note"><a href="#5-1-Chapter-4-6-amp-LEC-8-note" class="headerlink" title="| 5.1 | Chapter 4.6 &amp; LEC 8 note"></a>| 5.1 | Chapter 4.6 &amp; LEC 8 note</h3><blockquote>
<p>Key idea: <u>change page tables on page fault</u>, update page table instead of panic and <strong>restart</strong> instruction.</p>
</blockquote>
<blockquote>
<p><strong>Information</strong> we might need at page fault to do something interesting:</p>
<ol>
<li>The virtual address that caused the fault<br> See <code>stval</code> register; page faults set it to the fault address</li>
<li>The type of violation that caused the fault<br> See <code>scause</code> register value (instruction, load, and Store page fault)</li>
<li>The instruction and mode where the fault occurred</li>
</ol>
<ul>
<li>User IP: <code>tf-&gt;epc</code></li>
<li>U&#x2F;K mode: implicit in usertrap&#x2F;kerneltrap</li>
</ul>
</blockquote>
<h4 id="5-1-1-Lazy-Allocation"><a href="#5-1-1-Lazy-Allocation" class="headerlink" title="| 5.1.1 | Lazy Allocation"></a>| 5.1.1 | Lazy Allocation</h4><blockquote>
<p><code>sbrk</code> allocates memory that may <strong>never</strong> be used.</p>
</blockquote>
<blockquote>
<p>plan: allocate physical memory when application needs it</p>
<ul>
<li>Adjust <code>p-&gt;sz</code> on <code>sbrk</code>, but don’t allocate.</li>
<li>When application uses that memory, it will result in page fault.</li>
<li>On pagefault allocate memory resume at the fault instruction.</li>
</ul>
</blockquote>
<p>除此以外，在 unmap 的时候，对 lazy allocation 还未分配的内存应该不处理，继续循环。</p>
<h4 id="5-1-2-Copy-On-Write-COW-fork"><a href="#5-1-2-Copy-On-Write-COW-fork" class="headerlink" title="| 5.1.2 | Copy-On-Write (COW) fork"></a>| 5.1.2 | Copy-On-Write (COW) fork</h4><blockquote>
<p><a href="#6-Lab-cow-%E7%9B%B8%E5%85%B3">| 6.1 |</a></p>
</blockquote>
<h4 id="5-1-3-其他"><a href="#5-1-3-其他" class="headerlink" title="| 5.1.3 | 其他"></a>| 5.1.3 | 其他</h4><ul>
<li><p>Zero Fill Page</p>
<p><code>bss</code> segment 最开始都是 0，所以可把 bss 虚拟地址先映射到同一页且只读</p>
<p>当向 bss 写时触发 page fault，然后再该映射虚拟地址对应页。</p>
</li>
<li><p>Demand Paging</p>
</li>
</ul>
<blockquote>
<p>idea: load pages from the file on demand.</p>
<ul>
<li>allocate page table entries, but mark them on-demand.</li>
<li>on fault, read the page in from the file and update page table entry.</li>
<li>need to keep some meta information(Virtual Memoroy Area) about where a page is located on disk.</li>
</ul>
</blockquote>
<ul>
<li>Paging From Disk</li>
</ul>
<blockquote>
<p>idea: store less-frequently used parts of the address space on disk.  page-in and page-out pages of the address address space transparently.</p>
</blockquote>
<ul>
<li><p>Memory-Mapped Files</p>
<p>放在 mmap lab 讨论</p>
</li>
</ul>
<h3 id="5-2-Chapter-5-amp-LEC-9-note"><a href="#5-2-Chapter-5-amp-LEC-9-note" class="headerlink" title="| 5.2 | Chapter 5 &amp; LEC 9 note"></a>| 5.2 | Chapter 5 &amp; LEC 9 note</h3><ul>
<li><p><em>interrupts</em></p>
<blockquote>
<p>the interrupt tells the kernel the <strong>device hardware</strong> wants attention.</p>
</blockquote>
<blockquote>
<p>new issues:</p>
<ul>
<li>asynchronous: between <strong>running process</strong> and <strong>interrupt handler</strong></li>
<li>concurrency: <strong>device</strong> and <strong>process</strong> run in parallel</li>
<li>programming devices: device can be difficult to program</li>
</ul>
</blockquote>
</li>
<li><p>中断的来源</p>
<p>device -&gt; PLIC(Platform Level Interupt Control) -&gt; CPU</p>
<p>内核通过对 PLIC 编程灵活处理中断。</p>
</li>
<li><p><em>driver</em> 负责管理特定的设备：</p>
<blockquote>
<ul>
<li><p>configures the <strong>device hardware</strong>.</p>
</li>
<li><p>tells the device to perform <strong>operations</strong>.</p>
</li>
<li><p>handles the resulting <strong>interrupts</strong>.</p>
</li>
<li><p>interacts with <strong>processes</strong> that may be waiting for I&#x2F;O from the device.</p>
</li>
</ul>
</blockquote>
<blockquote>
<p>Many <strong>device drivers</strong> execute code in two contexts:</p>
<ul>
<li>a top half that runs in a process’s kernel thread <u>called via system calls</u>.</li>
<li>a bottom half that executes at interrupt time as interrupt handler <u>handling device interupt</u>.</li>
</ul>
</blockquote>
</li>
</ul>
<h4 id="5-2-1-Code-Console-input-x2F-output"><a href="#5-2-1-Code-Console-input-x2F-output" class="headerlink" title="| 5.2.1 | Code: Console input&#x2F;output"></a>| 5.2.1 | Code: Console input&#x2F;output</h4><p>当 xv6 启动时，<code>$</code> 是如何被打印到屏幕？</p>
<p>当用户在键盘敲下 <code>ls\n</code> 时，屏幕是如何显示 <code>ls</code> 以及 <code>ls</code> 执行的内容的？</p>
<blockquote>
<p>涉及 <code>console/uart</code> 的梳理，后补</p>
</blockquote>
<h4 id="5-2-2-Timer-interrupts"><a href="#5-2-2-Timer-interrupts" class="headerlink" title="| 5.2.2 | Timer interrupts"></a>| 5.2.2 | Timer interrupts</h4><blockquote>
<p>涉及 <code>mtvec/timervev/CLINT</code> 后补</p>
</blockquote>
<h3 id="5-3-Lab-xv6-lazy-page-allocation"><a href="#5-3-Lab-xv6-lazy-page-allocation" class="headerlink" title="| 5.3 | Lab: xv6 lazy page allocation"></a>| 5.3 | <u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/labs/lazy.html">Lab: xv6 lazy page allocation</a></u></h3><img alt="图 3" src="/images/image-20240321075130.png" />  

<img alt="图 4" src="/images/image-20240321075151.png" />  

<h4 id="5-3-1-Lazy-allocation-moderate-amp-amp-Lazytests-and-Usertests-moderate"><a href="#5-3-1-Lazy-allocation-moderate-amp-amp-Lazytests-and-Usertests-moderate" class="headerlink" title="| 5.3.1 | Lazy allocation (moderate) &amp;&amp; Lazytests and Usertests (moderate)"></a>| 5.3.1 | Lazy allocation (moderate) &amp;&amp; Lazytests and Usertests (moderate)</h4><ul>
<li><p><code>sbrk()</code> 不分配物理内存，只修改 <code>p-&gt;sz</code></p>
</li>
<li><p>什么时候分配：</p>
<ul>
<li>用户访问时触发 usertrap-&gt;page fault，再分配</li>
<li>用户 read&#x2F;write sbrk 返回的地址时，由于 xv6 是软件层面 <code>pa = walkaddr(va)</code>，所以 此时也需要分配。</li>
</ul>
</li>
<li><p>注意 ：</p>
<ul>
<li><code>va = p-&gt;sz</code> 的时候是非法的。</li>
<li>如果 <code>sbrk(n) &lt; 0</code>, 需要 <code>sbrk()</code> unmap (参考 <code>uvmdealloc()</code>。否则 <code>p-&gt;sz</code> 减小后，上面的 va 没有 unmap 且已经丢失。</li>
</ul>
</li>
</ul>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/kernel/defs.h b/kernel/defs.h</span></span><br><span class="line"><span class="comment">index 4b9bbc0..a2941de 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/defs.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/defs.h</span></span><br><span class="line"><span class="meta">@@ -167,10 +167,10 @@</span> int             uvmcopy(pagetable_t, pagetable_t, uint64);</span><br><span class="line"> void            uvmfree(pagetable_t, uint64);</span><br><span class="line"> void            uvmunmap(pagetable_t, uint64, uint64, int);</span><br><span class="line"> void            uvmclear(pagetable_t, uint64);</span><br><span class="line"><span class="deletion">-uint64          walkaddr(pagetable_t, uint64);</span></span><br><span class="line"><span class="deletion">-int             copyout(pagetable_t, uint64, char *, uint64);</span></span><br><span class="line"><span class="deletion">-int             copyin(pagetable_t, char *, uint64, uint64);</span></span><br><span class="line"><span class="deletion">-int             copyinstr(pagetable_t, char *, uint64, uint64);</span></span><br><span class="line"><span class="addition">+uint64          walkaddr(pagetable_t, uint64, uint64);</span></span><br><span class="line"><span class="addition">+int             copyout(pagetable_t, uint64, char *, uint64, uint64);</span></span><br><span class="line"><span class="addition">+int             copyin(pagetable_t, char *, uint64, uint64, uint64);</span></span><br><span class="line"><span class="addition">+int             copyinstr(pagetable_t, char *, uint64, uint64, uint64);</span></span><br><span class="line"></span><br><span class="line"> // plic.c</span><br><span class="line"> void            plicinit(void);</span><br><span class="line"><span class="comment">diff --git a/kernel/exec.c b/kernel/exec.c</span></span><br><span class="line"><span class="comment">index 0e8762f..c8b2e77 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/exec.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/exec.c</span></span><br><span class="line"><span class="meta">@@ -83,7 +83,7 @@</span> exec(char *path, char **argv)</span><br><span class="line">     sp -= sp % 16; // riscv sp must be 16-byte aligned</span><br><span class="line">     if(sp &lt; stackbase)</span><br><span class="line">       goto bad;</span><br><span class="line"><span class="deletion">-    if(copyout(pagetable, sp, argv[argc], strlen(argv[argc]) + 1) &lt; 0)</span></span><br><span class="line"><span class="addition">+    if(copyout(pagetable, sp, argv[argc], strlen(argv[argc]) + 1, sz) &lt; 0)</span></span><br><span class="line">       goto bad;</span><br><span class="line">     ustack[argc] = sp;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">@@ -94,7 +94,7 @@</span> exec(char *path, char **argv)</span><br><span class="line">   sp -= sp % 16;</span><br><span class="line">   if(sp &lt; stackbase)</span><br><span class="line">     goto bad;</span><br><span class="line"><span class="deletion">-  if(copyout(pagetable, sp, (char *)ustack, (argc+1)*sizeof(uint64)) &lt; 0)</span></span><br><span class="line"><span class="addition">+  if(copyout(pagetable, sp, (char *)ustack, (argc+1)*sizeof(uint64), sz) &lt; 0)</span></span><br><span class="line">     goto bad;</span><br><span class="line"></span><br><span class="line">   // arguments to user main(argc, argv)</span><br><span class="line"><span class="meta">@@ -142,7 +142,7 @@</span> loadseg(pagetable_t pagetable, uint64 va, struct inode *ip, uint offset, uint sz</span><br><span class="line">     panic(&quot;loadseg: va must be page aligned&quot;);</span><br><span class="line"></span><br><span class="line">   for(i = 0; i &lt; sz; i += PGSIZE)&#123;</span><br><span class="line"><span class="deletion">-    pa = walkaddr(pagetable, va + i);</span></span><br><span class="line"><span class="addition">+    pa = walkaddr(pagetable, va + i, sz);</span></span><br><span class="line">     if(pa == 0)</span><br><span class="line">       panic(&quot;loadseg: address should exist&quot;);</span><br><span class="line">     if(sz - i &lt; PGSIZE)</span><br><span class="line"><span class="comment">diff --git a/kernel/file.c b/kernel/file.c</span></span><br><span class="line"><span class="comment">index 116eb97..bf39254 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/file.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/file.c</span></span><br><span class="line"><span class="meta">@@ -94,7 +94,7 @@</span> filestat(struct file *f, uint64 addr)</span><br><span class="line">     ilock(f-&gt;ip);</span><br><span class="line">     stati(f-&gt;ip, &amp;st);</span><br><span class="line">     iunlock(f-&gt;ip);</span><br><span class="line"><span class="deletion">-    if(copyout(p-&gt;pagetable, addr, (char *)&amp;st, sizeof(st)) &lt; 0)</span></span><br><span class="line"><span class="addition">+    if(copyout(p-&gt;pagetable, addr, (char *)&amp;st, sizeof(st), p-&gt;sz) &lt; 0)</span></span><br><span class="line">       return -1;</span><br><span class="line">     return 0;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">diff --git a/kernel/pipe.c b/kernel/pipe.c</span></span><br><span class="line"><span class="comment">index 7ed402d..7c30f15 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/pipe.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/pipe.c</span></span><br><span class="line"><span class="meta">@@ -90,7 +90,7 @@</span> pipewrite(struct pipe *pi, uint64 addr, int n)</span><br><span class="line">       wakeup(&amp;pi-&gt;nread);</span><br><span class="line">       sleep(&amp;pi-&gt;nwrite, &amp;pi-&gt;lock);</span><br><span class="line">     &#125;</span><br><span class="line"><span class="deletion">-    if(copyin(pr-&gt;pagetable, &amp;ch, addr + i, 1) == -1)</span></span><br><span class="line"><span class="addition">+    if(copyin(pr-&gt;pagetable, &amp;ch, addr + i, 1, pr-&gt;sz) == -1)</span></span><br><span class="line">       break;</span><br><span class="line">     pi-&gt;data[pi-&gt;nwrite++ % PIPESIZE] = ch;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">@@ -118,7 +118,7 @@</span> piperead(struct pipe *pi, uint64 addr, int n)</span><br><span class="line">     if(pi-&gt;nread == pi-&gt;nwrite)</span><br><span class="line">       break;</span><br><span class="line">     ch = pi-&gt;data[pi-&gt;nread++ % PIPESIZE];</span><br><span class="line"><span class="deletion">-    if(copyout(pr-&gt;pagetable, addr + i, &amp;ch, 1) == -1)</span></span><br><span class="line"><span class="addition">+    if(copyout(pr-&gt;pagetable, addr + i, &amp;ch, 1, pr-&gt;sz) == -1)</span></span><br><span class="line">       break;</span><br><span class="line">   &#125;</span><br><span class="line">   wakeup(&amp;pi-&gt;nwrite);  //DOC: piperead-wakeup</span><br><span class="line"><span class="comment">diff --git a/kernel/proc.c b/kernel/proc.c</span></span><br><span class="line"><span class="comment">index ebbf5a2..191042e 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/proc.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/proc.c</span></span><br><span class="line"><span class="meta">@@ -421,7 +421,7 @@</span> wait(uint64 addr)</span><br><span class="line">           // Found one.</span><br><span class="line">           pid = np-&gt;pid;</span><br><span class="line">           if(addr != 0 &amp;&amp; copyout(p-&gt;pagetable, addr, (char *)&amp;np-&gt;xstate,</span><br><span class="line"><span class="deletion">-                                  sizeof(np-&gt;xstate)) &lt; 0) &#123;</span></span><br><span class="line"><span class="addition">+                                  sizeof(np-&gt;xstate), p-&gt;sz) &lt; 0) &#123;</span></span><br><span class="line">             release(&amp;np-&gt;lock);</span><br><span class="line">             release(&amp;p-&gt;lock);</span><br><span class="line">             return -1;</span><br><span class="line"><span class="meta">@@ -644,7 +644,7 @@</span> either_copyout(int user_dst, uint64 dst, void *src, uint64 len)</span><br><span class="line"> &#123;</span><br><span class="line">   struct proc *p = myproc();</span><br><span class="line">   if(user_dst)&#123;</span><br><span class="line"><span class="deletion">-    return copyout(p-&gt;pagetable, dst, src, len);</span></span><br><span class="line"><span class="addition">+    return copyout(p-&gt;pagetable, dst, src, len, p-&gt;sz);</span></span><br><span class="line">   &#125; else &#123;</span><br><span class="line">     memmove((char *)dst, src, len);</span><br><span class="line">     return 0;</span><br><span class="line"><span class="meta">@@ -659,7 +659,7 @@</span> either_copyin(void *dst, int user_src, uint64 src, uint64 len)</span><br><span class="line"> &#123;</span><br><span class="line">   struct proc *p = myproc();</span><br><span class="line">   if(user_src)&#123;</span><br><span class="line"><span class="deletion">-    return copyin(p-&gt;pagetable, dst, src, len);</span></span><br><span class="line"><span class="addition">+    return copyin(p-&gt;pagetable, dst, src, len, p-&gt;sz);</span></span><br><span class="line">   &#125; else &#123;</span><br><span class="line">     memmove(dst, (char*)src, len);</span><br><span class="line">     return 0;</span><br><span class="line"><span class="comment">diff --git a/kernel/syscall.c b/kernel/syscall.c</span></span><br><span class="line"><span class="comment">index c1b3670..42d5961 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/syscall.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/syscall.c</span></span><br><span class="line"><span class="meta">@@ -14,7 +14,7 @@</span> fetchaddr(uint64 addr, uint64 *ip)</span><br><span class="line">   struct proc *p = myproc();</span><br><span class="line">   if(addr &gt;= p-&gt;sz || addr+sizeof(uint64) &gt; p-&gt;sz)</span><br><span class="line">     return -1;</span><br><span class="line"><span class="deletion">-  if(copyin(p-&gt;pagetable, (char *)ip, addr, sizeof(*ip)) != 0)</span></span><br><span class="line"><span class="addition">+  if(copyin(p-&gt;pagetable, (char *)ip, addr, sizeof(*ip), p-&gt;sz) != 0)</span></span><br><span class="line">     return -1;</span><br><span class="line">   return 0;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta">@@ -25,7 +25,7 @@</span> int</span><br><span class="line"> fetchstr(uint64 addr, char *buf, int max)</span><br><span class="line"> &#123;</span><br><span class="line">   struct proc *p = myproc();</span><br><span class="line"><span class="deletion">-  int err = copyinstr(p-&gt;pagetable, buf, addr, max);</span></span><br><span class="line"><span class="addition">+  int err = copyinstr(p-&gt;pagetable, buf, addr, max, p-&gt;sz);</span></span><br><span class="line">   if(err &lt; 0)</span><br><span class="line">     return err;</span><br><span class="line">   return strlen(buf);</span><br><span class="line"><span class="comment">diff --git a/kernel/sysfile.c b/kernel/sysfile.c</span></span><br><span class="line"><span class="comment">index 5dc453b..e5a6826 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/sysfile.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/sysfile.c</span></span><br><span class="line"><span class="meta">@@ -474,8 +474,8 @@</span> sys_pipe(void)</span><br><span class="line">     fileclose(wf);</span><br><span class="line">     return -1;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="deletion">-  if(copyout(p-&gt;pagetable, fdarray, (char*)&amp;fd0, sizeof(fd0)) &lt; 0 ||</span></span><br><span class="line"><span class="deletion">-     copyout(p-&gt;pagetable, fdarray+sizeof(fd0), (char *)&amp;fd1, sizeof(fd1)) &lt; 0)&#123;</span></span><br><span class="line"><span class="addition">+  if(copyout(p-&gt;pagetable, fdarray, (char*)&amp;fd0, sizeof(fd0), p-&gt;sz) &lt; 0 ||</span></span><br><span class="line"><span class="addition">+     copyout(p-&gt;pagetable, fdarray+sizeof(fd0), (char *)&amp;fd1, sizeof(fd1), p-&gt;sz) &lt; 0)&#123;</span></span><br><span class="line">     p-&gt;ofile[fd0] = 0;</span><br><span class="line">     p-&gt;ofile[fd1] = 0;</span><br><span class="line">     fileclose(rf);</span><br><span class="line"><span class="comment">diff --git a/kernel/sysproc.c b/kernel/sysproc.c</span></span><br><span class="line"><span class="comment">index e8bcda9..a85c634 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/sysproc.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/sysproc.c</span></span><br><span class="line"><span class="meta">@@ -41,15 +41,24 @@</span> sys_wait(void)</span><br><span class="line"> uint64</span><br><span class="line"> sys_sbrk(void)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="deletion">-  int addr;</span></span><br><span class="line"><span class="addition">+  uint64 oldsz, newsz;</span></span><br><span class="line">   int n;</span><br><span class="line"><span class="addition">+  struct proc* p;</span></span><br><span class="line"></span><br><span class="line">   if(argint(0, &amp;n) &lt; 0)</span><br><span class="line">     return -1;</span><br><span class="line"><span class="deletion">-  addr = myproc()-&gt;sz;</span></span><br><span class="line"><span class="deletion">-  if(growproc(n) &lt; 0)</span></span><br><span class="line"><span class="addition">+  p = myproc();</span></span><br><span class="line"><span class="addition">+  oldsz = p-&gt;sz;</span></span><br><span class="line"><span class="addition">+  newsz = p-&gt;sz + n;</span></span><br><span class="line"><span class="addition">+  if(newsz &lt;=0)</span></span><br><span class="line">     return -1;</span><br><span class="line"><span class="deletion">-  return addr;</span></span><br><span class="line"><span class="addition">+  if(PGROUNDUP(newsz) &lt; PGROUNDUP(oldsz))&#123;</span></span><br><span class="line"><span class="addition">+    int npages = (PGROUNDUP(oldsz) - PGROUNDUP(newsz)) / PGSIZE;</span></span><br><span class="line"><span class="addition">+    uvmunmap(p-&gt;pagetable, PGROUNDUP(newsz), npages, 1);</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  p-&gt;sz = newsz;</span></span><br><span class="line"><span class="addition">+  return oldsz;</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> uint64</span><br><span class="line"><span class="comment">diff --git a/kernel/trap.c b/kernel/trap.c</span></span><br><span class="line"><span class="comment">index a63249e..e264b3c 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/trap.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/trap.c</span></span><br><span class="line"><span class="meta">@@ -67,6 +67,27 @@</span> usertrap(void)</span><br><span class="line">     syscall();</span><br><span class="line">   &#125; else if((which_dev = devintr()) != 0)&#123;</span><br><span class="line">     // ok</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  &#125; else if(r_scause() == 15 || r_scause() == 13) &#123;</span></span><br><span class="line"><span class="addition">+    //printf(&quot;page fault: scause is %p sepc=%p stval=%p\n&quot;, r_scause(), r_sepc(), r_stvec());</span></span><br><span class="line"><span class="addition">+    uint64 va = r_stval();</span></span><br><span class="line"><span class="addition">+    if(va &gt;= p-&gt;sz)</span></span><br><span class="line"><span class="addition">+      p-&gt;killed = 1;</span></span><br><span class="line"><span class="addition">+    else if(PGROUNDUP(va) == PGROUNDDOWN(p-&gt;trapframe-&gt;sp))</span></span><br><span class="line"><span class="addition">+      p-&gt;killed = 1;</span></span><br><span class="line"><span class="addition">+    else &#123;</span></span><br><span class="line"><span class="addition">+      uint64 pa = (uint64)kalloc();</span></span><br><span class="line"><span class="addition">+      if(pa == 0)</span></span><br><span class="line"><span class="addition">+        p-&gt;killed = 1;</span></span><br><span class="line"><span class="addition">+      else &#123;</span></span><br><span class="line"><span class="addition">+        memset((void*)pa, 0, PGSIZE);</span></span><br><span class="line"><span class="addition">+        if(mappages(p-&gt;pagetable, PGROUNDDOWN(va), PGSIZE, pa, PTE_W | PTE_R | PTE_U)) &#123;</span></span><br><span class="line"><span class="addition">+          kfree((void *)pa);</span></span><br><span class="line"><span class="addition">+          p-&gt;killed = 1;</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+      &#125;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   &#125; else &#123;</span><br><span class="line">     printf(&quot;usertrap(): unexpected scause %p pid=%d\n&quot;, r_scause(), p-&gt;pid);</span><br><span class="line">     printf(&quot;            sepc=%p stval=%p\n&quot;, r_sepc(), r_stval());</span><br><span class="line"><span class="comment">diff --git a/kernel/vm.c b/kernel/vm.c</span></span><br><span class="line"><span class="comment">index bccb405..e66d3ac 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/vm.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/vm.c</span></span><br><span class="line"><span class="meta">@@ -92,7 +92,7 @@</span> walk(pagetable_t pagetable, uint64 va, int alloc)</span><br><span class="line"> // or 0 if not mapped.</span><br><span class="line"> // Can only be used to look up user pages.</span><br><span class="line"> uint64</span><br><span class="line"><span class="deletion">-walkaddr(pagetable_t pagetable, uint64 va)</span></span><br><span class="line"><span class="addition">+walkaddr(pagetable_t pagetable, uint64 va, uint64 sz)</span></span><br><span class="line"> &#123;</span><br><span class="line">   pte_t *pte;</span><br><span class="line">   uint64 pa;</span><br><span class="line"><span class="meta">@@ -100,11 +100,20 @@</span> walkaddr(pagetable_t pagetable, uint64 va)</span><br><span class="line">   if(va &gt;= MAXVA)</span><br><span class="line">     return 0;</span><br><span class="line"></span><br><span class="line"><span class="deletion">-  pte = walk(pagetable, va, 0);</span></span><br><span class="line"><span class="deletion">-  if(pte == 0)</span></span><br><span class="line"><span class="deletion">-    return 0;</span></span><br><span class="line"><span class="deletion">-  if((*pte &amp; PTE_V) == 0)</span></span><br><span class="line"><span class="addition">+  if(va &gt;= sz)  // va can&#x27;t be equal to sz</span></span><br><span class="line">     return 0;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  pte = walk(pagetable, va, 0);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  if(pte == 0 || (*pte &amp; PTE_V) == 0) &#123;</span></span><br><span class="line"><span class="addition">+    pa = (uint64)kalloc();</span></span><br><span class="line"><span class="addition">+    if(pa == 0)</span></span><br><span class="line"><span class="addition">+      return 0;</span></span><br><span class="line"><span class="addition">+    memset((void*)pa, 0, PGSIZE);</span></span><br><span class="line"><span class="addition">+    if(mappages(pagetable, PGROUNDDOWN(va), PGSIZE, pa, PTE_W | PTE_R | PTE_U)) &#123;</span></span><br><span class="line"><span class="addition">+      kfree((void *)pa);</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line">   if((*pte &amp; PTE_U) == 0)</span><br><span class="line">     return 0;</span><br><span class="line">   pa = PTE2PA(*pte);</span><br><span class="line"><span class="meta">@@ -181,9 +190,10 @@</span> uvmunmap(pagetable_t pagetable, uint64 va, uint64 npages, int do_free)</span><br><span class="line"></span><br><span class="line">   for(a = va; a &lt; va + npages*PGSIZE; a += PGSIZE)&#123;</span><br><span class="line">     if((pte = walk(pagetable, a, 0)) == 0)</span><br><span class="line"><span class="deletion">-      panic(&quot;uvmunmap: walk&quot;);</span></span><br><span class="line"><span class="addition">+      continue;</span></span><br><span class="line">     if((*pte &amp; PTE_V) == 0)</span><br><span class="line"><span class="deletion">-      panic(&quot;uvmunmap: not mapped&quot;);</span></span><br><span class="line"><span class="addition">+      continue;</span></span><br><span class="line">     if(PTE_FLAGS(*pte) == PTE_V)</span><br><span class="line">       panic(&quot;uvmunmap: not a leaf&quot;);</span><br><span class="line">     if(do_free)&#123;</span><br><span class="line"><span class="meta">@@ -315,9 +325,9 @@</span> uvmcopy(pagetable_t old, pagetable_t new, uint64 sz)</span><br><span class="line"></span><br><span class="line">   for(i = 0; i &lt; sz; i += PGSIZE)&#123;</span><br><span class="line">     if((pte = walk(old, i, 0)) == 0)</span><br><span class="line"><span class="deletion">-      panic(&quot;uvmcopy: pte should exist&quot;);</span></span><br><span class="line"><span class="addition">+      continue;</span></span><br><span class="line">     if((*pte &amp; PTE_V) == 0)</span><br><span class="line"><span class="deletion">-      panic(&quot;uvmcopy: page not present&quot;);</span></span><br><span class="line"><span class="addition">+      continue;</span></span><br><span class="line">     pa = PTE2PA(*pte);</span><br><span class="line">     flags = PTE_FLAGS(*pte);</span><br><span class="line">     if((mem = kalloc()) == 0)</span><br><span class="line"><span class="meta">@@ -352,13 +362,13 @@</span> uvmclear(pagetable_t pagetable, uint64 va)</span><br><span class="line"> // Copy len bytes from src to virtual address dstva in a given page table.</span><br><span class="line"> // Return 0 on success, -1 on error.</span><br><span class="line"> int</span><br><span class="line"><span class="deletion">-copyout(pagetable_t pagetable, uint64 dstva, char *src, uint64 len)</span></span><br><span class="line"><span class="addition">+copyout(pagetable_t pagetable, uint64 dstva, char *src, uint64 len, uint64 sz)</span></span><br><span class="line"> &#123;</span><br><span class="line">   uint64 n, va0, pa0;</span><br><span class="line"></span><br><span class="line">   while(len &gt; 0)&#123;</span><br><span class="line">     va0 = PGROUNDDOWN(dstva);</span><br><span class="line"><span class="deletion">-    pa0 = walkaddr(pagetable, va0);</span></span><br><span class="line"><span class="addition">+    pa0 = walkaddr(pagetable, va0, sz);</span></span><br><span class="line">     if(pa0 == 0)</span><br><span class="line">       return -1;</span><br><span class="line">     n = PGSIZE - (dstva - va0);</span><br><span class="line"><span class="meta">@@ -377,13 +387,13 @@</span> copyout(pagetable_t pagetable, uint64 dstva, char *src, uint64 len)</span><br><span class="line"> // Copy len bytes to dst from virtual address srcva in a given page table.</span><br><span class="line"> // Return 0 on success, -1 on error.</span><br><span class="line"> int</span><br><span class="line"><span class="deletion">-copyin(pagetable_t pagetable, char *dst, uint64 srcva, uint64 len)</span></span><br><span class="line"><span class="addition">+copyin(pagetable_t pagetable, char *dst, uint64 srcva, uint64 len, uint64 sz)</span></span><br><span class="line"> &#123;</span><br><span class="line">   uint64 n, va0, pa0;</span><br><span class="line"></span><br><span class="line">   while(len &gt; 0)&#123;</span><br><span class="line">     va0 = PGROUNDDOWN(srcva);</span><br><span class="line"><span class="deletion">-    pa0 = walkaddr(pagetable, va0);</span></span><br><span class="line"><span class="addition">+    pa0 = walkaddr(pagetable, va0, sz);</span></span><br><span class="line">     if(pa0 == 0)</span><br><span class="line">       return -1;</span><br><span class="line">     n = PGSIZE - (srcva - va0);</span><br><span class="line"><span class="meta">@@ -403,14 +413,14 @@</span> copyin(pagetable_t pagetable, char *dst, uint64 srcva, uint64 len)</span><br><span class="line"> // until a &#x27;\0&#x27;, or max.</span><br><span class="line"> // Return 0 on success, -1 on error.</span><br><span class="line"> int</span><br><span class="line"><span class="deletion">-copyinstr(pagetable_t pagetable, char *dst, uint64 srcva, uint64 max)</span></span><br><span class="line"><span class="addition">+copyinstr(pagetable_t pagetable, char *dst, uint64 srcva, uint64 max, uint64 sz)</span></span><br><span class="line"> &#123;</span><br><span class="line">   uint64 n, va0, pa0;</span><br><span class="line">   int got_null = 0;</span><br><span class="line"></span><br><span class="line">   while(got_null == 0 &amp;&amp; max &gt; 0)&#123;</span><br><span class="line">     va0 = PGROUNDDOWN(srcva);</span><br><span class="line"><span class="deletion">-    pa0 = walkaddr(pagetable, va0);</span></span><br><span class="line"><span class="addition">+    pa0 = walkaddr(pagetable, va0, sz);</span></span><br><span class="line">     if(pa0 == 0)</span><br><span class="line">       return -1;</span><br><span class="line">     n = PGSIZE - (srcva - va0);</span><br></pre></td></tr></table></figure>

<h2 id="6-Lab-cow-相关"><a href="#6-Lab-cow-相关" class="headerlink" title="| 6 | Lab cow 相关"></a>| 6 | Lab cow 相关</h2><blockquote>
<p>The goal of copy-on-write (COW) fork() is to <u>defer allocating and copying physical memory pages</u> for the child until the copies are <strong>actually needed</strong>, if ever.</p>
</blockquote>
<ul>
<li><code>uvmcopy()</code><ul>
<li><code>walk()</code> parent 的 pagetable， *pte &amp;&#x3D; ~PTE_W,*pte |&#x3D; PTE_C</li>
<li>映射到 child 的 pagetable, reference count ++;</li>
</ul>
</li>
<li><code>usertrap()</code><ul>
<li>在 pagefault 的时候，识别出 cow page，</li>
<li>分配物理内存, 分配失败则 kill</li>
<li>复制原数据</li>
<li>修改 PTE 指向新的物理帧且可写，原 page 的 <code>reference count--</code></li>
<li>重新执行</li>
</ul>
</li>
<li><code>proc_freepagetable()</code><ul>
<li>如果是 COW page，<code>--reference count == 0</code> 则 释放</li>
</ul>
</li>
<li>reference count 如何实现<ul>
<li>NPROC &#x3D; 64，小于 0xff</li>
<li>计算 <code>freerange()</code> 创建了多少 page，然后根据该数量减去内存(见下面的 <code>kalloc.c-kinit()</code>)</li>
<li><code>kvmmap()</code> 的时候不应该设置 ref count，因为 ref count 是表示当前 page 被 user pagetable 引用的数量</li>
<li><code>kalloc()</code> 时 设置 <code>cnt = 0</code></li>
<li><code>mappages()</code> 的时候，<code>cnt++</code></li>
<li><code>uvmunmap()</code> 且 do_free 时 <code>cnt--</code></li>
<li><code>cnt==1</code> 则修改 pte 即可</li>
</ul>
</li>
<li><code>copyout()</code><ul>
<li>和 <code>usertap()</code> 类似操作</li>
</ul>
</li>
</ul>
<h3 id="6-1-Lab-Copy-on-Write-Fork-for-xv6"><a href="#6-1-Lab-Copy-on-Write-Fork-for-xv6" class="headerlink" title="| 6.1 | Lab: Copy-on-Write Fork for xv6"></a>| 6.1 | <u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/labs/cow.html">Lab: Copy-on-Write Fork for xv6</a></u></h3><img alt="图 7" src="/images/image-20240324042818.png" />  

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/kernel/defs.h b/kernel/defs.h</span></span><br><span class="line"><span class="comment">index 4b9bbc0..234b90d 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/defs.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/defs.h</span></span><br><span class="line"><span class="meta">@@ -63,6 +63,9 @@</span> void            ramdiskrw(struct buf*);</span><br><span class="line"> void*           kalloc(void);</span><br><span class="line"> void            kfree(void *);</span><br><span class="line"> void            kinit(void);</span><br><span class="line"><span class="addition">+void            inc_ref_cnt(uint64);</span></span><br><span class="line"><span class="addition">+uint8           get_ref_cnt(uint64);</span></span><br><span class="line"><span class="addition">+uint8           dec_ref_cnt(uint64);</span></span><br><span class="line"></span><br><span class="line"> // log.c</span><br><span class="line"> void            initlog(int, struct superblock*);</span><br><span class="line"><span class="meta">@@ -167,11 +170,13 @@</span> int             uvmcopy(pagetable_t, pagetable_t, uint64);</span><br><span class="line"> void            uvmfree(pagetable_t, uint64);</span><br><span class="line"> void            uvmunmap(pagetable_t, uint64, uint64, int);</span><br><span class="line"> void            uvmclear(pagetable_t, uint64);</span><br><span class="line"><span class="addition">+pte_t*          walkpte(pagetable_t pagetable, uint64 va);</span></span><br><span class="line"> uint64          walkaddr(pagetable_t, uint64);</span><br><span class="line"> int             copyout(pagetable_t, uint64, char *, uint64);</span><br><span class="line"> int             copyin(pagetable_t, char *, uint64, uint64);</span><br><span class="line"> int             copyinstr(pagetable_t, char *, uint64, uint64);</span><br><span class="line"></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> // plic.c</span><br><span class="line"> void            plicinit(void);</span><br><span class="line"> void            plicinithart(void);</span><br><span class="line"><span class="comment">diff --git a/kernel/kalloc.c b/kernel/kalloc.c</span></span><br><span class="line"><span class="comment">index fa6a0ac..8234080 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/kalloc.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/kalloc.c</span></span><br><span class="line"><span class="meta">@@ -14,6 +14,8 @@</span> void freerange(void *pa_start, void *pa_end);</span><br><span class="line"> extern char end[]; // first address after kernel.</span><br><span class="line">                    // defined by kernel.ld.</span><br><span class="line"></span><br><span class="line"><span class="addition">+uint8* phy_ref_cnt;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> struct run &#123;</span><br><span class="line">   struct run *next;</span><br><span class="line"> &#125;;</span><br><span class="line"><span class="meta">@@ -23,11 +25,42 @@</span> struct &#123;</span><br><span class="line">   struct run *freelist;</span><br><span class="line"> &#125; kmem;</span><br><span class="line"></span><br><span class="line"><span class="addition">+void inc_ref_cnt(uint64 pa) &#123;</span></span><br><span class="line"><span class="addition">+  acquire(&amp;kmem.lock);</span></span><br><span class="line"><span class="addition">+  if(pa &gt;= (uint64)end &amp;&amp; pa &lt; PHYSTOP)</span></span><br><span class="line"><span class="addition">+    phy_ref_cnt[(pa-(uint64)end)&gt;&gt;12]++;</span></span><br><span class="line"><span class="addition">+  release(&amp;kmem.lock);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+uint8 dec_ref_cnt(uint64 pa) &#123;</span></span><br><span class="line"><span class="addition">+  uint8 result=0;</span></span><br><span class="line"><span class="addition">+  if(get_ref_cnt(pa) == 0)</span></span><br><span class="line"><span class="addition">+    panic(&quot;dec_ref_cnt&quot;);</span></span><br><span class="line"><span class="addition">+  acquire(&amp;kmem.lock);</span></span><br><span class="line"><span class="addition">+  result = --phy_ref_cnt[(pa-(uint64)end)&gt;&gt;12]; // called by uvmunmap pa is in range</span></span><br><span class="line"><span class="addition">+  release(&amp;kmem.lock);</span></span><br><span class="line"><span class="addition">+  return result;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+uint8 get_ref_cnt(uint64 pa) &#123;</span></span><br><span class="line"><span class="addition">+  uint8 result = 1;</span></span><br><span class="line"><span class="addition">+  acquire(&amp;kmem.lock);</span></span><br><span class="line"><span class="addition">+  if(pa &gt;= (uint64)end &amp;&amp; pa &lt; PHYSTOP)</span></span><br><span class="line"><span class="addition">+    result = phy_ref_cnt[(pa-(uint64)end)&gt;&gt;12];</span></span><br><span class="line"><span class="addition">+  release(&amp;kmem.lock);</span></span><br><span class="line"><span class="addition">+  return result;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> void</span><br><span class="line"> kinit()</span><br><span class="line"> &#123;</span><br><span class="line">   initlock(&amp;kmem.lock, &quot;kmem&quot;);</span><br><span class="line"><span class="deletion">-  freerange(end, (void*)PHYSTOP);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  // caculate the need of ref counts</span></span><br><span class="line"><span class="addition">+  int bytes = (PHYSTOP-PGROUNDUP((uint64)end))&gt;&gt;12;</span></span><br><span class="line"><span class="addition">+  phy_ref_cnt = (uint8*)end;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  freerange((void*)end+bytes, (void*)PHYSTOP);</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> void</span><br><span class="line"><span class="meta">@@ -72,8 +105,10 @@</span> kalloc(void)</span><br><span class="line"></span><br><span class="line">   acquire(&amp;kmem.lock);</span><br><span class="line">   r = kmem.freelist;</span><br><span class="line"><span class="deletion">-  if(r)</span></span><br><span class="line"><span class="addition">+  if(r) &#123;</span></span><br><span class="line">     kmem.freelist = r-&gt;next;</span><br><span class="line"><span class="addition">+    phy_ref_cnt[((uint64)r-(uint64)end)&gt;&gt;12] = 0;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line">   release(&amp;kmem.lock);</span><br><span class="line"></span><br><span class="line">   if(r)</span><br><span class="line"><span class="comment">diff --git a/kernel/riscv.h b/kernel/riscv.h</span></span><br><span class="line"><span class="comment">index 0aec003..7b5db8a 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/riscv.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/riscv.h</span></span><br><span class="line"><span class="meta">@@ -331,6 +331,7 @@</span> sfence_vma()</span><br><span class="line"> #define PTE_W (1L &lt;&lt; 2)</span><br><span class="line"> #define PTE_X (1L &lt;&lt; 3)</span><br><span class="line"> #define PTE_U (1L &lt;&lt; 4) // 1 -&gt; user can access</span><br><span class="line"><span class="addition">+#define PTE_C (1L &lt;&lt; 8)</span></span><br><span class="line"></span><br><span class="line"> // shift a physical address to the right place for a PTE.</span><br><span class="line"> #define PA2PTE(pa) ((((uint64)pa) &gt;&gt; 12) &lt;&lt; 10)</span><br><span class="line"><span class="comment">diff --git a/kernel/trap.c b/kernel/trap.c</span></span><br><span class="line"><span class="comment">index a63249e..e08ee89 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/trap.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/trap.c</span></span><br><span class="line"><span class="meta">@@ -10,6 +10,7 @@</span> struct spinlock tickslock;</span><br><span class="line"> uint ticks;</span><br><span class="line"></span><br><span class="line"> extern char trampoline[], uservec[], userret[];</span><br><span class="line"><span class="addition">+extern uint8* phy_ref_cnt;</span></span><br><span class="line"></span><br><span class="line"> // in kernelvec.S, calls kerneltrap().</span><br><span class="line"> void kernelvec();</span><br><span class="line"><span class="meta">@@ -65,6 +66,34 @@</span> usertrap(void)</span><br><span class="line">     intr_on();</span><br><span class="line"></span><br><span class="line">     syscall();</span><br><span class="line"><span class="addition">+  &#125; else if(r_scause() == 15) &#123;</span></span><br><span class="line"><span class="addition">+    // write page fault</span></span><br><span class="line"><span class="addition">+    uint64 val = r_stval();</span></span><br><span class="line"><span class="addition">+    if(val &gt;= p-&gt;sz) &#123;// check va</span></span><br><span class="line"><span class="addition">+      p-&gt;killed = 1;</span></span><br><span class="line"><span class="addition">+      exit(-1);</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    pte_t *pte = walkpte(p-&gt;pagetable, val);</span></span><br><span class="line"><span class="addition">+    if(pte == 0 || !(*pte &amp; PTE_C)) &#123;</span></span><br><span class="line"><span class="addition">+      p-&gt;killed = 1;</span></span><br><span class="line"><span class="addition">+      exit(-1);</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+    uint64 pa = PTE2PA(*pte);</span></span><br><span class="line"><span class="addition">+    if (get_ref_cnt(pa) == 1) &#123;</span></span><br><span class="line"><span class="addition">+      *pte |= PTE_W;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    else &#123;</span></span><br><span class="line"><span class="addition">+      char* mem = (char*)kalloc();</span></span><br><span class="line"><span class="addition">+      if(mem == 0) &#123;</span></span><br><span class="line"><span class="addition">+        p-&gt;killed = 1;</span></span><br><span class="line"><span class="addition">+        exit(-1);</span></span><br><span class="line"><span class="addition">+      &#125;</span></span><br><span class="line"><span class="addition">+      memmove(mem, (char*)pa, PGSIZE);</span></span><br><span class="line"><span class="addition">+      uvmunmap(p-&gt;pagetable, PGROUNDDOWN(val), 1, 1);</span></span><br><span class="line"><span class="addition">+      mappages(p-&gt;pagetable, PGROUNDDOWN(val), PGSIZE, (uint64)mem, PTE_X|PTE_W|PTE_U|PTE_R);</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   &#125; else if((which_dev = devintr()) != 0)&#123;</span><br><span class="line">     // ok</span><br><span class="line">   &#125; else &#123;</span><br><span class="line"><span class="comment">diff --git a/kernel/vm.c b/kernel/vm.c</span></span><br><span class="line"><span class="comment">index bccb405..85c7424 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/vm.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/vm.c</span></span><br><span class="line"><span class="meta">@@ -111,14 +111,46 @@</span> walkaddr(pagetable_t pagetable, uint64 va)</span><br><span class="line">   return pa;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="addition">+pte_t* walkpte(pagetable_t pagetable, uint64 va) &#123;</span></span><br><span class="line"><span class="addition">+  pte_t *pte;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  if(va &gt;= MAXVA)</span></span><br><span class="line"><span class="addition">+    return 0;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  pte = walk(pagetable, va, 0);</span></span><br><span class="line"><span class="addition">+  if(pte == 0)</span></span><br><span class="line"><span class="addition">+    return 0;</span></span><br><span class="line"><span class="addition">+  if((*pte &amp; PTE_V) == 0)</span></span><br><span class="line"><span class="addition">+    return 0;</span></span><br><span class="line"><span class="addition">+  if((*pte &amp; PTE_U) == 0)</span></span><br><span class="line"><span class="addition">+    return 0;</span></span><br><span class="line"><span class="addition">+  return pte;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> // add a mapping to the kernel page table.</span><br><span class="line"> // only used when booting.</span><br><span class="line"> // does not flush TLB or enable paging.</span><br><span class="line"> void</span><br><span class="line"> kvmmap(uint64 va, uint64 pa, uint64 sz, int perm)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="deletion">-  if(mappages(kernel_pagetable, va, sz, pa, perm) != 0)</span></span><br><span class="line"><span class="deletion">-    panic(&quot;kvmmap&quot;);</span></span><br><span class="line"><span class="addition">+  // kvmmap should not increase ref cnt</span></span><br><span class="line"><span class="addition">+  uint64 a, last;</span></span><br><span class="line"><span class="addition">+  pte_t *pte;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  a = PGROUNDDOWN(va);</span></span><br><span class="line"><span class="addition">+  last = PGROUNDDOWN(va + sz - 1);</span></span><br><span class="line"><span class="addition">+  for(;;)&#123;</span></span><br><span class="line"><span class="addition">+    if((pte = walk(kernel_pagetable, a, 1)) == 0)</span></span><br><span class="line"><span class="addition">+      panic(&quot;kvmmap&quot;);</span></span><br><span class="line"><span class="addition">+    if(*pte &amp; PTE_V)</span></span><br><span class="line"><span class="addition">+      panic(&quot;remap&quot;);</span></span><br><span class="line"><span class="addition">+    *pte = PA2PTE(pa) | perm | PTE_V;</span></span><br><span class="line"><span class="addition">+    if(a == last)</span></span><br><span class="line"><span class="addition">+      break;</span></span><br><span class="line"><span class="addition">+    a += PGSIZE;</span></span><br><span class="line"><span class="addition">+    pa += PGSIZE;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> // translate a kernel virtual address to</span><br><span class="line"><span class="meta">@@ -159,6 +191,7 @@</span> mappages(pagetable_t pagetable, uint64 va, uint64 size, uint64 pa, int perm)</span><br><span class="line">     if(*pte &amp; PTE_V)</span><br><span class="line">       panic(&quot;remap&quot;);</span><br><span class="line">     *pte = PA2PTE(pa) | perm | PTE_V;</span><br><span class="line"><span class="addition">+    inc_ref_cnt(pa);</span></span><br><span class="line">     if(a == last)</span><br><span class="line">       break;</span><br><span class="line">     a += PGSIZE;</span><br><span class="line"><span class="meta">@@ -188,7 +221,8 @@</span> uvmunmap(pagetable_t pagetable, uint64 va, uint64 npages, int do_free)</span><br><span class="line">       panic(&quot;uvmunmap: not a leaf&quot;);</span><br><span class="line">     if(do_free)&#123;</span><br><span class="line">       uint64 pa = PTE2PA(*pte);</span><br><span class="line"><span class="deletion">-      kfree((void*)pa);</span></span><br><span class="line"><span class="addition">+      if(!dec_ref_cnt(pa))</span></span><br><span class="line"><span class="addition">+        kfree((void*)pa);</span></span><br><span class="line">     &#125;</span><br><span class="line">     *pte = 0;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">@@ -311,7 +345,6 @@</span> uvmcopy(pagetable_t old, pagetable_t new, uint64 sz)</span><br><span class="line">   pte_t *pte;</span><br><span class="line">   uint64 pa, i;</span><br><span class="line">   uint flags;</span><br><span class="line"><span class="deletion">-  char *mem;</span></span><br><span class="line"></span><br><span class="line">   for(i = 0; i &lt; sz; i += PGSIZE)&#123;</span><br><span class="line">     if((pte = walk(old, i, 0)) == 0)</span><br><span class="line"><span class="meta">@@ -319,14 +352,11 @@</span> uvmcopy(pagetable_t old, pagetable_t new, uint64 sz)</span><br><span class="line">     if((*pte &amp; PTE_V) == 0)</span><br><span class="line">       panic(&quot;uvmcopy: page not present&quot;);</span><br><span class="line">     pa = PTE2PA(*pte);</span><br><span class="line"><span class="addition">+    *pte = *pte | PTE_C;</span></span><br><span class="line"><span class="addition">+    *pte = *pte &amp; ~PTE_W;</span></span><br><span class="line">     flags = PTE_FLAGS(*pte);</span><br><span class="line"><span class="deletion">-    if((mem = kalloc()) == 0)</span></span><br><span class="line"><span class="deletion">-      goto err;</span></span><br><span class="line"><span class="deletion">-    memmove(mem, (char*)pa, PGSIZE);</span></span><br><span class="line"><span class="deletion">-    if(mappages(new, i, PGSIZE, (uint64)mem, flags) != 0)&#123;</span></span><br><span class="line"><span class="deletion">-      kfree(mem);</span></span><br><span class="line"><span class="addition">+    if(mappages(new, i, PGSIZE, (uint64)pa, flags) != 0)</span></span><br><span class="line">       goto err;</span><br><span class="line"><span class="deletion">-    &#125;</span></span><br><span class="line">   &#125;</span><br><span class="line">   return 0;</span><br><span class="line"></span><br><span class="line"><span class="meta">@@ -355,15 +385,35 @@</span> int</span><br><span class="line"> copyout(pagetable_t pagetable, uint64 dstva, char *src, uint64 len)</span><br><span class="line"> &#123;</span><br><span class="line">   uint64 n, va0, pa0;</span><br><span class="line"><span class="addition">+  pte_t *pte;</span></span><br><span class="line"></span><br><span class="line">   while(len &gt; 0)&#123;</span><br><span class="line">     va0 = PGROUNDDOWN(dstva);</span><br><span class="line"><span class="deletion">-    pa0 = walkaddr(pagetable, va0);</span></span><br><span class="line"><span class="deletion">-    if(pa0 == 0)</span></span><br><span class="line"><span class="addition">+    pte = walkpte(pagetable, va0);</span></span><br><span class="line"><span class="addition">+    if(pte == 0)</span></span><br><span class="line">       return -1;</span><br><span class="line"><span class="addition">+    pa0 = PTE2PA(*pte);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+    if((*pte &amp; PTE_C) &amp;&amp; !(*pte&amp;PTE_W)) &#123;</span></span><br><span class="line"><span class="addition">+      // dealing with COW page</span></span><br><span class="line"><span class="addition">+      if (get_ref_cnt(pa0) == 1) &#123;</span></span><br><span class="line"><span class="addition">+        *pte |= PTE_W;</span></span><br><span class="line"><span class="addition">+      &#125;</span></span><br><span class="line"><span class="addition">+      else &#123;</span></span><br><span class="line"><span class="addition">+        char* mem = (char*)kalloc();</span></span><br><span class="line"><span class="addition">+        if(mem == 0) &#123;</span></span><br><span class="line"><span class="addition">+          return -1;</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+        memmove(mem, (char*)pa0, PGSIZE);</span></span><br><span class="line"><span class="addition">+        uvmunmap(pagetable, va0, 1, 1);</span></span><br><span class="line"><span class="addition">+        mappages(pagetable, va0, PGSIZE, (uint64)mem, PTE_X|PTE_W|PTE_U|PTE_R);</span></span><br><span class="line"><span class="addition">+        pa0 = (uint64)mem;</span></span><br><span class="line"><span class="addition">+      &#125;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">     n = PGSIZE - (dstva - va0);</span><br><span class="line">     if(n &gt; len)</span><br><span class="line"><span class="deletion">-      n = len;</span></span><br><span class="line"><span class="addition">+      n = len;  // dealing one page a time</span></span><br><span class="line">     memmove((void *)(pa0 + (dstva - va0)), src, n);</span><br><span class="line"></span><br><span class="line">     len -= n;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="7-Lab-thread-相关"><a href="#7-Lab-thread-相关" class="headerlink" title="| 7 | Lab thread 相关"></a>| 7 | Lab thread 相关</h2><h3 id="7-1-Chapter-6-amp-LEC-10-note"><a href="#7-1-Chapter-6-amp-LEC-10-note" class="headerlink" title="| 7.1 | Chapter 6 &amp; LEC 10 note"></a>| 7.1 | Chapter 6 &amp; LEC 10 note</h3><ul>
<li>concurrency problems</li>
<li>broken acquire</li>
<li>lock problems</li>
<li>mem ordering</li>
</ul>
<h3 id="7-2-Chapter-7-amp-LEC-11-note-amp-LEC-13-note"><a href="#7-2-Chapter-7-amp-LEC-11-note-amp-LEC-13-note" class="headerlink" title="| 7.2 | Chapter 7 &amp; LEC 11 note &amp; LEC 13 note"></a>| 7.2 | Chapter 7 &amp; LEC 11 note &amp; LEC 13 note</h3><h3 id="7-3-Lab-Multithreading"><a href="#7-3-Lab-Multithreading" class="headerlink" title="| 7.3 | Lab: Multithreading"></a>| 7.3 | <u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/labs/thread.html">Lab: Multithreading</a></u></h3><h2 id="8-Lab-lock-相关"><a href="#8-Lab-lock-相关" class="headerlink" title="| 8 | Lab lock 相关"></a>| 8 | Lab lock 相关</h2><h3 id="8-1-Lab-locks"><a href="#8-1-Lab-locks" class="headerlink" title="| 8.1 | Lab: locks"></a>| 8.1 | <u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/labs/lock.html">Lab: locks</a></u></h3><!-- ## | 9 | Lab fs 相关

### | 9.1 | Chapter 8 & LEC 14 note

### | 9.2 | LEC 15 note

### | 9.3 | LEC 16 note

### | 9.4 | <u>[Lab: file system](https://pdos.lcs.mit.edu/6.828/2020/labs/fs.html)</u>

## | 10 | Lab mmap 相关

### | 10.1 | LEC 17 note

### | 10.2 | LEC 18 note

### | 10.3 | LEC 19 note

### | 10.4 | LEC 20 note

### | 10.5 | <u>[Lab: mmap](https://pdos.lcs.mit.edu/6.828/2020/labs/mmap.html)</u>

## | 11 | Lab net 相关

### | 11.1 | LEC 21 note

### | 11.2 | <u>[Lab: networking](https://pdos.lcs.mit.edu/6.828/2020/labs/net.html)</u>

## | 12 | Meltdown & RCU

### | 12.1 | LEC 22 note

### | 12.2 | LEC 23 note

## | 13 | 总结 -->

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/OS/">OS</a><a href="/tags/MIT/">MIT</a><a href="/tags/Experiment/">Experiment</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Deployed by <a href="https://github.com/kaedea/notion-down" target="_blank">notion-down</a> and
    Theme by <a href="https://github.com/kaedea/hexo-theme-hacker" target="_blank">hexo-theme-hacker</a>
    </br>
    
      &copy; 2024
        sev1n75 &lt;sev1n75@qq.com&gt;
          
  </p>
</footer>
    
  </div>
</div>
</body>
</html>