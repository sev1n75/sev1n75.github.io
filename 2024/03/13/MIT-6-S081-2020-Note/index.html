<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
    <title>
      MIT 6.S081 2020 å­¦ä¹ ç¬”è®° | sev1n75 | Binary Exploit</title>

  
  <meta name="author" content="sev1n75">
  

  
  <meta name="description" content="CTF Pwn é€‰æ‰‹ï¼Œä»¥æ­¤åšå®¢åˆ†äº«æŠ€æœ¯å’Œå­¦ä¹ è¿‡ç¨‹">
  

  
  
  <meta name="keywords" content="OS,MIT,Experiment">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="MIT 6.S081 2020 å­¦ä¹ ç¬”è®°"/>

  <meta property="og:site_name" content="sev1n75"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/images/favicon.png" type="image/png" rel="icon">
  <link href="/images/favicon.png" rel="apple-touch-icon" sizes="76x76">
  <link rel="alternate" href="/atom.xml" title="sev1n75" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  
  <link href="https://fonts.lug.ustc.edu.cn/css?family=Lato|Rubik" rel="stylesheet">
  <script src="/js/pangu-407.min.js"></script>
<meta name="generator" content="Hexo 6.3.0"></head>
<script>
  document.addEventListener(' DOMContentLoaded', () => {
    pangu.autoSpacingPage();
  });
</script>

<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">
        sev1n75's Tech Blog
      </a>
    </h1>
    <p class="site-description">
      
        è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®ï¼Œå¾å°†ä¸Šä¸‹è€Œæ±‚ç´¢
          
    </p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">
            ä¸»é¡µ
          </a></li>
        
        <li><a href="/archives">
            å½’æ¡£
          </a></li>
        
        <li><a href="/tags">
            æ ‡ç­¾
          </a></li>
        
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>MIT 6.S081 2020 å­¦ä¹ ç¬”è®°</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2024/03/13/MIT-6-S081-2020-Note/" rel="bookmark">
        <time class="entry-date published" datetime="2024-03-13T07:36:07.000Z">
          2024-03-13
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        

<script type="text/javascript">
    function convertRemToPixels(rem) {    
        return rem * parseFloat(getComputedStyle(document.documentElement).fontSize);
    }
    window.onscroll = function() {
        var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        if (scrollTop > convertRemToPixels(40)) {
            document.getElementsByClassName('toc-article')[0].style.visibility = 'visible';
        } else {
            document.getElementsByClassName('toc-article')[0].style.visibility = 'hidden';
        }
    }
</script>


<div id="toc" class="toc-article">
      <div class="toc-content">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-%E5%89%8D%E8%A8%80"><span class="toc-text">| 0 | å‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Lab-util-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 1 | Lab util ç›¸å…³</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-LEC-1-amp-Chapter-1-note"><span class="toc-text">| 1.1 | LEC 1  &amp; Chapter 1 note</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-LEC-2-note"><span class="toc-text">| 1.2 | LEC 2 note</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-Lab-Xv6-and-Unix-utilities"><span class="toc-text">| 1.3 | Lab: Xv6 and Unix utilities</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-1-Boot-xv6-easy"><span class="toc-text">| 1.3.1 | Boot xv6 (easy)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-sleep-easy"><span class="toc-text">| 1.3.2 | sleep (easy)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-3-pingpong-easy"><span class="toc-text">| 1.3.3 | pingpong (easy)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-4-primes-moderate-x2F-hard"><span class="toc-text">| 1.3.4 | primes (moderate)&#x2F;(hard)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-5-find-moderate-amp-xargs-moderate"><span class="toc-text">| 1.3.5 | find (moderate) &amp; xargs (moderate)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Lab-syscall-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 2 | Lab syscall ç›¸å…³</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Chapter-2-note-amp-LEC-3-note"><span class="toc-text">| 2.1 | Chapter 2 note &amp; LEC 3 note</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-Abstracting-physical-resources"><span class="toc-text">| 2.1.1 | Abstracting physical resources</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-User-mode-supervisor-mode-and-system-calls"><span class="toc-text">| 2.1.2 | User mode, supervisor mode, and system calls</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-3-Kernel-organization"><span class="toc-text">| 2.1.3 | Kernel organization</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-4-Process-overview"><span class="toc-text">| 2.1.4 | Process overview</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-5-Code-starting-xv6-and-the-first-process"><span class="toc-text">| 2.1.5 | Code: starting xv6 and the first process</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Lab-system-calls"><span class="toc-text">| 2.2 | Lab: system calls</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-System-call-tracing-moderate"><span class="toc-text">| 2.2.1 | System call tracing (moderate)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-Sysinfo-moderate"><span class="toc-text">| 2.2.2 | Sysinfo (moderate)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Lab-pgtbl-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 3 | Lab pgtbl ç›¸å…³</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Chapter-3-amp-LEC-4-note"><span class="toc-text">| 3.1 | Chapter 3 &amp; LEC 4 note</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-Paging-hardware"><span class="toc-text">| 3.1.1 | Paging hardware</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-Kernel-address-space"><span class="toc-text">| 3.1.2 | Kernel address space</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-3-Code-creating-an-address-space"><span class="toc-text">| 3.1.3 | Code: creating an address space</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-4-Code-exec"><span class="toc-text">| 3.1.4 | Code: exec</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-LEC-5-note"><span class="toc-text">| 3.2 | LEC 5 note</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-Lab-page-tables"><span class="toc-text">| 3.3 | Lab: page tables</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-Print-a-page-table-easy"><span class="toc-text">| 3.3.1 | Print a page table (easy)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2-A-kernel-page-table-per-process-hard"><span class="toc-text">| 3.3.2 | A kernel page table per process (hard)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-3-Simplify-copyin-copyinstr-hard"><span class="toc-text">| 3.3.3 | Simplify copyin&#x2F;copyinstr (hard)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Lab-trap-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 4 | Lab trap ç›¸å…³</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-Chapter-4-amp-LEC-6-note"><span class="toc-text">| 4.1 | Chapter 4 &amp; LEC 6 note</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-RISC-V-trap-machinery"><span class="toc-text">| 4.1.1 | RISC-V trap machinery</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-Traps-from-user-space"><span class="toc-text">| 4.1.2 | Traps from user space</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-3-Traps-from-kernel-space"><span class="toc-text">| 4.1.3 | Traps from kernel space</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-Lab-traps"><span class="toc-text">| 4.2 | Lab: traps</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-RISC-V-assembly-easy"><span class="toc-text">| 4.2.1 | RISC-V assembly (easy)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-Backtrace-moderate"><span class="toc-text">| 4.2.2 | Backtrace (moderate)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-3-Alarm-hard"><span class="toc-text">| 4.2.3 | Alarm (hard)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Lab-lazy-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 5 | Lab lazy ç›¸å…³</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-Chapter-4-6-amp-LEC-8-note"><span class="toc-text">| 5.1 | Chapter 4.6 &amp; LEC 8 note</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-1-Lazy-Allocation"><span class="toc-text">| 5.1.1 | Lazy Allocation</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-2-Copy-On-Write-COW-fork"><span class="toc-text">| 5.1.2 | Copy-On-Write (COW) fork</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1-3-%E5%85%B6%E4%BB%96"><span class="toc-text">| 5.1.3 | å…¶ä»–</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-Chapter-5-amp-LEC-9-note"><span class="toc-text">| 5.2 | Chapter 5 &amp; LEC 9 note</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-1-Code-Console-input-x2F-output"><span class="toc-text">| 5.2.1 | Code: Console input&#x2F;output</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2-2-Timer-interrupts"><span class="toc-text">| 5.2.2 | Timer interrupts</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-Lab-xv6-lazy-page-allocation"><span class="toc-text">| 5.3 | Lab: xv6 lazy page allocation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-1-Lazy-allocation-moderate-amp-amp-Lazytests-and-Usertests-moderate"><span class="toc-text">| 5.3.1 | Lazy allocation (moderate) &amp;&amp; Lazytests and Usertests (moderate)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Lab-cow-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 6 | Lab cow ç›¸å…³</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-Lab-Copy-on-Write-Fork-for-xv6"><span class="toc-text">| 6.1 | Lab: Copy-on-Write Fork for xv6</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Lab-thread-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 7 | Lab thread ç›¸å…³</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-Chapter-6-amp-LEC-10-note"><span class="toc-text">| 7.1 | Chapter 6 &amp; LEC 10 note</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-Chapter-7-amp-LEC-11-note-amp-LEC-13-note"><span class="toc-text">| 7.2 | Chapter 7 &amp; LEC 11 note &amp; LEC 13 note</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-1-switch-amp-scheduling"><span class="toc-text">| 7.2.1 | switch &amp; scheduling</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-2-sleep-amp-wakeup"><span class="toc-text">| 7.2.2 | sleep &amp; wakeup</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-2-3-wait-exit-amp-kill"><span class="toc-text">| 7.2.3 | wait, exit &amp; kill</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-Lab-Multithreading"><span class="toc-text">| 7.3 | Lab: Multithreading</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-3-1-Uthread-switching-between-threads-moderate"><span class="toc-text">| 7.3.1 | Uthread: switching between threads (moderate)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-3-2-Using-threads-moderate"><span class="toc-text">| 7.3.2 | Using threads (moderate)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-3-3-Barrier-moderate"><span class="toc-text">| 7.3.3 | Barrier(moderate)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Lab-lock-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 8 | Lab lock ç›¸å…³</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-Lab-locks"><span class="toc-text">| 8.1 | Lab: locks</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-1-Memory-allocator-moderate"><span class="toc-text">| 8.1.1 | Memory allocator (moderate)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-1-2-Buffer-cache-hard"><span class="toc-text">| 8.1.2 | Buffer cache (hard)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-Lab-fs-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 9 | Lab fs ç›¸å…³</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-LEC-14-note"><span class="toc-text">| 9.1 | LEC 14 note</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#9-1-1-Buffer-cache-layer"><span class="toc-text">|9.1.1| Buffer cache layer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-1-2-inode-layer-icache"><span class="toc-text">|9.1.2| inode layer(icache)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-LEC-15-note-amp-Chapter-8"><span class="toc-text">| 9.2 | LEC 15 note &amp; Chapter 8</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#9-2-1-logging-layer"><span class="toc-text">|9.2.1| logging layer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-2-2-Directory-pathname-file-descriptor-layer"><span class="toc-text">|9.2.2| Directory, pathname, file descriptor layer</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-LEC-16-note"><span class="toc-text">| 9.3 | LEC 16 note</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-4-Lab-file-system"><span class="toc-text">| 9.4 | Lab: file system</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#9-4-1-Large-files-moderate"><span class="toc-text">| 9.4.1 | Large files (moderate)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#9-4-2-Symbolic-links-moderate"><span class="toc-text">| 9.4.2 | Symbolic links (moderate)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-Lab-mmap-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 10 | Lab mmap ç›¸å…³</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-LEC-17-note"><span class="toc-text">| 10.1 | LEC 17 note</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2-LEC-18-note"><span class="toc-text">| 10.2 | LEC 18 note</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-LEC-19-note"><span class="toc-text">| 10.3 | LEC 19 note</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#10-3-1-trap-and-emulate"><span class="toc-text">| 10.3.1 | trap-and-emulate</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-3-2-hardware-support"><span class="toc-text">| 10.3.2 | hardware support</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#10-3-3-Dune-Safe-User-level-Access-to-Privileged-CPU-Features"><span class="toc-text">| 10.3.3 | Dune: Safe User-level Access to Privileged CPU Features</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-LEC-20-note"><span class="toc-text">| 10.4 | LEC 20 note</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-5-Lab-mmap"><span class="toc-text">| 10.5 | Lab: mmap</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-Lab-net-%E7%9B%B8%E5%85%B3"><span class="toc-text">| 11 | Lab net ç›¸å…³</span></a></li></ol>
      </div>
</div>
<style>
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>



        <h2 id="0-å‰è¨€"><a href="#0-å‰è¨€" class="headerlink" title="| 0 | å‰è¨€"></a>| 0 | å‰è¨€</h2><p>MIT 6.S081<del>(6.828?6.1810?)</del> æ˜¯ MIT ä¸€é—¨æ“ä½œç³»ç»Ÿè¯¾ç¨‹ï¼Œè¯¾ç¨‹åæ˜¯ <em>Operating System Engineering</em>ï¼ˆ<u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/schedule.html">2020å¹´è¯¾ç¨‹ç½‘å€</a></u>ï¼‰è¿™æ˜¯æˆ‘çš„å­¦ä¹ ç¬”è®°ï¼ŒåŒ…å«è¯¾ç¨‹è®²åº§(LECs), xv6 Book ä»¥åŠå®éªŒ(Labs)ã€‚</p>
<blockquote>
<p>âœ…æœ€è¿‘ä¸€æ¬¡æ›´æ–°ï¼š2024-4-5</p>
</blockquote>
<span id="more"></span>

<p>ğŸ’»ï¼š2018 Macbook Air</p>
<ul>
<li>CPU: 1.6 GHz åŒæ ¸Intel Core i5</li>
<li>8G å†…å­˜</li>
<li>ç”¨è™šæ‹Ÿæœºè·‘çš„ Ubuntu 22.04 LTS</li>
</ul>
<p>æˆ–è®¸æ˜¯é…ç½®é—®é¢˜ <code>usertests</code> åŸºæœ¬éƒ½ä¼šè¶…æ—¶ä¸‰å››åç§’ï¼Œæ‰€ä»¥å»¶é•¿äº†ä¸€ç‚¹æµ‹è¯•æ—¶é—´ã€‚</p>
<blockquote>
<p>ç¬”è®°ä¸­åƒè¿™æ ·å¼•ç”¨çš„å¥å­ä¸ºè¯¾ç¨‹ä¸­çš„åŸæ–‡ã€‚</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/sev1n75/xv6-riscv">ğŸ”— æˆ‘çš„ Lab ä»£ç é“¾æ¥</a><br><a target="_blank" rel="noopener" href="https://www.zhihu.com/column/c_1294282919087964160">ğŸ”—ã€çŸ¥ä¹-è‚–å®è¾‰ã€‘MIT6.S081 æ“ä½œç³»ç»Ÿå·¥ç¨‹ä¸­æ–‡ç¿»è¯‘</a></p>
<h2 id="1-Lab-util-ç›¸å…³"><a href="#1-Lab-util-ç›¸å…³" class="headerlink" title="| 1 | Lab util ç›¸å…³"></a>| 1 | Lab util ç›¸å…³</h2><h3 id="1-1-LEC-1-amp-Chapter-1-note"><a href="#1-1-LEC-1-amp-Chapter-1-note" class="headerlink" title="| 1.1 | LEC 1  &amp; Chapter 1 note"></a>| 1.1 | LEC 1  &amp; Chapter 1 note</h3><ul>
<li><p>exec</p>
<img alt="å›¾ 0" src="/images/image-20240215105112.png" />  
</li>
<li><p>redirect</p>
<img alt="redirect" src="/images/image-20240215105920.png" />  

<ul>
<li><p><code>cat &lt; input.txt</code></p>
<img alt="å›¾ 5" src="/images/image-20240215025128.png" /></li>
</ul>
<blockquote>
<p>The <code>2&gt;&amp;1</code> tells the shell to give the command a file descriptor 2 that is a duplicate of descriptor 1</p>
</blockquote>
</li>
<li><p>pipe</p>
<img alt="å›¾ 2" src="/images/image-20240215110731.png" />  

<img alt="å›¾ 3" src="/images/image-20240215111726.png" />  

<p>åœ¨ <code>fork</code> ä¹‹å‰åˆ›å»º  <code>pipe</code> ç„¶åæŠŠ <code>ls</code> çš„ <code>stdout(1)</code> æ¢æˆ <code>pipefd[1]</code>; <code>grep</code> çš„ <code>stdin(0)</code> æ¢æˆ <code>pipefd[0]</code> ã€‚</p>
</li>
<li><p>File System</p>
<ul>
<li><p>list</p>
<img alt="å›¾ 4" src="/images/image-20240215112407.png" />  
</li>
<li><p>a file</p>
<img alt="å›¾ 6" src="/images/image-20240215031307.png" />  

<blockquote>
<p>The fileâ€™s <strong>inode and the disk space</strong> holding its content are only <strong>freed</strong> when the fileâ€™s link count is zero <strong>and</strong> no file descriptors refer to it.</p>
</blockquote>
</li>
<li><p>cd</p>
<img alt="å›¾ 7" src="/images/image-20240215032040.png" /></li>
</ul>
</li>
</ul>
<h3 id="1-2-LEC-2-note"><a href="#1-2-LEC-2-note" class="headerlink" title="| 1.2 | LEC 2 note"></a>| 1.2 | LEC 2 note</h3><ul>
<li><p>Use GNU debugger</p>
<ul>
<li><p>Conditional breakpoints</p>
<blockquote>
<p><code>break &lt;location&gt; if &lt;condition&gt;</code> sets a breakpoint at the specified location, but only breaks if the condition is satisfied.</p>
<p><code>cond &lt;number&gt; &lt;condition&gt;</code> adds a condition on an existing breakpoint.</p>
</blockquote>
</li>
<li><p>Watchpoints</p>
<blockquote>
<p><code>watch &lt;expression&gt;</code> will stop execution whenever the expressionâ€™s value changes.</p>
<p><code>watch -l &lt;address&gt;</code> will stop execution whenever the contents of the specified memory address change.</p>
<p>Whatâ€™s the difference between wa var and wa -l &amp;var?</p>
<p><code>rwatch [-l] &lt;expression&gt;</code> will stop execution whenever the value of the expression is read.</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h3 id="1-3-Lab-Xv6-and-Unix-utilities"><a href="#1-3-Lab-Xv6-and-Unix-utilities" class="headerlink" title="| 1.3 | Lab: Xv6 and Unix utilities"></a>| 1.3 | <u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/labs/util.html">Lab: Xv6 and Unix utilities</a></u></h3><blockquote>
<p>This lab will familiarize you with xv6 and its system calls.</p>
</blockquote>
<p>ğŸ“Œ <u><a target="_blank" rel="noopener" href="https://github.com/sev1n75/xv6-riscv/commit/591607a62b87f80b279ba7f85bfa7e75f1827af6">Lab 1 ä»£ç åœ¨è¿™é‡Œ</a></u></p>
<h4 id="1-3-1-Boot-xv6-easy"><a href="#1-3-1-Boot-xv6-easy" class="headerlink" title="| 1.3.1 | Boot xv6 (easy)"></a>| 1.3.1 | Boot xv6 (easy)</h4><ul>
<li><p><code>sudo apt-get install qemu-system-misc=1:4.2-3ubuntu6</code> å¤±è´¥</p>
<p>å‚è€ƒä¸‹é¢çš„æ‰‹åŠ¨ç¼–è¯‘æ–¹æ³•ç¼–è¯‘ qemu</p>
<ul>
<li>è¡¥å……ï¼š <code>sudo apt-get install libpixman-1-dev</code> å®‰è£… pixman devel packag</li>
</ul>
</li>
</ul>
<img alt="å›¾ 9" src="/images/image-20240215045015.png" style="zoom:60%" />  

<h4 id="1-3-2-sleep-easy"><a href="#1-3-2-sleep-easy" class="headerlink" title="| 1.3.2 | sleep (easy)"></a>| 1.3.2 | sleep (easy)</h4><img alt="å›¾ 10" src="/images/image-20240215075032.png" />  

<h4 id="1-3-3-pingpong-easy"><a href="#1-3-3-pingpong-easy" class="headerlink" title="| 1.3.3 | pingpong (easy)"></a>| 1.3.3 | pingpong (easy)</h4><p>ä¸ºäº†é˜»æ­¢çˆ¶è¿›ç¨‹åœ¨å‘ç®¡é“å†™äº†æ•°æ®åç«‹åˆ»æŠŠæ•°æ®è¯»å‡ºæ¥ï¼Œä½¿å¾—å­è¿›ç¨‹ä¸èƒ½è¯»åˆ°æ•°æ®ï¼Œå¯ä»¥åœ¨çˆ¶è¿›ç¨‹è°ƒç”¨ <code>write(pipefds[1], &quot;c&quot;, 1);</code> åæ¥ç€è°ƒç”¨ <code>sleep</code> ã€‚</p>
<img alt="å›¾ 11" src="/images/image-20240215083157.png" />  

<h4 id="1-3-4-primes-moderate-x2F-hard"><a href="#1-3-4-primes-moderate-x2F-hard" class="headerlink" title="| 1.3.4 | primes (moderate)&#x2F;(hard)"></a>| 1.3.4 | primes (moderate)&#x2F;(hard)</h4><img alt="å›¾ 12" src="/images/image-20240215100148.png" />  

<h4 id="1-3-5-find-moderate-amp-xargs-moderate"><a href="#1-3-5-find-moderate-amp-xargs-moderate" class="headerlink" title="| 1.3.5 | find (moderate) &amp; xargs (moderate)"></a>| 1.3.5 | find (moderate) &amp; xargs (moderate)</h4><blockquote>
<p>åè¡¥</p>
</blockquote>
<h2 id="2-Lab-syscall-ç›¸å…³"><a href="#2-Lab-syscall-ç›¸å…³" class="headerlink" title="| 2 | Lab syscall ç›¸å…³"></a>| 2 | Lab syscall ç›¸å…³</h2><h3 id="2-1-Chapter-2-note-amp-LEC-3-note"><a href="#2-1-Chapter-2-note-amp-LEC-3-note" class="headerlink" title="| 2.1 | Chapter 2 note &amp; LEC 3 note"></a>| 2.1 | Chapter 2 note &amp; LEC 3 note</h3><blockquote>
<p>Thus an operating system must fulfill three requirements: <strong>multiplexing</strong>, <strong>isolation</strong>, and <strong>interaction</strong>.</p>
</blockquote>
<p>Multiplexing å¤šè·¯å¤ç”¨ï¼Œä¹Ÿå°±æ˜¯åˆ†æ—¶(time-sharing)ï¼Œé˜²æ­¢æŸä¸ªè¿›ç¨‹æŒç»­å æœ‰ CPUã€‚</p>
<p>Isolation éš”ç¦»ï¼Œä¸ºå‡å°‘æŸäº›ä¸å—ä¿¡ä»»çš„åº”ç”¨å¯¹å…¶ä»–çš„å½±å“ã€‚</p>
<p>Interaction äº¤äº’ï¼Œä¸ºå®ç°è¿›ç¨‹ä¹‹é—´çš„ä¿¡æ¯äº¤äº’ï¼Œå®ç°æ›´å¤æ‚çš„åŠŸèƒ½ã€‚</p>
<h4 id="2-1-1-Abstracting-physical-resources"><a href="#2-1-1-Abstracting-physical-resources" class="headerlink" title="| 2.1.1 | Abstracting physical resources"></a>| 2.1.1 | Abstracting physical resources</h4><blockquote>
<p>To achieve strong <strong>isolation</strong> itâ€™s helpful to forbid applications from directly accessing sensitive hardware resources, and instead to <u>abstract the resources into services.</u></p>
<p>Unix <u>transparently switches hardware CPUs among processes</u>, saving and restor- ing register state as necessary</p>
<p>Many forms of <strong>interaction</strong> among Unix processes occur <u>via file descriptors</u>.</p>
</blockquote>
<h4 id="2-1-2-User-mode-supervisor-mode-and-system-calls"><a href="#2-1-2-User-mode-supervisor-mode-and-system-calls" class="headerlink" title="| 2.1.2 | User mode, supervisor mode, and system calls"></a>| 2.1.2 | User mode, supervisor mode, and system calls</h4><blockquote>
<p><strong>RISC-V</strong> has three modes in which the CPU can execute instructions: <strong><i>machine mode, supervisor mode, and user mode</i></strong>.</p>
<p>An application can execute only user-mode instructions is said to be running in <i>user space</i>.</p>
<p>The software in supervisor mode can also execute privileged instructions and is said to be running in <i>kernel space</i>.</p>
<p>The software running in <i>kernel space </i>(or in supervisor mode) is called the <i>kernel</i>.</p>
<p>CPUs provide a special instruction that switches the CPU <u>from user mode to supervisor mode</u> and enters the kernel at an entry point specified <u>by the kernel</u>. (RISC-V provides the <code>ecall</code> instruction)</p>
</blockquote>
<h4 id="2-1-3-Kernel-organization"><a href="#2-1-3-Kernel-organization" class="headerlink" title="| 2.1.3 | Kernel organization"></a>| 2.1.3 | Kernel organization</h4><blockquote>
<p><strong>monolithic kernel</strong>: entire operating system resides in the kernel</p>
</blockquote>
<p>åœ¨å®å†…æ ¸(monolithie kernel)æƒ…å†µä¸‹ï¼Œå†…æ ¸ç­‰äºæ“ä½œç³»ç»Ÿã€‚</p>
<blockquote>
<p>bad: <u>no isolation</u> within (subsystems)</p>
</blockquote>
<p>å¾®å†…æ ¸(microkernel)æš‚æ—¶ä¸è€ƒè™‘ã€‚</p>
<h4 id="2-1-4-Process-overview"><a href="#2-1-4-Process-overview" class="headerlink" title="| 2.1.4 | Process overview"></a>| 2.1.4 | Process overview</h4><blockquote>
<p>The unit of <strong>isolation</strong> in Unix is a <strong>process</strong>.</p>
</blockquote>
<p>éš”ç¦»åŒ…æ‹¬è¿›ç¨‹(processes)ä¹‹é—´çš„éš”ç¦»ï¼Œä»¥åŠè¿›ç¨‹å’Œå†…æ ¸ä¹‹é—´çš„éš”ç¦»ã€‚</p>
<p>è¿›ç¨‹æä¾›äº†ä¸€ä¸ª<strong>çœ‹ä¸Šå»ç§æœ‰</strong>çš„å†…å­˜ç©ºé—´å³åœ°å€ç©ºé—´(address space)ã€‚</p>
<p>åœ°å€ç©ºé—´é€šè¿‡é¡µè¡¨(<strong>page tables</strong>)å®ç°ã€‚</p>
<h4 id="2-1-5-Code-starting-xv6-and-the-first-process"><a href="#2-1-5-Code-starting-xv6-and-the-first-process" class="headerlink" title="| 2.1.5 | Code: starting xv6 and the first process"></a>| 2.1.5 | Code: starting xv6 and the first process</h4><p><code>_entry</code> -&gt; <code>start</code> -&gt; <code>main</code> -&gt; <code>userinit</code> -&gt; <code>/init</code></p>
<h3 id="2-2-Lab-system-calls"><a href="#2-2-Lab-system-calls" class="headerlink" title="| 2.2 | Lab: system calls"></a>| 2.2 | <u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/labs/syscall.html">Lab: system calls</a></u></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sev1n@ubuntu2204 ~/f/6/xv6-labs-2020&gt; ./grade-lab-syscall                                                     syscall!?</span><br><span class="line">make: <span class="string">&#x27;kernel/kernel&#x27;</span> is up to <span class="built_in">date</span>.</span><br><span class="line">== Test trace 32 grep == trace 32 grep: OK (1.4s)</span><br><span class="line">== Test trace all grep == trace all grep: OK (1.1s)</span><br><span class="line">== Test trace nothing == trace nothing: OK (0.9s)</span><br><span class="line">== Test trace children == trace children: OK (16.6s)</span><br><span class="line">== Test sysinfotest == sysinfotest: OK (2.8s)</span><br><span class="line">== Test time ==</span><br><span class="line">time: OK</span><br><span class="line">Score: 35/35</span><br></pre></td></tr></table></figure>

<h4 id="2-2-1-System-call-tracing-moderate"><a href="#2-2-1-System-call-tracing-moderate" class="headerlink" title="| 2.2.1 | System call tracing (moderate)"></a>| 2.2.1 | System call tracing (moderate)</h4><p>æ³¨æ„ <code>sys_trace</code> æˆåŠŸæ—¶è¿”å›å€¼ä¸º 0</p>
<p>ğŸ“Œ <u><a target="_blank" rel="noopener" href="https://github.com/sev1n75/xv6-riscv/commit/591607a62b87f80b279ba7f85bfa7e75f1827af6">è¿™éƒ¨åˆ†ä»£ç åœ¨è¿™é‡Œ</a></u> (æ²¡æ³¨æ„æŠŠ <code>.gdb_history</code> æäº¤äº†)</p>
<h4 id="2-2-2-Sysinfo-moderate"><a href="#2-2-2-Sysinfo-moderate" class="headerlink" title="| 2.2.2 | Sysinfo (moderate)"></a>| 2.2.2 | Sysinfo (moderate)</h4><ul>
<li><p>xv6 çš„å†…å­˜ç®¡ç†æœºåˆ¶</p>
<p>é€šè¿‡å•é“¾è¡¨ <code>freelist</code> è¿æ¥æ‰€æœ‰é—²ç½®çš„ PAGEï¼Œæ¯æ¬¡ä»å¤´(<code>kmem-&gt;freelist</code>)å­˜å–</p>
</li>
</ul>
<p>ğŸ“Œ <u><a target="_blank" rel="noopener" href="https://github.com/sev1n75/xv6-riscv/commit/506f6ce82c51384bfd4e010d7080b9d1784c9d03">è¿™éƒ¨åˆ†ä»£ç åœ¨è¿™é‡Œ</a></u></p>
<h2 id="3-Lab-pgtbl-ç›¸å…³"><a href="#3-Lab-pgtbl-ç›¸å…³" class="headerlink" title="| 3 | Lab pgtbl ç›¸å…³"></a>| 3 | Lab pgtbl ç›¸å…³</h2><h3 id="3-1-Chapter-3-amp-LEC-4-note"><a href="#3-1-Chapter-3-amp-LEC-4-note" class="headerlink" title="| 3.1 | Chapter 3 &amp; LEC 4 note"></a>| 3.1 | Chapter 3 &amp; LEC 4 note</h3><h4 id="3-1-1-Paging-hardware"><a href="#3-1-1-Paging-hardware" class="headerlink" title="| 3.1.1 | Paging hardware"></a>| 3.1.1 | Paging hardware</h4><img alt="å›¾ 0" src="/images/image-20240306030218.png" />  

<blockquote>
<p><code>PTE_U</code> controls whether instructions in <u>user mode are allowed to access the page</u>;</p>
</blockquote>
<p><code>satp</code> å¯„å­˜å™¨ä¿å­˜ l2 é¡µè¡¨çš„<strong>ç‰©ç†åœ°å€</strong></p>
<p>è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„ç¿»è¯‘è¿‡ç¨‹ï¼š</p>
<ul>
<li>å½“å‰è¿›ç¨‹çš„ <code>satp</code> å¯„å­˜å™¨æ‰¾åˆ° l2 é¡µè¡¨ç‰©ç†åœ°å€</li>
<li>é€šè¿‡ l2 çš„ 9 æ¯”ç‰¹(bits å’Œ 2^9&#x3D;512 ä¸ª PTE ä¸€ä¸€å¯¹åº”)æ‰¾åˆ°å¯¹åº”çš„ 44 æ¯”ç‰¹ PPNã€‚<ul>
<li><code>l2_pte = l2_pgtbl[PX(2, va)]</code></li>
</ul>
</li>
<li>é€šè¿‡ l2 PPN æ‰¾åˆ° l1 é¡µè¡¨çš„ç‰©ç†åœ°å€ã€‚<ul>
<li><code>l1_pgtbl = PTE2PA(l2_pte)</code></li>
</ul>
</li>
<li>é€šè¿‡ l1 çš„ 9 æ¯”ç‰¹æ‰¾åˆ° l0 é¡µè¡¨çš„ç‰©ç†åœ°å€ã€‚<ul>
<li><code>l0_pgtbl = PTE2PA(l1_pgtbl[PX(1, va)])</code></li>
</ul>
</li>
<li>é€šè¿‡ l0 çš„ 9 æ¯”ç‰¹æ‰¾åˆ°å¯¹åº”é¡µçš„ç‰©ç†åœ°å€(A)ã€‚<ul>
<li><code>l0_pte = l0_pgtbl[PX(0, va)]</code></li>
</ul>
</li>
<li>å¾—åˆ°æœ€ç»ˆç‰©ç†åœ°å€<ul>
<li><code>pa = PTE2PA(l0_pte) | (va &amp; PGSHIFT)</code></li>
</ul>
</li>
</ul>
<p>ä¸ºä»€ä¹ˆå¤šçº§é¡µè¡¨å¯ä»¥èŠ‚çœå†…å­˜ï¼Ÿ</p>
<ul>
<li>ä½¿ç”¨å¤šçº§é¡µè¡¨ï¼Œç¨‹åºä¸€å¼€å§‹åªéœ€è¦ä¸‰ä¸ªé¡µè¡¨(3*512 PGSIZE)ï¼Œl2,l1 é¡µè¡¨å†…éƒ½åªæœ‰ä¸€ä¸ªé¡µè¡¨é¡¹(pte)ï¼Œå…¶ä»–ç©ºä½™çš„ä½ç½®ä¸éœ€è¦åˆ†é…é¡µè¡¨é¡¹ï¼Œç­‰éœ€è¦çš„æ—¶å€™å†åˆ†é…ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/riscv.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGSIZE 4096 <span class="comment">// bytes per page</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGSHIFT 12  <span class="comment">// bits of offset **within** a page</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGROUNDUP(sz)  (((sz)+PGSIZE-1) &amp; ~(PGSIZE-1))  <span class="comment">// å‘ä¸Šå–æ•´å¯¹å…¶ä¸€é¡µ</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PGROUNDDOWN(a) (((a)) &amp; ~(PGSIZE-1))  <span class="comment">// å‘ä¸‹å–æ•´å¯¹å…¶</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_V (1L &lt;&lt; 0) <span class="comment">// valid</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_R (1L &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_W (1L &lt;&lt; 2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_X (1L &lt;&lt; 3)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_U (1L <span class="string">&lt;&lt; 4) // 1 -&gt;</span> user can access</span></span><br><span class="line"><span class="comment">// åªç”¨äº†è¿™å‡ ä¸ª bit</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// shift a physical address to the right place for a PTE.</span></span><br><span class="line"><span class="comment">// 12 å³ PGSHIFTï¼Œ10 æ˜¯å› ä¸ºä½ 10 bit æ˜¯ Flags</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PA2PTE(pa) ((((uint64)pa) &gt;&gt; 12) &lt;&lt; 10)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE2PA(pte) (((pte) &gt;&gt; 10) &lt;&lt; 12)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 0x3FF 10 bits</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_FLAGS(pte) ((pte) &amp; 0x3FF)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// extract the three 9-bit page table indices from a virtual address.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PXMASK          0x1FF <span class="comment">// 9 bits</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PXSHIFT(level)  (PGSHIFT+(9*(level)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PX(level, va) ((((uint64) (va)) &gt;&gt; PXSHIFT(level)) &amp; PXMASK)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// one beyond the highest possible virtual address.</span></span><br><span class="line"><span class="comment">// MAXVA is actually one bit less than the max allowed by</span></span><br><span class="line"><span class="comment">// Sv39, to avoid having to sign-extend virtual addresses</span></span><br><span class="line"><span class="comment">// that have the high bit set.</span></span><br><span class="line"><span class="comment">// å³æœ€é«˜æœ‰æ•ˆä½</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXVA (1L &lt;&lt; (9 + 9 + 9 + 12 - 1))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> uint64 <span class="type">pte_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> uint64 *<span class="type">pagetable_t</span>; <span class="comment">// 512 PTEs</span></span><br><span class="line"><span class="keyword">typedef</span> uint64 *<span class="type">pagetable_t</span>; <span class="comment">// 512 PTEs 0~2^9</span></span><br></pre></td></tr></table></figure>

<h4 id="3-1-2-Kernel-address-space"><a href="#3-1-2-Kernel-address-space" class="headerlink" title="| 3.1.2 | Kernel address space"></a>| 3.1.2 | Kernel address space</h4><img alt="å›¾ 1" src="/images/image-20240306080809.png" />  

<h4 id="3-1-3-Code-creating-an-address-space"><a href="#3-1-3-Code-creating-an-address-space" class="headerlink" title="| 3.1.3 | Code: creating an address space"></a>| 3.1.3 | Code: creating an address space</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kinit-&gt;kvminit-&gt;kvminithart-&gt;procinit</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kinit</code> æŠŠå†…æ ¸æ•°æ®æ®µç»“æŸ(.data)åˆ°å®šä¹‰çš„ <code>PHYSTOP</code> ä¹‹é—´çš„åœ°å€åˆ†é¡µï¼Œç»„ç»‡åˆ° <code>freelist</code> é“¾è¡¨é‡Œã€‚</li>
<li><code>kvminit</code><ul>
<li>é¦–å…ˆè°ƒç”¨ <code>kalloc</code> åˆ†é…ä¸€é¡µ ä½œä¸ºå†…æ ¸é¡µè¡¨(kernel_pagetable)ã€‚</li>
<li>è°ƒç”¨ <code>kvmmap</code> æ˜ å°„ä¸Šä¸€èŠ‚(3.1.2)çš„åœ°å€</li>
<li><code>kvmmap</code> è°ƒç”¨ <code>mappages(kernel_pagetable, va, sz, pa, perm)</code></li>
<li><code>mappages</code> è°ƒç”¨ <code>pte = walk(pagetable, a, 1)</code> æŠŠè™šæ‹Ÿåœ°å€ <code>va</code> æ˜ å°„åˆ°å†…æ ¸é¡µè¡¨ã€‚</li>
</ul>
</li>
<li><code>kvminithart</code> è®¾ç½® <code>satp</code> å¯„å­˜å™¨å¹¶æ¸…ç©º TLB ç¼“å­˜ã€‚</li>
<li><code>procinit</code><ul>
<li>è°ƒç”¨ <code>kvmmap</code> ç»™ <code>KSTACK</code> å®è®¡ç®—å‡ºæ¥çš„å†…æ ¸æ ˆè™šæ‹Ÿåœ°å€æ˜ å°„ç‰©ç†åœ°å€ã€‚</li>
<li>è°ƒç”¨ <code>kvminithart</code></li>
</ul>
</li>
</ul>
<p>æ³¨æ„ï¼š</p>
<ul>
<li><code>kalloc</code> åˆ†é…çš„ä¸€é¡µå¯ä»¥ä½œä¸ºä¸€ä¸ªé¡µè¡¨ã€‚å› ä¸º <code>PAGESIZE</code> æ˜¯ 4096B ä¹Ÿå°±æ˜¯ 8*512Bï¼Œé¡µè¡¨é¡¹åªç”¨äº† 54 bit ä¸åˆ° 8Bï¼Œæ‰€ä»¥æ˜¯å¤Ÿçš„ã€‚</li>
<li><code>procinit</code> æœ€åè¿˜è¦å†è°ƒç”¨ä¸€æ¬¡ <code>kvminithart</code> å› ä¸ºâ€å½“å†…æ ¸ä¿®æ”¹é¡µè¡¨æ—¶ï¼Œå®ƒéœ€è¦é€šçŸ¥ç¡¬ä»¶å…³äºè¿™äº›å˜åŒ–ï¼Œä»¥ä¾¿å¤„ç†å™¨èƒ½å¤Ÿä½¿ç”¨æœ€æ–°çš„é¡µè¡¨è¿›è¡Œåœ°å€è½¬æ¢ã€‚â€ (by chatGPT)ã€‚å­˜ç–‘ï¼Ÿ</li>
</ul>
<h4 id="3-1-4-Code-exec"><a href="#3-1-4-Code-exec" class="headerlink" title="| 3.1.4 | Code: exec"></a>| 3.1.4 | Code: exec</h4><p>æŠŠå­˜åœ¨æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ª<strong>æ–‡ä»¶</strong>åŠ è½½åˆ°å†…å­˜åŒæ—¶åˆå§‹åŒ–<strong>ç”¨æˆ·åœ°å€ç©ºé—´(address space)</strong></p>
<p>åœ¨æ£€æŸ¥å®Œæ–‡ä»¶æ ¼å¼å <code>exec</code> ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„é¡µè¡¨ ï¼Œç»™æ¯ä¸ª ELF æ®µ(segment) åˆ†é…å¹¶åŠ è½½åˆ°å†…å­˜ã€‚</p>
<blockquote>
<p><code>Exec</code> <u><strong>allocates</strong> a <strong>new page table</strong> with no user mappings</u> with <code>proc_pagetable</code>, <u><strong>allocates</strong> memory for each ELF <strong>segment</strong></u> with <code>uvmalloc</code>, and <u><strong>loads</strong> each segment into memory</u> with <code>loadseg</code>. <code>loadseg</code> uses <code>walkaddr</code> to find the physical address of the allocated memory at which to write each page of the ELF segment, and <code>readi</code> to read from the file.</p>
</blockquote>
<p>ç»™ç”¨æˆ·æ ˆ(ustack)åˆ†é…ä¸€é¡µç„¶ååˆå§‹åŒ–ã€‚</p>
<blockquote>
<p><code>Exec</code> <strong>copies</strong> the argument strings to the <strong>top</strong> of the stack one at a time, recording the pointers to them in <code>ustack</code>. It places a null pointer at the end of what will be the <code>argv</code> list passed to <code>main</code>. The first three entries in <code>ustack</code> are the <strong>fake return program counter</strong>, <code>argc</code> and <code>argv</code> pointer.</p>
</blockquote>
<p>åˆ†é…ä¸€ä¸ª <em>guard page</em> åœ¨ <code>ustack</code> çš„ä¸Šæ–¹ã€‚</p>
<img alt="å›¾ 0" src="/images/image-20240315041134.png" />

<h3 id="3-2-LEC-5-note"><a href="#3-2-LEC-5-note" class="headerlink" title="| 3.2 | LEC 5 note"></a>| 3.2 | LEC 5 note</h3><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">reg    | name  | saver  | description</span><br><span class="line">-------+-------+--------+------------</span><br><span class="line">x0     | zero  |        | hardwired zero</span><br><span class="line">x1     | ra    | caller | return address</span><br><span class="line">x2     | sp    | callee | stack pointer</span><br><span class="line">x3     | gp    |        | global pointer</span><br><span class="line">x4     | tp    |        | thread pointer</span><br><span class="line">x5-7   | t0-2  | caller | temporary registers</span><br><span class="line">x8     | s0/fp | callee | saved register / frame pointer</span><br><span class="line">x9     | s1    | callee | saved register</span><br><span class="line">x10-11 | a0-1  | caller | function arguments / return values</span><br><span class="line">x12-17 | a2-7  | caller | function arguments</span><br><span class="line">x18-27 | s2-11 | callee | saved registers</span><br><span class="line">x28-31 | t3-6  | caller | temporary registers</span><br><span class="line">pc     |       |        | program counter</span><br></pre></td></tr></table></figure>

<h3 id="3-3-Lab-page-tables"><a href="#3-3-Lab-page-tables" class="headerlink" title="| 3.3 | Lab: page tables"></a>| 3.3 | <u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/labs/pgtbl.html">Lab: page tables</a></u></h3><img alt="å›¾ 1" src="/images/image-20240318031850.png" />

<h4 id="3-3-1-Print-a-page-table-easy"><a href="#3-3-1-Print-a-page-table-easy" class="headerlink" title="| 3.3.1 | Print a page table (easy)"></a>| 3.3.1 | Print a page table (easy)</h4><p>ğŸ“Œ <u><a target="_blank" rel="noopener" href="https://github.com/sev1n75/xv6-riscv/commit/1e2081b74e7c8ca53f7b61d7f2f2f97fbcd883ff">è¿™éƒ¨åˆ†ä»£ç åœ¨è¿™é‡Œ</a></u></p>
<h4 id="3-3-2-A-kernel-page-table-per-process-hard"><a href="#3-3-2-A-kernel-page-table-per-process-hard" class="headerlink" title="| 3.3.2 | A kernel page table per process (hard)"></a>| 3.3.2 | A kernel page table per process (hard)</h4><p>ä¸ºä»€ä¹ˆæ¯ä¸ªè¿›ç¨‹éƒ½éœ€è¦ä¸€ä¸ªå†…æ ¸é¡µè¡¨ï¼Ÿ</p>
<ul>
<li>ç”¨æˆ·æ€é¡µè¡¨ä½¿å¾—ç”¨æˆ·æ€å¯ä»¥ç›´æ¥è®¿é—®è™šæ‹Ÿåœ°å€(ç”±ç¡¬ä»¶æ¥ç¿»è¯‘)</li>
<li>ä½†æ˜¯å½“é™·å…¥å†…æ ¸æ€æ—¶ï¼Œå†…æ ¸çš„é¡µè¡¨æ²¡æœ‰ç”¨æˆ·æ€çš„è™šæ‹Ÿåœ°å€ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥è®¿é—®ç”¨æˆ·è™šæ‹Ÿåœ°å€</li>
<li>ä¸ºäº†è®¿é—®ç”¨æˆ·è™šæ‹Ÿåœ°å€ï¼Œxv6 é€šè¿‡ <code>walk</code> å‡½æ•°æŠŠæ¥è‡ªç”¨æˆ·æ€çš„è™šæ‹Ÿåœ°å€è½¬æ¢æˆå†…æ ¸å¯æ“ä½œçš„ç‰©ç†åœ°å€</li>
<li>å½“æ¯ä¸ªè¿›ç¨‹æœ‰è‡ªå·±çš„å†…æ ¸é¡µè¡¨æ—¶çš„æ—¶å€™ï¼ŒæŠŠ <code>satp</code> è®¾ç½®æˆå†…æ ¸é¡µè¡¨çš„åœ°å€å°±å¯ä»¥ç›´æ¥è®¿é—®ç”¨æˆ·æ€è™šæ‹Ÿåœ°å€äº†</li>
</ul>
<p>æ‰€ä»¥ <code>proc</code> ç»“æ„ä½“åœ¨åˆå§‹åŒ–æ—¶ï¼Œå¤šç»´æŠ¤ä¸€ä¸ª <code>kpagetable</code>ï¼Œé¦–å…ˆæ˜ å°„(map)å†…æ ¸ç©ºé—´ï¼Œç„¶åå½“ç”¨æˆ·é¡µè¡¨æ›´æ–°æ—¶ï¼ŒåŒæ—¶æ›´æ–°å†…æ ¸é¡µè¡¨ï¼›åœ¨åˆ‡æ¢è¿›ç¨‹æ—¶ä¹Ÿéœ€è¦åˆ‡æ¢å…¨å±€å†…æ ¸é¡µè¡¨(è°ƒåº¦å™¨å†…æ ¸é¡µè¡¨)ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„å‡ ç‚¹ï¼š</p>
<ul>
<li>æ¯ä¸ªè¿›ç¨‹åœ¨åˆ›å»ºæ—¶éƒ½éœ€è¦è®¾ç½®å¥½å†…æ ¸é¡µè¡¨ï¼ŒåŒ…å«ä¸€ä¸‹å‡ ç‚¹ï¼Œåˆ†é…å…¶ç©ºé—´(ä¸€é¡µ)ï¼Œæ˜ å°„å†…æ ¸åœ°å€ç©ºé—´ã€‚<ul>
<li>è¿›ç¨‹çš„åˆ›å»ºåœ¨ <code>allocproc()</code>ï¼Œå®ƒè¢« <code>userinit()</code> å’Œ <code>fork()</code> è°ƒç”¨ã€‚</li>
</ul>
</li>
<li>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰å†…æ ¸æ ˆ(kstack)ï¼Œåœ¨ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œæ‰€æœ‰çš„å†…æ ¸æ ˆéƒ½è¢« <code>procinit</code> æ˜ å°„åˆ°å…¨å±€çš„å†…æ ¸é¡µè¡¨ã€‚ç°åœ¨æ˜ å°„å†…æ ¸æ ˆéœ€è¦åœ¨åˆ†é…å¥½å†…æ ¸é¡µè¡¨ä¹‹åã€‚</li>
<li>è¿™ä¸€èŠ‚åªéœ€è¦ä¿æŒ <code>kpagetable</code> å’Œå…¨å±€å˜é‡<code>kernel_pagetable</code> ä¸€è‡´ï¼Œæ‰€ä»¥è¿˜è¦å†æŠŠå†…æ ¸æ ˆæ˜ å°„åˆ°å…¨å±€ <code>kernel_pagetable</code>ï¼Œä¸ç”¨åŒæ­¥æ›´æ–°å†…æ ¸é¡µè¡¨ã€‚</li>
</ul>
<p>é‡Šæ”¾å†…æ ¸é¡µè¡¨(å‚è€ƒ <code>proc_freepagetable</code>)</p>
<ul>
<li>æ¸…ç†å¶å­ç»“ç‚¹ã€‚</li>
<li>è°ƒç”¨ <code>freewalk</code> é‡Šæ”¾å ç”¨çš„ç‰©ç†é¡µæ¡†ã€‚</li>
</ul>
<p>ğŸ“Œ <u><a target="_blank" rel="noopener" href="https://github.com/sev1n75/xv6-riscv/commit/e908dc35eaa3db6ddbdaa8d6abcc1839aebd2465">è¿™éƒ¨åˆ†ä»£ç åœ¨è¿™é‡Œ</a></u></p>
<h4 id="3-3-3-Simplify-copyin-copyinstr-hard"><a href="#3-3-3-Simplify-copyin-copyinstr-hard" class="headerlink" title="| 3.3.3 | Simplify copyin/copyinstr (hard)"></a>| 3.3.3 | Simplify <code>copyin/copyinstr</code> (hard)</h4><p>ä¸ºäº†é˜²æ­¢ç”¨æˆ·åœ°å€ç©ºé—´å’Œå†…æ ¸åœ°å€ç©ºé—´é‡å æ‰€ä»¥éœ€è¦é™åˆ¶ç”¨æˆ·è™šæ‹Ÿåœ°å€ä¸Šé™æ˜¯ <code>0xC000000</code>ã€‚ä¸ºäº†å†…æ ¸é¡µè¡¨èƒ½è®¿é—®ç”¨æˆ·æ€è™šæ‹Ÿåœ°å€ï¼Œéœ€è¦ä¿æŒå†…æ ¸é¡µè¡¨å’Œç”¨æˆ·é¡µè¡¨åœ¨ç”¨æˆ·åœ°å€ç©ºé—´ä¸€è‡´ã€‚ä¹‹å‰çš„ <code>kernel_pagetable</code> æ˜ å°„äº† <code>CLINT</code>(0x2000000)ï¼Œå¦‚æœé™åˆ¶ <code>MAXUVA</code> æ˜¯ <code>CLINT</code> çš„è¯é€šè¿‡ä¸äº† <code>usertests sbrkmuch</code> æ‰€ä»¥å¯ä»¥ä¸ç”¨æ˜ å°„ <code>CLINT</code> ã€‚</p>
<p>ç”¨æˆ·é¡µè¡¨çš„åˆ›å»º&#x2F;æ›´æ–°è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>proc_pagetable()</code><ul>
<li>è°ƒç”¨ <code>uvmcreate()</code> è·å¾—ä¸€ä¸ªç‰©ç†é¡µæ¡†ã€‚</li>
<li>ç„¶å <code>mappages()</code> æ˜ å°„ <code>trampoline</code> ä»¥åŠ <code>trapframe</code>ã€‚</li>
</ul>
</li>
<li><code>fork()</code><ul>
<li>å…ˆè°ƒç”¨ <code>allocproc()</code> è·å¾—ä¸€ä¸ªåŸºæœ¬çš„ç”¨æˆ·é¡µè¡¨ã€‚</li>
<li>ç„¶å <code>uvmcopy()</code> å¤åˆ¶çˆ¶è¿›ç¨‹çš„é¡µè¡¨å³å¯ã€‚</li>
</ul>
</li>
<li><code>userint()</code><ul>
<li>åŒæ ·æ˜¯ <code>allocproc()</code> èµ·æ‰‹ã€‚</li>
<li>ç„¶åè°ƒç”¨ <code>uvminit</code> æŠŠ <code>initcode</code> æ˜ å°„åˆ° <code>va=0</code> çš„ä½ç½®ã€‚</li>
</ul>
</li>
<li><code>exec()</code> è§ <a href="#3-1-4-Code-exec">| 3.1.4 |</a></li>
<li><code>sbrk()</code><ul>
<li><code>growproc()</code> æ ¹æ®ä¼ å…¥å‚æ•°æ­£è´Ÿè°ƒç”¨<code>uvmalloc/uvmdealloc</code>ã€‚</li>
<li><code>uvmalloc()</code> ä»åŸæ¥çš„è™šæ‹Ÿåœ°å€å¾€ä¸Šåˆ†é…é¡µã€‚</li>
<li><code>uvmdealloc()</code> ä»åŸæ¥çš„è™šæ‹Ÿåœ°å€å¾€ä¸‹å‡å°‘é¡µã€‚</li>
</ul>
</li>
</ul>
<p>å†…æ ¸é¡µè¡¨åº”è¯¥<strong>åªå»ºç«‹ç›¸åŒæ˜ å°„</strong>ï¼Œ<strong>ä¸å†åˆ†é…å’Œé‡Šæ”¾ç‰©ç†å¸§</strong>ã€‚</p>
<p>ç”¨æˆ·é¡µè¡¨é‡Šæ”¾è¿‡ç¨‹:</p>
<ul>
<li><code>freeproc()</code> åœ¨ <code>proc_freepagetable()</code> çš„æ—¶å€™ä¹Ÿè¦å¯¹å†…æ ¸é¡µè¡¨åŒæ ·æ“ä½œã€‚</li>
<li><code>exec()</code> ä¼šé‡Šæ”¾åŸæ¥çš„ç”¨æˆ·é¡µè¡¨ã€‚</li>
<li>å› ä¸ºæœ‰ <code>kstack</code>, <code>kpagetable</code> åº”éšç€è¿›ç¨‹çš„åˆ›å»ºé‡Šæ”¾è€Œåˆ›å»ºé‡Šæ”¾ã€‚</li>
</ul>
<p>æ³¨æ„ï¼š</p>
<ul>
<li><p>é™åˆ¶ç”¨æˆ·åœ°å€ç©ºé—´ä¸è¶…è¿‡ï¼š</p>
<ul>
<li><p><code>p-&gt;sz</code> æ˜¯å½“å‰è¿›ç¨‹å ç”¨å†…å­˜å¤§å°ï¼Œé™åˆ¶å®ƒå³å¯ã€‚</p>
</li>
<li><p>å†™ <code>p-&gt;sz</code> çš„åœ°æ–¹åªæœ‰ä¸¤å¤„æ˜¯ç”¨å˜é‡èµ‹å€¼çš„åˆ†åˆ«æ˜¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exec.c:<span class="number">114</span>:<span class="number">3</span>:  p-&gt;sz = sz;</span><br><span class="line">proc.c:<span class="number">264</span>:<span class="number">3</span>:  p-&gt;sz = sz;  <span class="comment">// growproc</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸¤ä¸ª <code>sz</code> éƒ½æ˜¯ <code>uvmalloc()</code> çš„è¿”å›å€¼ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œé™åˆ¶å°±å¯ä»¥ã€‚</p>
</li>
</ul>
</li>
<li><p>å½“ <code>exec</code> <code>goto bad</code> çš„æ—¶å€™ï¼Œ<code>kpagetable</code> å¿…é¡»å’Œåˆšå¼€å§‹ä¸€æ ·ã€‚</p>
</li>
</ul>
<p><del>æ¢³ç†å®Œ user pagetable æœºåˆ¶ä¹‹åç»ˆäºæ˜¯æ¸…æ™°äº†å¾ˆå¤šï¼Œä½†æ˜¯ debug è¿˜æ˜¯ç—›è‹¦ä¸”æ¼«é•¿ã€‚åšå‡ºæ¥ä¹‹åè¿˜æ˜¯å¾ˆæœ‰æˆå°±æ„Ÿ(ç¬‘)</del></p>
<p>ğŸ“Œ <u><a target="_blank" rel="noopener" href="https://github.com/sev1n75/xv6-riscv/commit/816f857b41ae59e0379b98e1bba7cffcf393bcd4">è¿™éƒ¨åˆ†ä»£ç åœ¨è¿™é‡Œ</a></u></p>
<h2 id="4-Lab-trap-ç›¸å…³"><a href="#4-Lab-trap-ç›¸å…³" class="headerlink" title="| 4 | Lab trap ç›¸å…³"></a>| 4 | Lab trap ç›¸å…³</h2><h3 id="4-1-Chapter-4-amp-LEC-6-note"><a href="#4-1-Chapter-4-amp-LEC-6-note" class="headerlink" title="| 4.1 | Chapter 4 &amp; LEC 6 note"></a>| 4.1 | Chapter 4 &amp; LEC 6 note</h3><blockquote>
<p>There are <strong>three</strong> kinds of event which cause the CPU to set aside ordinary execution of instructions and <u>force a transfer of control to special code</u> that handles the event.</p>
</blockquote>
<ul>
<li>system call(<code>ecall</code>)</li>
<li><em>exception</em></li>
<li>device <em>interrupt</em></li>
</ul>
<p><del>ä¸ä¼šç¿»è¯‘ <em>trap</em> å°±ç›´æ¥å†™è‹±æ–‡äº†ã€‚</u></p>
<p>tarp åº”è¯¥æ˜¯ <strong>tansparent</strong>ï¼Œå°¤å…¶å¯¹äºä¸­æ–­ï¼Œå› å…¶éšæ—¶å¯èƒ½å‘ç”Ÿã€‚</p>
<blockquote>
<p>While commonality among the three trap types <u>suggests that a kernel could handle all traps with a <strong>single</strong> code path</u>, it turns out to be convenient to have <u>separate assembly vectors and C trap handlers</u> for <strong>three</strong> distinct cases: <u>traps from user space</u>, <u>traps from kernel space</u>, and <u>timer interrupts</u>.</p>
</blockquote>
<h4 id="4-1-1-RISC-V-trap-machinery"><a href="#4-1-1-RISC-V-trap-machinery" class="headerlink" title="| 4.1.1 | RISC-V trap machinery"></a>| 4.1.1 | RISC-V trap machinery</h4><blockquote>
<p>What does the CPUâ€™s â€œmodeâ€ protect?<br>i.e. what does switching mode from user to supervisor <strong>allow</strong>?<br>supervisor can <u>use CPU control registers:</u></p>
<ul>
<li>satp â€“ page table physical address</li>
<li>stvec â€“ ecall jumps here in kernel; points to trampoline</li>
<li>sepc â€“ ecall saves user pc here</li>
<li>sscratch â€“ address of trapframe</li>
<li>scause â€“ a number put by RISC-V that describes the reason for the trap</li>
<li>sstatus: supervisor status register</li>
<li>â€¦..</li>
</ul>
<p>supervisor can <u>use PTEs that have no PTE_U flag</u><br>but supervisor has <strong>no other powers!</strong> e.g.</p>
<ul>
<li><strong>canâ€™t</strong> use addresses that <u>arenâ€™t the in page table</u><br>so kernel has to carefully set things up so it can work</li>
</ul>
</blockquote>
<h4 id="4-1-2-Traps-from-user-space"><a href="#4-1-2-Traps-from-user-space" class="headerlink" title="| 4.1.2 | Traps from user space"></a>| 4.1.2 | Traps from user space</h4><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">preview:</span><br><span class="line">  write()                        write() returns              User</span><br><span class="line">  -----------------------------------------------------------------</span><br><span class="line">  uservec() in trampoline.S      userret() in trampoline.S   Kernel</span><br><span class="line">  usertrap() in trap.c           usertrapret() in trap.c</span><br><span class="line">  syscall() in syscall.c           ^</span><br><span class="line">  sys_write() in sysfile.c      ---|</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>ecall</code> did three things:</p>
<ul>
<li>change mode from user to supervisor</li>
<li><u>save <code>pc</code> in <code>sepc</code></u></li>
<li>jump to <code>stvec</code>(the kernel previously set <code>stvec</code>, before jumping to user space)</li>
</ul>
</blockquote>
<ul>
<li><p><code>uservec()</code>:</p>
<ul>
<li>ä¿å­˜ 32 ä¸ªç”¨æˆ·å¯„å­˜å™¨(ç”¨äºæ¢å¤)</li>
<li>åˆ‡æ¢åˆ°å†…æ ¸é¡µè¡¨, å†…æ ¸æ ˆ</li>
<li>è·³(jump)åˆ° <code>usertrap()</code></li>
</ul>
</li>
<li><p><code>usertrap()</code></p>
<ul>
<li>ä¿®æ”¹ <code>stvec = kernelvec</code></li>
<li>æ ¹æ® <code>scause</code> è°ƒç”¨ä¸åŒçš„å¤„ç†å‡½æ•°(handler)</li>
<li><code>usertrapret()</code></li>
</ul>
</li>
<li><p><code>usertrapret()</code></p>
<ul>
<li>è®¾ç½® <code>stvec = uservec</code></li>
<li>åœ¨ <em>trapframe</em> ä¸­ä¿å­˜ä»¥ä¸‹æœªåœ¨ <code>tampline.S</code> ä¿å­˜çš„å€¼, ä¹Ÿæ˜¯åˆå§‹åŒ–æ–°çš„ <em>trapframe</em> çš„åœ°æ–¹:<ul>
<li><code>kpagetable</code> æ‰€ä»¥ <code>uservec</code> å¯ä»¥åˆ‡æ¢</li>
<li><code>kstack</code> æ‰€ä»¥ <code>uservec</code> å¯ä»¥åˆ‡æ¢</li>
<li><code>hartid</code>, å¯èƒ½è¢«å…¶ä»– CPU è°ƒåº¦è¦æ›´æ–°</li>
<li><code>usertrap</code> åœ°å€ï¼Œè®© <code>uservec</code> æ‰¾å¾—åˆ°</li>
</ul>
</li>
<li>è®¾ç½® <code>sstatus</code> å¯„å­˜å™¨</li>
<li><u>è®¾ç½® <code>sepc = trapframe-&gt;epc</code></u></li>
</ul>
</li>
<li><p><code>userret()</code></p>
<ul>
<li>åˆ‡æ¢ <code>satp</code> &#x3D; ç”¨æˆ·é¡µè¡¨</li>
<li>æ¢å¤ 32 ä¸ª ç”¨æˆ·å¯„å­˜å™¨</li>
<li><code>sret</code></li>
</ul>
</li>
<li><p><code>sret</code></p>
<ul>
<li>set <code>sstatus</code> â€œprevious modeâ€ bit to user</li>
<li>æ¢å¤ <code>pc</code> &#x3D; <code>sepc</code></li>
</ul>
</li>
</ul>
<p>ä¸­æ–­çš„å¼€ä¸å…³ï¼š</p>
<blockquote>
<p>åè¡¥</p>
</blockquote>
<h4 id="4-1-3-Traps-from-kernel-space"><a href="#4-1-3-Traps-from-kernel-space" class="headerlink" title="| 4.1.3 | Traps from kernel space"></a>| 4.1.3 | Traps from kernel space</h4><ul>
<li><p><code>kernelvec</code></p>
<p>ä¿å­˜ 31 ä¸ªå¯„å­˜å™¨åˆ°å†…æ ¸æ ˆ</p>
<p>è°ƒç”¨ <code>kerneltrap</code></p>
<p>æ¢å¤å¯„å­˜å™¨</p>
<p><code>sret</code></p>
</li>
</ul>
<h3 id="4-2-Lab-traps"><a href="#4-2-Lab-traps" class="headerlink" title="| 4.2 | Lab: traps"></a>| 4.2 | <u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/labs/traps.html">Lab: traps</a></u></h3><img alt="å›¾ 2" src="/images/image-20240320063502.png" />

<h4 id="4-2-1-RISC-V-assembly-easy"><a href="#4-2-1-RISC-V-assembly-easy" class="headerlink" title="| 4.2.1 | RISC-V assembly (easy)"></a>| 4.2.1 | RISC-V assembly (easy)</h4><ol>
<li><p><code>a0~a7</code>, <code>a2</code> holds 13 when calling <code>printf</code> in main.</p>
</li>
<li><p><code>f</code> and <code>g</code> is called in compiler.</p>
</li>
<li><p><code>printf</code> is located at <code>0x628</code></p>
</li>
<li><p><code>ra</code> is 0x38</p>
</li>
<li><p>out put is â€œHE110 Woridâ€, if big-endian <code>i = 0x726c6400</code>. <code>57616</code> need not to be changed.</p>
</li>
<li><p>after â€œy&#x3D;â€, it will print <code>(int)$a2</code>, because the 2nd arguement of format strings is <code>a2</code>.</p>
</li>
</ol>
<h4 id="4-2-2-Backtrace-moderate"><a href="#4-2-2-Backtrace-moderate" class="headerlink" title="| 4.2.2 | Backtrace (moderate)"></a>| 4.2.2 | Backtrace (moderate)</h4><p><del>æäº¤è®°å½•æœ‰ç‚¹ä¹±ï¼Œå°±ç›´æ¥è´´ diff äº†</del></p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/kernel/defs.h b/kernel/defs.h</span></span><br><span class="line"><span class="comment">index 4b9bbc0..137c786 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/defs.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/defs.h</span></span><br><span class="line"><span class="meta">@@ -80,6 +80,7 @@</span> int             pipewrite(struct pipe*, uint64, int);</span><br><span class="line"> void            printf(char*, ...);</span><br><span class="line"> void            panic(char*) __attribute__((noreturn));</span><br><span class="line"> void            printfinit(void);</span><br><span class="line"><span class="addition">+void            backtrace(void);</span></span><br><span class="line"></span><br><span class="line"> // proc.c</span><br><span class="line"> int             cpuid(void);</span><br><span class="line"><span class="comment">diff --git a/kernel/printf.c b/kernel/printf.c</span></span><br><span class="line"><span class="comment">index e1347de..e9e1ccc 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/printf.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/printf.c</span></span><br><span class="line"><span class="meta">@@ -132,3 +132,15 @@</span> printfinit(void)</span><br><span class="line">   initlock(&amp;pr.lock, &quot;pr&quot;);</span><br><span class="line">   pr.locking = 1;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+void backtrace() &#123;</span></span><br><span class="line"><span class="addition">+  printf(&quot;backtrace:\n&quot;);</span></span><br><span class="line"><span class="addition">+  uint64 currfp = r_fp();</span></span><br><span class="line"><span class="addition">+  uint64 stack_top = PGROUNDUP(currfp);</span></span><br><span class="line"><span class="addition">+  while(currfp &lt;= stack_top) &#123;</span></span><br><span class="line"><span class="addition">+    printf(&quot;%p\n&quot;, *(uint64*)(currfp-8));</span></span><br><span class="line"><span class="addition">+    currfp = *(uint64*)(currfp-0x10);</span></span><br><span class="line"><span class="addition">+    if(*(uint64*)(currfp-8) &lt;= PLIC)</span></span><br><span class="line"><span class="addition">+      break;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="comment">diff --git a/kernel/riscv.h b/kernel/riscv.h</span></span><br><span class="line"><span class="comment">index 0aec003..7a443e9 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/riscv.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/riscv.h</span></span><br><span class="line"><span class="meta">@@ -311,6 +311,14 @@</span> r_ra()</span><br><span class="line">   return x;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="addition">+static inline uint64</span></span><br><span class="line"><span class="addition">+r_fp()</span></span><br><span class="line"><span class="addition">+&#123;</span></span><br><span class="line"><span class="addition">+  uint64 x;</span></span><br><span class="line"><span class="addition">+  asm volatile(&quot;mv %0, s0&quot; : &quot;=r&quot; (x) );</span></span><br><span class="line"><span class="addition">+  return x;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> // flush the TLB.</span><br><span class="line"> static inline void</span><br><span class="line"> sfence_vma()</span><br><span class="line"><span class="comment">diff --git a/kernel/sysproc.c b/kernel/sysproc.c</span></span><br><span class="line"><span class="comment">index e8bcda9..fd19d2a 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/sysproc.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/sysproc.c</span></span><br><span class="line"><span class="meta">@@ -70,6 +70,7 @@</span> sys_sleep(void)</span><br><span class="line">     sleep(&amp;ticks, &amp;tickslock);</span><br><span class="line">   &#125;</span><br><span class="line">   release(&amp;tickslock);</span><br><span class="line"><span class="addition">+  backtrace();</span></span><br><span class="line">   return 0;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-2-3-Alarm-hard"><a href="#4-2-3-Alarm-hard" class="headerlink" title="| 4.2.3 | Alarm (hard)"></a>| 4.2.3 | Alarm (hard)</h4><p>ğŸ“Œ <u><a target="_blank" rel="noopener" href="https://github.com/sev1n75/xv6-riscv/commit/85c1f6989b438b8d0d2ec2092c9ae7d182fe37cd">è¿™éƒ¨åˆ†ä»£ç åœ¨è¿™é‡Œ</a></u></p>
<h2 id="5-Lab-lazy-ç›¸å…³"><a href="#5-Lab-lazy-ç›¸å…³" class="headerlink" title="| 5 | Lab lazy ç›¸å…³"></a>| 5 | Lab lazy ç›¸å…³</h2><h3 id="5-1-Chapter-4-6-amp-LEC-8-note"><a href="#5-1-Chapter-4-6-amp-LEC-8-note" class="headerlink" title="| 5.1 | Chapter 4.6 &amp; LEC 8 note"></a>| 5.1 | Chapter 4.6 &amp; LEC 8 note</h3><blockquote>
<p>Key idea: <u>change page tables on page fault</u>, update page table instead of panic and <strong>restart</strong> instruction.</p>
</blockquote>
<blockquote>
<p><strong>Information</strong> we might need at page fault to do something interesting:</p>
<ol>
<li>The virtual address that caused the fault<br> See <code>stval</code> register; page faults set it to the fault address</li>
<li>The type of violation that caused the fault<br> See <code>scause</code> register value (instruction, load, and Store page fault)</li>
<li>The instruction and mode where the fault occurred</li>
</ol>
<ul>
<li>User IP: <code>tf-&gt;epc</code></li>
<li>U&#x2F;K mode: implicit in usertrap&#x2F;kerneltrap</li>
</ul>
</blockquote>
<h4 id="5-1-1-Lazy-Allocation"><a href="#5-1-1-Lazy-Allocation" class="headerlink" title="| 5.1.1 | Lazy Allocation"></a>| 5.1.1 | Lazy Allocation</h4><blockquote>
<p><code>sbrk</code> allocates memory that may <strong>never</strong> be used.</p>
</blockquote>
<blockquote>
<p>plan: allocate physical memory when application needs it</p>
<ul>
<li>Adjust <code>p-&gt;sz</code> on <code>sbrk</code>, but donâ€™t allocate.</li>
<li>When application uses that memory, it will result in page fault.</li>
<li>On pagefault allocate memory resume at the fault instruction.</li>
</ul>
</blockquote>
<p>é™¤æ­¤ä»¥å¤–ï¼Œåœ¨ <code>unmap</code> çš„æ—¶å€™ï¼Œå¯¹å»¶è¿Ÿåˆ†é…(<em>lazy allocation</em>) è¿˜æœªåˆ†é…çš„å†…å­˜åº”è¯¥ä¸å¤„ç†ï¼Œç»§ç»­å¾ªç¯ã€‚</p>
<h4 id="5-1-2-Copy-On-Write-COW-fork"><a href="#5-1-2-Copy-On-Write-COW-fork" class="headerlink" title="| 5.1.2 | Copy-On-Write (COW) fork"></a>| 5.1.2 | Copy-On-Write (COW) fork</h4><blockquote>
<p><a href="#6-Lab-cow-%E7%9B%B8%E5%85%B3">| 6.1 |</a></p>
</blockquote>
<h4 id="5-1-3-å…¶ä»–"><a href="#5-1-3-å…¶ä»–" class="headerlink" title="| 5.1.3 | å…¶ä»–"></a>| 5.1.3 | å…¶ä»–</h4><ul>
<li><p>Zero Fill Page</p>
<p><code>bss</code> æ®µ(segment) æœ€å¼€å§‹éƒ½æ˜¯ 0ï¼Œæ‰€ä»¥å¯æŠŠ bss è™šæ‹Ÿåœ°å€å…ˆæ˜ å°„åˆ°åŒä¸€é¡µä¸”åªè¯»ã€‚</p>
<p>å½“å‘ bss å†™æ—¶è§¦å‘ç¼ºé¡µé”™è¯¯(page fault)ï¼Œç„¶åå†è¯¥æ˜ å°„è™šæ‹Ÿåœ°å€å¯¹åº”é¡µã€‚</p>
</li>
<li><p>Demand Paging</p>
</li>
</ul>
<blockquote>
<p>idea: load pages from the file on demand.</p>
<ul>
<li>allocate page table entries, but mark them on-demand.</li>
<li>on fault, read the page in from the file and update page table entry.</li>
<li>need to keep some meta information(Virtual Memoroy Area) about where a page is located on disk.</li>
</ul>
</blockquote>
<ul>
<li>Paging From Disk</li>
</ul>
<blockquote>
<p>idea: store less-frequently used parts of the address space on disk.  page-in and page-out pages of the address address space transparently.</p>
</blockquote>
<ul>
<li><p>Memory-Mapped Files</p>
<p>æ”¾åœ¨ mmap lab è®¨è®º</p>
</li>
</ul>
<h3 id="5-2-Chapter-5-amp-LEC-9-note"><a href="#5-2-Chapter-5-amp-LEC-9-note" class="headerlink" title="| 5.2 | Chapter 5 &amp; LEC 9 note"></a>| 5.2 | Chapter 5 &amp; LEC 9 note</h3><ul>
<li><p><em>interrupts</em></p>
<blockquote>
<p>the interrupt tells the kernel the <strong>device hardware</strong> wants attention.</p>
</blockquote>
<blockquote>
<p>new issues:</p>
<ul>
<li>asynchronous: between <strong>running process</strong> and <strong>interrupt handler</strong></li>
<li>concurrency: <strong>device</strong> and <strong>process</strong> run in parallel</li>
<li>programming devices: device can be difficult to program</li>
</ul>
</blockquote>
</li>
<li><p>ä¸­æ–­çš„æ¥æº</p>
<p>device -&gt; PLIC(Platform Level Interupt Control) -&gt; CPU</p>
<p>å†…æ ¸é€šè¿‡å¯¹ PLIC ç¼–ç¨‹çµæ´»å¤„ç†ä¸­æ–­ã€‚</p>
</li>
<li><p>é©±åŠ¨(<em>driver</em>) è´Ÿè´£ç®¡ç†ç‰¹å®šçš„è®¾å¤‡ï¼š</p>
<blockquote>
<ul>
<li><p>configures the <strong>device hardware</strong>.</p>
</li>
<li><p>tells the device to perform <strong>operations</strong>.</p>
</li>
<li><p>handles the resulting <strong>interrupts</strong>.</p>
</li>
<li><p>interacts with <strong>processes</strong> that may be waiting for I&#x2F;O from the device.</p>
</li>
</ul>
</blockquote>
<blockquote>
<p>Many <strong>device drivers</strong> execute code in two contexts:</p>
<ul>
<li>a top half that runs in a processâ€™s kernel thread <u>called via system calls</u>.</li>
<li>a bottom half that executes at interrupt time as interrupt handler <u>handling device interupt</u>.</li>
</ul>
</blockquote>
</li>
</ul>
<h4 id="5-2-1-Code-Console-input-x2F-output"><a href="#5-2-1-Code-Console-input-x2F-output" class="headerlink" title="| 5.2.1 | Code: Console input&#x2F;output"></a>| 5.2.1 | Code: Console input&#x2F;output</h4><p>å½“ xv6 å¯åŠ¨æ—¶ï¼Œ<code>$</code> æ˜¯å¦‚ä½•è¢«æ‰“å°åˆ°å±å¹•ï¼Ÿ</p>
<p>å½“ç”¨æˆ·åœ¨é”®ç›˜æ•²ä¸‹ <code>ls\n</code> æ—¶ï¼Œå±å¹•æ˜¯å¦‚ä½•æ˜¾ç¤º <code>ls</code> ä»¥åŠ <code>ls</code> æ‰§è¡Œçš„å†…å®¹çš„ï¼Ÿ</p>
<p>æ¶‰åŠ <code>console/uart</code> çš„æ¢³ç†ï¼Œåè¡¥</p>
<h4 id="5-2-2-Timer-interrupts"><a href="#5-2-2-Timer-interrupts" class="headerlink" title="| 5.2.2 | Timer interrupts"></a>| 5.2.2 | Timer interrupts</h4><p>æ¶‰åŠ <code>mtvec/timervev/CLINT</code> åè¡¥</p>
<h3 id="5-3-Lab-xv6-lazy-page-allocation"><a href="#5-3-Lab-xv6-lazy-page-allocation" class="headerlink" title="| 5.3 | Lab: xv6 lazy page allocation"></a>| 5.3 | <u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/labs/lazy.html">Lab: xv6 lazy page allocation</a></u></h3><img alt="å›¾ 3" src="/images/image-20240321075130.png" />  

<img alt="å›¾ 4" src="/images/image-20240321075151.png" />  

<h4 id="5-3-1-Lazy-allocation-moderate-amp-amp-Lazytests-and-Usertests-moderate"><a href="#5-3-1-Lazy-allocation-moderate-amp-amp-Lazytests-and-Usertests-moderate" class="headerlink" title="| 5.3.1 | Lazy allocation (moderate) &amp;&amp; Lazytests and Usertests (moderate)"></a>| 5.3.1 | Lazy allocation (moderate) &amp;&amp; Lazytests and Usertests (moderate)</h4><ul>
<li><p><code>sbrk()</code> ä¸åˆ†é…ç‰©ç†å†…å­˜ï¼Œåªä¿®æ”¹ <code>p-&gt;sz</code></p>
</li>
<li><p>ä»€ä¹ˆæ—¶å€™åˆ†é…ï¼š</p>
<ul>
<li>ç”¨æˆ·è®¿é—®æ—¶è§¦å‘ç”¨æˆ·è§¦å‘ç¼ºé¡µå¼‚å¸¸æ—¶(usertrap-&gt;page fault)ï¼Œå†åˆ†é…</li>
<li>ç”¨æˆ·è¯»å†™ <code>sbrk()</code> è¿”å›çš„åœ°å€æ—¶ï¼Œç”±äº xv6 æ˜¯è½¯ä»¶å±‚é¢ <code>pa = walkaddr(va)</code>ï¼Œæ‰€ä»¥ æ­¤æ—¶ä¹Ÿéœ€è¦åˆ†é…ã€‚</li>
</ul>
</li>
<li><p>æ³¨æ„ ï¼š</p>
<ul>
<li><code>va = p-&gt;sz</code> çš„æ—¶å€™æ˜¯éæ³•çš„ã€‚</li>
<li>å¦‚æœ <code>sbrk(n) &lt; 0</code>, éœ€è¦ <code>sbrk()</code> é‡Šæ”¾(unmap) å‚è€ƒ <code>uvmdealloc()</code>ã€‚å¦åˆ™ <code>p-&gt;sz</code> å‡å°åï¼Œä¸Šé¢çš„è™šæ‹Ÿåœ°å€ æ²¡æœ‰ unmap ä¸”å·²ç»ä¸¢å¤±ã€‚</li>
</ul>
</li>
</ul>
<p>ğŸ“Œ <u><a target="_blank" rel="noopener" href="https://github.com/sev1n75/xv6-riscv/commit/80e58eb55b4417978ef982dc2fac847ae3c29b7b">è¿™éƒ¨åˆ†ä»£ç åœ¨è¿™é‡Œ</a></u></p>
<h2 id="6-Lab-cow-ç›¸å…³"><a href="#6-Lab-cow-ç›¸å…³" class="headerlink" title="| 6 | Lab cow ç›¸å…³"></a>| 6 | Lab cow ç›¸å…³</h2><blockquote>
<p>The goal of copy-on-write (COW) fork() is to <u>defer allocating and copying physical memory pages</u> for the child until the copies are <strong>actually needed</strong>, if ever.</p>
</blockquote>
<ul>
<li><code>uvmcopy()</code><ul>
<li><code>walk()</code> çˆ¶è¿›ç¨‹çš„é¡µè¡¨ï¼Œ <code>*pte &amp;= ~PTE_W</code>,<code>*pte |= PTE_C</code></li>
<li>æ˜ å°„åˆ°å­è¿›ç¨‹çš„é¡µè¡¨, å¼•ç”¨æ¬¡æ•°å¢åŠ (reference count ++);</li>
</ul>
</li>
<li><code>usertrap()</code><ul>
<li>åœ¨ç¼ºé¡µå¼‚å¸¸çš„æ—¶å€™ï¼Œè¯†åˆ«å‡º COW é¡µã€‚</li>
<li>åˆ†é…ç‰©ç†å†…å­˜, åˆ†é…å¤±è´¥åˆ™æ€æ­»(kill)ã€‚</li>
<li>å¤åˆ¶åŸæ•°æ®</li>
<li>ä¿®æ”¹é¡µè¡¨é¡¹(PTE) æŒ‡å‘æ–°çš„ç‰©ç†å¸§ä¸”å¯å†™ï¼ŒåŸé¡µçš„ <code>reference count--</code></li>
<li>é‡æ–°æ‰§è¡Œ</li>
</ul>
</li>
<li><code>proc_freepagetable()</code><ul>
<li>å¦‚æœæ˜¯ COW é¡µï¼Œ<code>--reference count == 0</code> åˆ™ é‡Šæ”¾</li>
</ul>
</li>
<li><code>reference count</code> å¦‚ä½•å®ç°<ul>
<li>NPROC &#x3D; 64ï¼Œå°äº 0xff</li>
<li>è®¡ç®— <code>freerange()</code> åˆ›å»ºäº†å¤šå°‘é¡µï¼Œç„¶åæ ¹æ®è¯¥æ•°é‡å‡å»å†…å­˜(è§ä¸‹é¢çš„ <code>kalloc.c-kinit()</code>)ã€‚</li>
<li><code>kvmmap()</code> çš„æ—¶å€™ä¸åº”è¯¥è®¾ç½® <code>ref count</code>ï¼Œå› ä¸ºå…¶æ˜¯è¡¨ç¤ºå½“å‰é¡µè¢«ç”¨æˆ·é¡µè¡¨å¼•ç”¨çš„æ•°é‡ã€‚</li>
<li><code>kalloc()</code> æ—¶ è®¾ç½® <code>cnt = 0</code></li>
<li><code>mappages()</code> çš„æ—¶å€™ï¼Œ<code>cnt++</code></li>
<li><code>uvmunmap()</code> ä¸” do_free æ—¶ <code>cnt--</code></li>
<li><code>cnt==1</code> åˆ™ä¿®æ”¹ pte å³å¯ã€‚</li>
</ul>
</li>
<li><code>copyout()</code><ul>
<li>å’Œ <code>usertap()</code> ç±»ä¼¼æ“ä½œ</li>
</ul>
</li>
</ul>
<h3 id="6-1-Lab-Copy-on-Write-Fork-for-xv6"><a href="#6-1-Lab-Copy-on-Write-Fork-for-xv6" class="headerlink" title="| 6.1 | Lab: Copy-on-Write Fork for xv6"></a>| 6.1 | <u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/labs/cow.html">Lab: Copy-on-Write Fork for xv6</a></u></h3><img alt="å›¾ 7" src="/images/image-20240324042818.png" />  

<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/kernel/defs.h b/kernel/defs.h</span></span><br><span class="line"><span class="comment">index 4b9bbc0..234b90d 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/defs.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/defs.h</span></span><br><span class="line"><span class="meta">@@ -63,6 +63,9 @@</span> void            ramdiskrw(struct buf*);</span><br><span class="line"> void*           kalloc(void);</span><br><span class="line"> void            kfree(void *);</span><br><span class="line"> void            kinit(void);</span><br><span class="line"><span class="addition">+void            inc_ref_cnt(uint64);</span></span><br><span class="line"><span class="addition">+uint8           get_ref_cnt(uint64);</span></span><br><span class="line"><span class="addition">+uint8           dec_ref_cnt(uint64);</span></span><br><span class="line"></span><br><span class="line"> // log.c</span><br><span class="line"> void            initlog(int, struct superblock*);</span><br><span class="line"><span class="meta">@@ -167,11 +170,13 @@</span> int             uvmcopy(pagetable_t, pagetable_t, uint64);</span><br><span class="line"> void            uvmfree(pagetable_t, uint64);</span><br><span class="line"> void            uvmunmap(pagetable_t, uint64, uint64, int);</span><br><span class="line"> void            uvmclear(pagetable_t, uint64);</span><br><span class="line"><span class="addition">+pte_t*          walkpte(pagetable_t pagetable, uint64 va);</span></span><br><span class="line"> uint64          walkaddr(pagetable_t, uint64);</span><br><span class="line"> int             copyout(pagetable_t, uint64, char *, uint64);</span><br><span class="line"> int             copyin(pagetable_t, char *, uint64, uint64);</span><br><span class="line"> int             copyinstr(pagetable_t, char *, uint64, uint64);</span><br><span class="line"></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> // plic.c</span><br><span class="line"> void            plicinit(void);</span><br><span class="line"> void            plicinithart(void);</span><br><span class="line"><span class="comment">diff --git a/kernel/kalloc.c b/kernel/kalloc.c</span></span><br><span class="line"><span class="comment">index fa6a0ac..8234080 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/kalloc.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/kalloc.c</span></span><br><span class="line"><span class="meta">@@ -14,6 +14,8 @@</span> void freerange(void *pa_start, void *pa_end);</span><br><span class="line"> extern char end[]; // first address after kernel.</span><br><span class="line">                    // defined by kernel.ld.</span><br><span class="line"></span><br><span class="line"><span class="addition">+uint8* phy_ref_cnt;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> struct run &#123;</span><br><span class="line">   struct run *next;</span><br><span class="line"> &#125;;</span><br><span class="line"><span class="meta">@@ -23,11 +25,42 @@</span> struct &#123;</span><br><span class="line">   struct run *freelist;</span><br><span class="line"> &#125; kmem;</span><br><span class="line"></span><br><span class="line"><span class="addition">+void inc_ref_cnt(uint64 pa) &#123;</span></span><br><span class="line"><span class="addition">+  acquire(&amp;kmem.lock);</span></span><br><span class="line"><span class="addition">+  if(pa &gt;= (uint64)end &amp;&amp; pa &lt; PHYSTOP)</span></span><br><span class="line"><span class="addition">+    phy_ref_cnt[(pa-(uint64)end)&gt;&gt;12]++;</span></span><br><span class="line"><span class="addition">+  release(&amp;kmem.lock);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+uint8 dec_ref_cnt(uint64 pa) &#123;</span></span><br><span class="line"><span class="addition">+  uint8 result=0;</span></span><br><span class="line"><span class="addition">+  if(get_ref_cnt(pa) == 0)</span></span><br><span class="line"><span class="addition">+    panic(&quot;dec_ref_cnt&quot;);</span></span><br><span class="line"><span class="addition">+  acquire(&amp;kmem.lock);</span></span><br><span class="line"><span class="addition">+  result = --phy_ref_cnt[(pa-(uint64)end)&gt;&gt;12]; // called by uvmunmap pa is in range</span></span><br><span class="line"><span class="addition">+  release(&amp;kmem.lock);</span></span><br><span class="line"><span class="addition">+  return result;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+uint8 get_ref_cnt(uint64 pa) &#123;</span></span><br><span class="line"><span class="addition">+  uint8 result = 1;</span></span><br><span class="line"><span class="addition">+  acquire(&amp;kmem.lock);</span></span><br><span class="line"><span class="addition">+  if(pa &gt;= (uint64)end &amp;&amp; pa &lt; PHYSTOP)</span></span><br><span class="line"><span class="addition">+    result = phy_ref_cnt[(pa-(uint64)end)&gt;&gt;12];</span></span><br><span class="line"><span class="addition">+  release(&amp;kmem.lock);</span></span><br><span class="line"><span class="addition">+  return result;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> void</span><br><span class="line"> kinit()</span><br><span class="line"> &#123;</span><br><span class="line">   initlock(&amp;kmem.lock, &quot;kmem&quot;);</span><br><span class="line"><span class="deletion">-  freerange(end, (void*)PHYSTOP);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  // caculate the need of ref counts</span></span><br><span class="line"><span class="addition">+  int bytes = (PHYSTOP-PGROUNDUP((uint64)end))&gt;&gt;12;</span></span><br><span class="line"><span class="addition">+  phy_ref_cnt = (uint8*)end;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  freerange((void*)end+bytes, (void*)PHYSTOP);</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> void</span><br><span class="line"><span class="meta">@@ -72,8 +105,10 @@</span> kalloc(void)</span><br><span class="line"></span><br><span class="line">   acquire(&amp;kmem.lock);</span><br><span class="line">   r = kmem.freelist;</span><br><span class="line"><span class="deletion">-  if(r)</span></span><br><span class="line"><span class="addition">+  if(r) &#123;</span></span><br><span class="line">     kmem.freelist = r-&gt;next;</span><br><span class="line"><span class="addition">+    phy_ref_cnt[((uint64)r-(uint64)end)&gt;&gt;12] = 0;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line">   release(&amp;kmem.lock);</span><br><span class="line"></span><br><span class="line">   if(r)</span><br><span class="line"><span class="comment">diff --git a/kernel/riscv.h b/kernel/riscv.h</span></span><br><span class="line"><span class="comment">index 0aec003..7b5db8a 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/riscv.h</span></span><br><span class="line"><span class="comment">+++ b/kernel/riscv.h</span></span><br><span class="line"><span class="meta">@@ -331,6 +331,7 @@</span> sfence_vma()</span><br><span class="line"> #define PTE_W (1L &lt;&lt; 2)</span><br><span class="line"> #define PTE_X (1L &lt;&lt; 3)</span><br><span class="line"> #define PTE_U (1L &lt;&lt; 4) // 1 -&gt; user can access</span><br><span class="line"><span class="addition">+#define PTE_C (1L &lt;&lt; 8)</span></span><br><span class="line"></span><br><span class="line"> // shift a physical address to the right place for a PTE.</span><br><span class="line"> #define PA2PTE(pa) ((((uint64)pa) &gt;&gt; 12) &lt;&lt; 10)</span><br><span class="line"><span class="comment">diff --git a/kernel/trap.c b/kernel/trap.c</span></span><br><span class="line"><span class="comment">index a63249e..e08ee89 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/trap.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/trap.c</span></span><br><span class="line"><span class="meta">@@ -10,6 +10,7 @@</span> struct spinlock tickslock;</span><br><span class="line"> uint ticks;</span><br><span class="line"></span><br><span class="line"> extern char trampoline[], uservec[], userret[];</span><br><span class="line"><span class="addition">+extern uint8* phy_ref_cnt;</span></span><br><span class="line"></span><br><span class="line"> // in kernelvec.S, calls kerneltrap().</span><br><span class="line"> void kernelvec();</span><br><span class="line"><span class="meta">@@ -65,6 +66,34 @@</span> usertrap(void)</span><br><span class="line">     intr_on();</span><br><span class="line"></span><br><span class="line">     syscall();</span><br><span class="line"><span class="addition">+  &#125; else if(r_scause() == 15) &#123;</span></span><br><span class="line"><span class="addition">+    // write page fault</span></span><br><span class="line"><span class="addition">+    uint64 val = r_stval();</span></span><br><span class="line"><span class="addition">+    if(val &gt;= p-&gt;sz) &#123;// check va</span></span><br><span class="line"><span class="addition">+      p-&gt;killed = 1;</span></span><br><span class="line"><span class="addition">+      exit(-1);</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    pte_t *pte = walkpte(p-&gt;pagetable, val);</span></span><br><span class="line"><span class="addition">+    if(pte == 0 || !(*pte &amp; PTE_C)) &#123;</span></span><br><span class="line"><span class="addition">+      p-&gt;killed = 1;</span></span><br><span class="line"><span class="addition">+      exit(-1);</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+    uint64 pa = PTE2PA(*pte);</span></span><br><span class="line"><span class="addition">+    if (get_ref_cnt(pa) == 1) &#123;</span></span><br><span class="line"><span class="addition">+      *pte |= PTE_W;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+    else &#123;</span></span><br><span class="line"><span class="addition">+      char* mem = (char*)kalloc();</span></span><br><span class="line"><span class="addition">+      if(mem == 0) &#123;</span></span><br><span class="line"><span class="addition">+        p-&gt;killed = 1;</span></span><br><span class="line"><span class="addition">+        exit(-1);</span></span><br><span class="line"><span class="addition">+      &#125;</span></span><br><span class="line"><span class="addition">+      memmove(mem, (char*)pa, PGSIZE);</span></span><br><span class="line"><span class="addition">+      uvmunmap(p-&gt;pagetable, PGROUNDDOWN(val), 1, 1);</span></span><br><span class="line"><span class="addition">+      mappages(p-&gt;pagetable, PGROUNDDOWN(val), PGSIZE, (uint64)mem, PTE_X|PTE_W|PTE_U|PTE_R);</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">   &#125; else if((which_dev = devintr()) != 0)&#123;</span><br><span class="line">     // ok</span><br><span class="line">   &#125; else &#123;</span><br><span class="line"><span class="comment">diff --git a/kernel/vm.c b/kernel/vm.c</span></span><br><span class="line"><span class="comment">index bccb405..85c7424 100644</span></span><br><span class="line"><span class="comment">--- a/kernel/vm.c</span></span><br><span class="line"><span class="comment">+++ b/kernel/vm.c</span></span><br><span class="line"><span class="meta">@@ -111,14 +111,46 @@</span> walkaddr(pagetable_t pagetable, uint64 va)</span><br><span class="line">   return pa;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="addition">+pte_t* walkpte(pagetable_t pagetable, uint64 va) &#123;</span></span><br><span class="line"><span class="addition">+  pte_t *pte;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  if(va &gt;= MAXVA)</span></span><br><span class="line"><span class="addition">+    return 0;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  pte = walk(pagetable, va, 0);</span></span><br><span class="line"><span class="addition">+  if(pte == 0)</span></span><br><span class="line"><span class="addition">+    return 0;</span></span><br><span class="line"><span class="addition">+  if((*pte &amp; PTE_V) == 0)</span></span><br><span class="line"><span class="addition">+    return 0;</span></span><br><span class="line"><span class="addition">+  if((*pte &amp; PTE_U) == 0)</span></span><br><span class="line"><span class="addition">+    return 0;</span></span><br><span class="line"><span class="addition">+  return pte;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> // add a mapping to the kernel page table.</span><br><span class="line"> // only used when booting.</span><br><span class="line"> // does not flush TLB or enable paging.</span><br><span class="line"> void</span><br><span class="line"> kvmmap(uint64 va, uint64 pa, uint64 sz, int perm)</span><br><span class="line"> &#123;</span><br><span class="line"><span class="deletion">-  if(mappages(kernel_pagetable, va, sz, pa, perm) != 0)</span></span><br><span class="line"><span class="deletion">-    panic(&quot;kvmmap&quot;);</span></span><br><span class="line"><span class="addition">+  // kvmmap should not increase ref cnt</span></span><br><span class="line"><span class="addition">+  uint64 a, last;</span></span><br><span class="line"><span class="addition">+  pte_t *pte;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  a = PGROUNDDOWN(va);</span></span><br><span class="line"><span class="addition">+  last = PGROUNDDOWN(va + sz - 1);</span></span><br><span class="line"><span class="addition">+  for(;;)&#123;</span></span><br><span class="line"><span class="addition">+    if((pte = walk(kernel_pagetable, a, 1)) == 0)</span></span><br><span class="line"><span class="addition">+      panic(&quot;kvmmap&quot;);</span></span><br><span class="line"><span class="addition">+    if(*pte &amp; PTE_V)</span></span><br><span class="line"><span class="addition">+      panic(&quot;remap&quot;);</span></span><br><span class="line"><span class="addition">+    *pte = PA2PTE(pa) | perm | PTE_V;</span></span><br><span class="line"><span class="addition">+    if(a == last)</span></span><br><span class="line"><span class="addition">+      break;</span></span><br><span class="line"><span class="addition">+    a += PGSIZE;</span></span><br><span class="line"><span class="addition">+    pa += PGSIZE;</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> // translate a kernel virtual address to</span><br><span class="line"><span class="meta">@@ -159,6 +191,7 @@</span> mappages(pagetable_t pagetable, uint64 va, uint64 size, uint64 pa, int perm)</span><br><span class="line">     if(*pte &amp; PTE_V)</span><br><span class="line">       panic(&quot;remap&quot;);</span><br><span class="line">     *pte = PA2PTE(pa) | perm | PTE_V;</span><br><span class="line"><span class="addition">+    inc_ref_cnt(pa);</span></span><br><span class="line">     if(a == last)</span><br><span class="line">       break;</span><br><span class="line">     a += PGSIZE;</span><br><span class="line"><span class="meta">@@ -188,7 +221,8 @@</span> uvmunmap(pagetable_t pagetable, uint64 va, uint64 npages, int do_free)</span><br><span class="line">       panic(&quot;uvmunmap: not a leaf&quot;);</span><br><span class="line">     if(do_free)&#123;</span><br><span class="line">       uint64 pa = PTE2PA(*pte);</span><br><span class="line"><span class="deletion">-      kfree((void*)pa);</span></span><br><span class="line"><span class="addition">+      if(!dec_ref_cnt(pa))</span></span><br><span class="line"><span class="addition">+        kfree((void*)pa);</span></span><br><span class="line">     &#125;</span><br><span class="line">     *pte = 0;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">@@ -311,7 +345,6 @@</span> uvmcopy(pagetable_t old, pagetable_t new, uint64 sz)</span><br><span class="line">   pte_t *pte;</span><br><span class="line">   uint64 pa, i;</span><br><span class="line">   uint flags;</span><br><span class="line"><span class="deletion">-  char *mem;</span></span><br><span class="line"></span><br><span class="line">   for(i = 0; i &lt; sz; i += PGSIZE)&#123;</span><br><span class="line">     if((pte = walk(old, i, 0)) == 0)</span><br><span class="line"><span class="meta">@@ -319,14 +352,11 @@</span> uvmcopy(pagetable_t old, pagetable_t new, uint64 sz)</span><br><span class="line">     if((*pte &amp; PTE_V) == 0)</span><br><span class="line">       panic(&quot;uvmcopy: page not present&quot;);</span><br><span class="line">     pa = PTE2PA(*pte);</span><br><span class="line"><span class="addition">+    *pte = *pte | PTE_C;</span></span><br><span class="line"><span class="addition">+    *pte = *pte &amp; ~PTE_W;</span></span><br><span class="line">     flags = PTE_FLAGS(*pte);</span><br><span class="line"><span class="deletion">-    if((mem = kalloc()) == 0)</span></span><br><span class="line"><span class="deletion">-      goto err;</span></span><br><span class="line"><span class="deletion">-    memmove(mem, (char*)pa, PGSIZE);</span></span><br><span class="line"><span class="deletion">-    if(mappages(new, i, PGSIZE, (uint64)mem, flags) != 0)&#123;</span></span><br><span class="line"><span class="deletion">-      kfree(mem);</span></span><br><span class="line"><span class="addition">+    if(mappages(new, i, PGSIZE, (uint64)pa, flags) != 0)</span></span><br><span class="line">       goto err;</span><br><span class="line"><span class="deletion">-    &#125;</span></span><br><span class="line">   &#125;</span><br><span class="line">   return 0;</span><br><span class="line"></span><br><span class="line"><span class="meta">@@ -355,15 +385,35 @@</span> int</span><br><span class="line"> copyout(pagetable_t pagetable, uint64 dstva, char *src, uint64 len)</span><br><span class="line"> &#123;</span><br><span class="line">   uint64 n, va0, pa0;</span><br><span class="line"><span class="addition">+  pte_t *pte;</span></span><br><span class="line"></span><br><span class="line">   while(len &gt; 0)&#123;</span><br><span class="line">     va0 = PGROUNDDOWN(dstva);</span><br><span class="line"><span class="deletion">-    pa0 = walkaddr(pagetable, va0);</span></span><br><span class="line"><span class="deletion">-    if(pa0 == 0)</span></span><br><span class="line"><span class="addition">+    pte = walkpte(pagetable, va0);</span></span><br><span class="line"><span class="addition">+    if(pte == 0)</span></span><br><span class="line">       return -1;</span><br><span class="line"><span class="addition">+    pa0 = PTE2PA(*pte);</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+    if((*pte &amp; PTE_C) &amp;&amp; !(*pte&amp;PTE_W)) &#123;</span></span><br><span class="line"><span class="addition">+      // dealing with COW page</span></span><br><span class="line"><span class="addition">+      if (get_ref_cnt(pa0) == 1) &#123;</span></span><br><span class="line"><span class="addition">+        *pte |= PTE_W;</span></span><br><span class="line"><span class="addition">+      &#125;</span></span><br><span class="line"><span class="addition">+      else &#123;</span></span><br><span class="line"><span class="addition">+        char* mem = (char*)kalloc();</span></span><br><span class="line"><span class="addition">+        if(mem == 0) &#123;</span></span><br><span class="line"><span class="addition">+          return -1;</span></span><br><span class="line"><span class="addition">+        &#125;</span></span><br><span class="line"><span class="addition">+        memmove(mem, (char*)pa0, PGSIZE);</span></span><br><span class="line"><span class="addition">+        uvmunmap(pagetable, va0, 1, 1);</span></span><br><span class="line"><span class="addition">+        mappages(pagetable, va0, PGSIZE, (uint64)mem, PTE_X|PTE_W|PTE_U|PTE_R);</span></span><br><span class="line"><span class="addition">+        pa0 = (uint64)mem;</span></span><br><span class="line"><span class="addition">+      &#125;</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line">     n = PGSIZE - (dstva - va0);</span><br><span class="line">     if(n &gt; len)</span><br><span class="line"><span class="deletion">-      n = len;</span></span><br><span class="line"><span class="addition">+      n = len;  // dealing one page a time</span></span><br><span class="line">     memmove((void *)(pa0 + (dstva - va0)), src, n);</span><br><span class="line"></span><br><span class="line">     len -= n;</span><br></pre></td></tr></table></figure>

<h2 id="7-Lab-thread-ç›¸å…³"><a href="#7-Lab-thread-ç›¸å…³" class="headerlink" title="| 7 | Lab thread ç›¸å…³"></a>| 7 | Lab thread ç›¸å…³</h2><h3 id="7-1-Chapter-6-amp-LEC-10-note"><a href="#7-1-Chapter-6-amp-LEC-10-note" class="headerlink" title="| 7.1 | Chapter 6 &amp; LEC 10 note"></a>| 7.1 | Chapter 6 &amp; LEC 10 note</h3><ul>
<li>concurrency problems - race conditions</li>
<li>broken acquire - ä½¿ç”¨ç¡¬ä»¶æä¾›çš„åŸå­æ“ä½œ(test&amp;set â€¦)</li>
<li>lock problems - performance&#x2F;deadlock</li>
<li>mem ordering</li>
<li>sleep lock<ul>
<li>ä¸ºä»€ä¹ˆ sleep lock ä¸ç”¨å…³é—­ä¸­æ–­</li>
</ul>
</li>
</ul>
<!-- #### | 7.1.1 | Code: Locks & Using locks

#### | 7.1.2 | Deadlock and lock ordering

#### | 7.1.3 | Sleep locks -->

<h3 id="7-2-Chapter-7-amp-LEC-11-note-amp-LEC-13-note"><a href="#7-2-Chapter-7-amp-LEC-11-note-amp-LEC-13-note" class="headerlink" title="| 7.2 | Chapter 7 &amp; LEC 11 note &amp; LEC 13 note"></a>| 7.2 | Chapter 7 &amp; LEC 11 note &amp; LEC 13 note</h3><p>ä¸ºäº†å…è®¸å¤šäº CPU æ•°é‡çš„è¿›ç¨‹â€œåŒæ—¶â€è¿è¡Œï¼Œæ“ä½œç³»ç»Ÿéœ€è¦æä¾›å¤šè·¯å¤ç”¨(Mutiplexing) åŒ…æ‹¬ CPU åœ¨å†…çš„å…±äº«èµ„æºã€‚</p>
<p>å¤šè·¯å¤ç”¨é¢ä¸´çš„æŒ‘æˆ˜ï¼š</p>
<blockquote>
<ul>
<li><p>how to switch from one process to another? idea is sample but implementation is opaque.</p>
</li>
<li><p>how to force switches in a way that is transparent to user processes? - <strong>timer interrupts</strong></p>
</li>
<li><p>a locking plan is necessary to avoid races, for <u>CPUs may be switching among processes concurrently</u>.</p>
</li>
<li><p>cannot free a processâ€™s memory and other resources when the process exits because (for example) it <u>canâ€™t free its own kernel stack while still using it</u>.</p>
</li>
<li><p>each core of a multi-core machine must remember which process it is executing so that system calls affect the correct processâ€™s kernel state. - <code>myproc()</code></p>
</li>
<li><p>races(the loss of wakeup) in <code>sleep</code> and <code>wakeup</code>.</p>
</li>
</ul>
</blockquote>
<h4 id="7-2-1-switch-amp-scheduling"><a href="#7-2-1-switch-amp-scheduling" class="headerlink" title="| 7.2.1 | switch &amp; scheduling"></a>| 7.2.1 | switch &amp; scheduling</h4><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">overview of thread switching in xv6</span><br><span class="line">  (the point: switch among threads to interleave many threads on each CPU)</span><br><span class="line">  [diagram: P1, TF1, STACK1, swtch(), CTX1;</span><br><span class="line">            CTXs, swtch(), STACKs, scheduler(), &amp;c]</span><br><span class="line">  TF = trapframe = saved user registers</span><br><span class="line">  CTX = context = saved RISC-V registers</span><br><span class="line">  getting from one process to another involves multiple transitions:</span><br><span class="line">    - user -&gt; kernel; saves user registers in **trapframe**</span><br><span class="line">    - kernel thread -&gt; scheduler thread; saves kernel thread registers in **context**</span><br><span class="line">    - scheduler thread -&gt; kernel thread; restores kernel thread registers from **context**</span><br><span class="line">    - kernel -&gt; user; restores user registers from **trapframe**</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>swtch()</code></p>
<p>åªä¿å­˜è¢«è°ƒç”¨è€…ä¿å­˜(<em>callee saved</em>)å¯„å­˜å™¨ã€‚</p>
<p><code>swtch()</code> è¿”å›åˆ° <code>new-&gt;context-&gt;ra</code> æŒ‡å‘çš„åœ°å€ï¼Œè¯¥åœ°å€æ˜¯è¿™ä¸ªæ–°çº¿ç¨‹ä¹‹å‰è°ƒç”¨ <code>swtch()</code> çš„è¿”å›åœ°å€(<code>sched()/forkret()/scheduler()</code>)ã€‚</p>
</li>
<li><p>è¿›ç¨‹åœ¨å‡†å¤‡è®©å‡º CPU ä¹‹å‰å¿…é¡»æ»¡è¶³å‡ ä¸ªè¦æ±‚ï¼š</p>
<ul>
<li><p>è·å¾—è‡ªå·±çš„ <code>p-&gt;lock</code>ï¼Œä»¥ä¿æŠ¤ <code>p-&gt;state</code>, <code>cpu-&gt;proc</code>ã€‚å¦‚æœæ²¡æœ‰ <code>p-&gt;lock</code> åœ¨å½“å‰ CPU æ‰§è¡Œ <code>yeild()</code> å’Œ <code>scheduler():swtch()</code> ä¹‹é—´ï¼Œå…¶ä»–çš„ CPU å¾ˆå¯èƒ½è°ƒåº¦åˆ°æ­¤è¿›ç¨‹ï¼Œæ­¤æ—¶ä¸¤ä¸ª CPU å…±ç”¨åŒä¸€ä¸ªå†…æ ¸æ ˆã€‚</p>
</li>
<li><p>ä¿®æ”¹è¿›ç¨‹çš„çŠ¶æ€(<code>p-&gt;state</code>)ï¼Œä¿®æ”¹æˆ <code>SLEPPING/RUNABLE/ZOMBIE</code>ã€‚</p>
</li>
<li><p>è¿™æ ·çš„å‡½æ•°æœ‰ï¼š<code>sleep()</code>, <code>yield()</code>, <code>exit()</code> ã€‚</p>
</li>
</ul>
</li>
<li><p><code>scheduler()</code></p>
<ol>
<li>æ‰“å¼€ä¸­æ–­ï¼Œéå† <code>proc[]</code> æ‰¾åˆ°ä¸€ä¸ª <code>RUNNALBE</code> è¿›ç¨‹(p)(é¦–å…ˆä¼šç”³è¯·å½“å‰è¿›ç¨‹çš„é” <code>p-&gt;lock</code>)ã€‚</li>
<li>æ›´æ–° <code>p-&gt;state</code> ä¸º <code>RUNNING</code>, <code>c-&gt;proc</code> ä¸ºå½“å‰è¿›ç¨‹ã€‚</li>
<li>è°ƒç”¨<code>swtch()</code> åˆ°è¿›ç¨‹ pã€‚</li>
<li>å½“è¢« <code>sleep()/yield()/exit()</code> è°ƒç”¨ <code>sched()</code> åˆ‡æ¢å›æ¥æ—¶ï¼Œæ¸…ç©º <code>c-&gt;proc</code>, é‡Šæ”¾ <code>p-&gt;lock</code>ã€‚</li>
<li>å¦‚æœå½“å‰åªæœ‰ <code>init</code> å’Œ <code>sh</code> ä¸¤ä¸ªè¿›ç¨‹ï¼Œåˆ™æ‰“å¼€ä¸­æ–­å¹¶æ‰§è¡ŒæŒ‡ä»¤ <code>wfi</code> ç­‰å¾…ä¸­æ–­ï¼Œå¦åˆ™ç»§ç»­æ‰§è¡Œã€‚</li>
<li>é‡å¤ 1. ã€‚</li>
</ol>
</li>
<li><p><code>mycpu()</code></p>
<ul>
<li><code>mycpu()</code> è¦æ±‚è°ƒç”¨è€…å…³é—­ä¸­æ–­ï¼Œç›´åˆ°ä½¿ç”¨å®Œ <code>mycpu()</code> è¿”å›çš„å€¼ä¸ºæ­¢ã€‚</li>
<li>å› ä¸ºå¦‚æœåœ¨è¿™æœŸé—´è¢«ä¸­æ–­ï¼Œ<code>hartid</code> ä¼šè¢«ä¿®æ”¹ï¼Œå¯¼è‡´ç´¢å¼•æœ‰è¯¯ã€‚</li>
</ul>
</li>
<li><p><code>myproc()</code></p>
<ul>
<li>å…³ä¸­æ–­ã€‚</li>
<li>ä¿å­˜ <code>mycpu()-&gt;proc</code>ã€‚</li>
<li>å…³ä¸­æ–­ã€‚åœ¨è¿™ä¹‹åè¢«ä¸­æ–­æ˜¯å…è®¸çš„ï¼Œå› ä¸º <code>proc</code> ç»“æ„ä½“ä¸ä¾èµ– <code>hartid</code>, æˆ‘ä»¬åªéœ€è¦æ ¹æ® <code>hartid</code> æ‰¾åˆ°å½“å‰ CPU æ­£åœ¨æ‰§è¡Œçš„è¿›ç¨‹</li>
<li>è¿”å›ç»“æ„ä½“åœ°å€ã€‚</li>
</ul>
</li>
<li><p><code>sched()</code> æŒæœ‰ <code>p-&gt;lock</code>ï¼Œåˆ‡æ¢åˆ° <code>scheduler()</code> åï¼Œä¼šé‡Šæ”¾ <code>p-&gt;lock</code>ï¼Œè¿™ä¸¤ä¸ªé”ä¸€æ ·å—ï¼Ÿâ€“ å®Œå…¨ä¸€æ ·</p>
<ul>
<li>å› ä¸ºä¸€ä¸ªè¿›ç¨‹ <code>p1</code> é¦–å…ˆæ˜¯é€šè¿‡ <code>scheduler()</code> è·å–äº†é”ï¼Œç„¶åå†é€šè¿‡ <code>swtch()</code> è¿”å›åé‡Šæ”¾ã€‚</li>
<li>è€Œ <code>p1</code> è°ƒç”¨ <code>sched()</code> å›åˆ°çš„ <code>scheduler()</code> å’Œå½“åˆè°ƒåº¦ä»–çš„ <code>scheduler()</code> æ˜¯åŒä¸€ä¸ª CPU, æ‰€ä»¥æ­¤æ—¶ <code>scheduler()</code> ä¸Šä¸‹æ–‡çš„ <code>p</code> å³ <code>p1</code>ã€‚</li>
<li>æ­¤å¤–å¯¹äº <code>fork()</code> çš„å­è¿›ç¨‹ï¼Œåœ¨ <code>scheduler()</code> å¼€å¤´éå†æ—¶è·å– <code>p-&gt;lock</code>ï¼Œåœ¨ <code>forkret()</code> é‡Šæ”¾ã€‚</li>
</ul>
</li>
</ul>
<h4 id="7-2-2-sleep-amp-wakeup"><a href="#7-2-2-sleep-amp-wakeup" class="headerlink" title="| 7.2.2 | sleep &amp; wakeup"></a>| 7.2.2 | sleep &amp; wakeup</h4><blockquote>
<p>one process to <strong>sleep</strong> <u>when waiting for an event</u> and another process to <strong>wake it up</strong> once <u>the event has happened</u>.</p>
</blockquote>
<p>æ¯”å¦‚ä»¥ä¸‹äº‹ä»¶(event)</p>
<ul>
<li>waiting pipes</li>
<li>disk r&#x2F;w</li>
<li><code>sys_wait()</code></li>
</ul>
<p>loss wakeups (broken sleep: wakeup before sleep).</p>
<p><em>loss wakeups</em> çš„è§£å†³æ–¹æ³•:</p>
<ul>
<li>è°ƒç”¨ <code>sleep()</code> ä¹‹å‰å¿…é¡»ä¿è¯æŒæœ‰è°ƒç”¨ <code>wakeup()</code> ä¹Ÿéœ€è¦çš„  <em>conditional lock</em></li>
<li>xv6 é€šè¿‡ä¿®æ”¹ <code>sleep()</code> æ¥å£ï¼Œ<code>sleep()</code> æ¥æ”¶é™¤äº† <em>channel</em> ä»¥å¤–çš„å¦ä¸€ä¸ªå‚æ•°ï¼Œ<em>conditional lock</em></li>
</ul>
<p><code>sleep()</code></p>
<ul>
<li>ç”³è¯· <code>p-&gt;lock</code>, é‡Šæ”¾ <em>conditional lock</em>ã€‚</li>
<li>æ›´æ–° <code>p-&gt;chan = chan</code>, <code>p-&gt;state = SLEEPING</code>ã€‚</li>
<li>è°ƒç”¨ <code>sched()</code> è®©å‡º CPUã€‚</li>
<li>å½“ <code>p-&gt;state</code> è¢« <code>wakeup()/kill()/exit()</code> ä¿®æ”¹åï¼Œä¼šè¢« <code>sheduler()</code> è°ƒåº¦ï¼Œä» <code>sched()</code> è¿”å›ã€‚</li>
<li>æ¸…ç©º <code>p-&gt;chan</code>ã€‚</li>
<li>é‡æ–°ç”³è¯· <em>conditional lock</em> åè¿”å›ã€‚</li>
</ul>
<p><code>wakeup()</code></p>
<ul>
<li>éå† <code>procp[]</code> åŒ¹é… <code>p-&gt;state == SLEEPING &amp;&amp; p-&gt;chan == chan</code>, åœ¨è¿™ä¹‹å‰ä¼šè·å– <code>p-&gt;lock</code>ã€‚</li>
<li>æ›´æ–° <code>p-&gt;state = RUNNABLE</code>ã€‚</li>
<li>é‡Šæ”¾ <code>p-&gt;lock</code> è¿”å›ã€‚</li>
</ul>
<p>æ³¨æ„ï¼š</p>
<ul>
<li><u>é€šå¸¸åœ¨è°ƒç”¨ <code>wakeup()</code> ä¹‹å‰åº”è¯¥ç”³è¯·ç›¸åº”çš„ <em>conditional lock</em>ï¼Œ <code>wakeup()</code> è¿”å›åé‡Šæ”¾</u>ã€‚</li>
<li>å¤šä¸ªè¿›ç¨‹ä½¿ç”¨åŒä¸€ä¸ª <em>sleeping channel</em> æ˜¯å…è®¸çš„ï¼Œå› ä¸ºåœ¨ <code>sleep()</code> è¿”å›å‰ä¼šé‡æ–°ç”³è¯· <em>conditional lock</em>, å°½ç®¡è¿™äº›è¿›ç¨‹éƒ½ä¼šè¢« <code>wakeup()</code> ä½†æ˜¯åªæœ‰ä¸€ä¸ªèƒ½æˆåŠŸç”³è¯·åˆ°é”ã€‚</li>
</ul>
<h4 id="7-2-3-wait-exit-amp-kill"><a href="#7-2-3-wait-exit-amp-kill" class="headerlink" title="| 7.2.3 | wait, exit &amp; kill"></a>| 7.2.3 | wait, exit &amp; kill</h4><p><code>wait()</code></p>
<ul>
<li>æ‰¾åˆ°ä¸€ä¸ª <code>ZOMBIE</code> å­è¿›ç¨‹ã€‚</li>
<li>é‡Šæ”¾è¯¥è¿›ç¨‹ (<code>freeproc()</code>)ã€‚</li>
<li>è¿”å›å­è¿›ç¨‹ <code>pid</code>ã€‚</li>
<li>å¦‚æœæ²¡æœ‰æ²¡æœ‰å­è¿›ç¨‹ï¼Œæˆ–è¢« kill,åˆ™ç›´æ¥è¿”å›ã€‚</li>
<li>è°ƒç”¨ <code>sleep()</code> ç­‰å¾…å­è¿›ç¨‹ <code>exit()</code> æ—¶ è°ƒç”¨ <code>wakeup1()</code>ã€‚</li>
</ul>
<p>æ³¨æ„ï¼š</p>
<blockquote>
<ul>
<li><p><code>wait</code> often holds two locks, xv6 must obey the same locking <strong>order</strong> (<u>parent, then child</u>) in order to avoid deadlock.</p>
</li>
<li><p><code>wait</code> uses <code>np-&gt;parent</code> without holding <code>np-&gt;lock</code>.  It is possible that <code>np</code> is an ancestor of the current process, in which case acquiring <code>np-&gt;lock</code> could cause a <strong>deadlock</strong>. A processâ€™s <code>parent</code> field is only changed by its parent, so if <code>np-&gt;parent==p</code> is true, <u>the value canâ€™t change unless the current process changes it</u>.</p>
</li>
</ul>
</blockquote>
<ul>
<li>åœ¨åˆ¤æ–­ <code>np-&gt;parent==p</code> åæ‰ä¼šç”³è¯· <code>np-&gt;lock</code></li>
</ul>
<p><code>exit()</code></p>
<blockquote>
<p><code>exit</code> allows a process to <strong>terminate</strong> itself</p>
</blockquote>
<ul>
<li>å…³é—­äº†æ‰€æœ‰å·²æ‰“å¼€çš„æ–‡ä»¶</li>
<li>è°ƒç”¨ <code>wakeup()</code> å”¤é†’ <code>initproc</code>ï¼Œä¹‹å <code>initproc</code> ç»§ç»­æ‰§è¡Œ <code>wait()</code>ã€‚</li>
<li>ç”³è¯· <code>p-&gt;parent-&gt;lock</code> å› ä¸ºè¦å”¤é†’çˆ¶è¿›ç¨‹ã€‚</li>
<li>å†ç”³è¯· <code>p-&gt;lock</code> å› ä¸ºè¦æ›´æ–° <code>p-&gt;state</code> ä¸”é‡æ–°è®¾ç½®çˆ¶è¿›ç¨‹ä¸º(reparent to) <code>initproc</code>ã€‚æ³¨æ„ç”±äºä¸Šé¢çš„é¡ºåº(<em>memory ordering</em>)å…ˆçˆ¶è¿›ç¨‹å†å­è¿›ç¨‹ã€‚</li>
<li><em>reparent</em> ã€‚</li>
<li>å”¤é†’çˆ¶è¿›ç¨‹ã€‚</li>
<li>ä¿®æ”¹ <code>p-&gt;state=ZOMBIE</code>ã€‚</li>
<li>è°ƒç”¨ <code>sched()</code> è®©å‡º CPUã€‚</li>
</ul>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>åœ¨ä¿®æ”¹ <code>p-&gt;state=ZOMBIE</code> ä¹‹å‰å”¤é†’çˆ¶è¿›ç¨‹æ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºå½“çˆ¶è¿›ç¨‹ä» <code>wait()</code> çš„ <code>sleep()</code> è¿”å›æ—¶ï¼Œæœ€ç»ˆä¼šç”³è¯· <code>np-&gt;lock</code>ã€‚ç›´åˆ° <code>exit()</code> è°ƒç”¨ <code>sched()</code> ä¹‹åï¼Œ<code>scheduler()</code> æ‰ä¼šé‡Šæ”¾è¯¥å­è¿›ç¨‹çš„é”ã€‚</li>
</ul>
<p><code>kill()</code></p>
<blockquote>
<p><code>kill</code> lets one process request that <strong>another</strong> terminate.</p>
<p>It would be too complex for <code>kill</code> to <strong>directly destroy</strong> the victim process, since <u>the victim might be executing on another CPU</u>, perhaps in the middle of a sensitive sequence of updates to kernel data structures.<br><u>Thus kill does very little</u>:</p>
<ul>
<li>sets the victimâ€™s <code>p-&gt;killed</code></li>
<li>if it is sleeping, wakes it up.(<code>p-&gt;state = RUNNABLE</code>)</li>
</ul>
</blockquote>
<p>æ³¨æ„ï¼š</p>
<ul>
<li><code>kill</code> ç›´æ¥å”¤é†’å½“å‰è¿›ç¨‹å¾ˆå¯èƒ½é€ æˆç›®æ ‡è¿›ç¨‹ä» <code>sleep()</code> ä¸­è¿”å›ã€‚æ­¤æ—¶å¾ˆå¯èƒ½å½“å‰ç¨‹åºå¸Œæœ› <code>sleep()</code> ç­‰å¾…çš„æ¡ä»¶è¿˜<strong>æ²¡æœ‰è¾¾æˆ</strong>ï¼Œå› è€Œé€ æˆç¨‹åºé”™è¯¯ã€‚</li>
<li>æ‰€ä»¥ä¸€äº›å°è£… <code>sleep()</code> çš„å¾ªç¯ï¼Œå½“ <code>sleep()</code> è¿”å›æ—¶ï¼Œéœ€è¦æ£€æŸ¥ <code>p-&gt;kill</code></li>
<li>å¯¹äºä¸€äº›è¦æ±‚åŸå­æ“ä½œçš„å¾ªç¯ï¼Œæ¯”å¦‚è¯»å†™ç£ç›˜ï¼Œåˆ™ç›¸åå¿…é¡»ç­‰åŸå­æ“ä½œå®Œæˆåå†æ£€æŸ¥ <code>p-&gt;kill</code></li>
</ul>
<h3 id="7-3-Lab-Multithreading"><a href="#7-3-Lab-Multithreading" class="headerlink" title="| 7.3 | Lab: Multithreading"></a>| 7.3 | <u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/labs/thread.html">Lab: Multithreading</a></u></h3><img alt="å›¾ 8" src="/images/image-20240327062655.png" />  

<h4 id="7-3-1-Uthread-switching-between-threads-moderate"><a href="#7-3-1-Uthread-switching-between-threads-moderate" class="headerlink" title="| 7.3.1 | Uthread: switching between threads (moderate)"></a>| 7.3.1 | Uthread: switching between threads (moderate)</h4><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>
<ul>
<li>åˆå§‹åŒ– <code>sp=t-&gt;stack + STACK_SIZE</code> å³ <code>sp</code> æ˜¯é€’å‡çš„ã€‚</li>
<li><code>thread_switch()</code> ä¹‹åä¸ç”¨æ›´æ–° <code>current_thread = t;</code> å› ä¸ºæ¯æ¬¡éƒ½ä¼šä»å¤´è°ƒç”¨è°ƒåº¦å™¨ï¼Œå·²ç»è®¾ç½®äº† <code>current_thread</code>ã€‚</li>
</ul>
<p>ğŸ“Œ <u><a target="_blank" rel="noopener" href="https://github.com/sev1n75/xv6-riscv/commit/3752d8e7ae9c90e6d079f9ade6531e3b78b19dba">è¿™éƒ¨åˆ†ä»£ç åœ¨è¿™é‡Œ</a></u></p>
<h4 id="7-3-2-Using-threads-moderate"><a href="#7-3-2-Using-threads-moderate" class="headerlink" title="| 7.3.2 | Using threads (moderate)"></a>| 7.3.2 | Using threads (moderate)</h4><p>ğŸ“Œ <u><a target="_blank" rel="noopener" href="https://github.com/sev1n75/xv6-riscv/commit/b01053525a0498534510db5e6ba212e7540ff84c">è¿™éƒ¨åˆ†ä»£ç åœ¨è¿™é‡Œ</a></u></p>
<h4 id="7-3-3-Barrier-moderate"><a href="#7-3-3-Barrier-moderate" class="headerlink" title="| 7.3.3 | Barrier(moderate)"></a>| 7.3.3 | Barrier(moderate)</h4><p>åªéœ€è¦éµå®ˆè°ƒç”¨ <code>wakeup()</code> çš„é€šç”¨æ–¹æ³•<a href="#7-2-2-sleep-amp-wakeup">| 7.2.2 | sleep &amp; wakeup</a></p>
<p>ğŸ“Œ <u><a target="_blank" rel="noopener" href="https://github.com/sev1n75/xv6-riscv/commit/d964e36860a2ea66b85836d6523cd07cd846ef9c">è¿™éƒ¨åˆ†ä»£ç åœ¨è¿™é‡Œ</a></u></p>
<h2 id="8-Lab-lock-ç›¸å…³"><a href="#8-Lab-lock-ç›¸å…³" class="headerlink" title="| 8 | Lab lock ç›¸å…³"></a>| 8 | Lab lock ç›¸å…³</h2><h3 id="8-1-Lab-locks"><a href="#8-1-Lab-locks" class="headerlink" title="| 8.1 | Lab: locks"></a>| 8.1 | <u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/labs/lock.html">Lab: locks</a></u></h3><h4 id="8-1-1-Memory-allocator-moderate"><a href="#8-1-1-Memory-allocator-moderate" class="headerlink" title="| 8.1.1 | Memory allocator (moderate)"></a>| 8.1.1 | Memory allocator (moderate)</h4><ul>
<li>ä¸ç”¨å¯¹æ‰€æœ‰ CPU ç­‰åˆ† <code>freelist</code>ï¼Œå› ä¸ºä¸ç¡®å®š CPU æ•°é‡ä¸ç¡®å®šï¼Œåªéœ€è¦ç»™ CPU0 åˆ†é…æ‰€æœ‰å†…å­˜ï¼Œå…¶ä»–çš„ CPU è°ƒç”¨ <code>steal()</code> å³å¯</li>
<li><code>steal()</code> ä¸èƒ½ä¼ å…¥è°ƒç”¨ä»–æ—¶çš„ <code>cpuid</code> å¹¶ä¸”ä¸éå†è¿™ä¸ª CPUã€‚å› ä¸ºå¾ˆå¯èƒ½ <code>steal()</code> æ‰§è¡Œè¿‡ç¨‹ä¸­è¢«è°ƒåº¦ï¼Œæ›´æ–°äº† <code>freelist()</code>ï¼Œä¸éå†ä¼šå¯¼è‡´ä¸¢å¤±éƒ¨åˆ†å†…å­˜ã€‚</li>
</ul>
<p>ğŸ“Œ <u><a target="_blank" rel="noopener" href="https://github.com/sev1n75/xv6-riscv/commit/1a92ee4843238810d398e472e233bae95b219625">è¿™éƒ¨åˆ†ä»£ç åœ¨è¿™é‡Œ</a></u></p>
<h4 id="8-1-2-Buffer-cache-hard"><a href="#8-1-2-Buffer-cache-hard" class="headerlink" title="| 8.1.2 | Buffer cache (hard)"></a>| 8.1.2 | Buffer cache (hard)</h4><p>ç”¨å“ˆå¸Œè¡¨ä»£æ›¿åŸæ¥ <em>buffer cache</em> çš„ä¸€ä¸ªåŒé“¾è¡¨ï¼Œæ¥é¿å… <em>lock contention</em></p>
<p>åè¡¥</p>
<p>è‡ªæˆ‘æ„Ÿè§‰è¿™éƒ¨åˆ†(å¹¶å‘ï¼Œæ­»é”ï¼Œæ¡ä»¶ç«äº‰)å¾ˆéš¾è°ƒè¯•ï¼Œå†…æ ¸å‡ºé”™çš„ä½ç½®å’Œä»£ç é”™è¯¯çš„ä½ç½®æœ‰ä¸€å®šè·ç¦»ï¼Œå¾ˆéš¾é€šè¿‡ gdb æ‰¾åˆ°ã€‚</p>
<p>LEC 15ï¼ŒFrans æ•™æˆæåˆ°å¯ä»¥é€šè¿‡ â€œwrite down assertion for invariants.â€</p>
<p>åé¢å†åšå§ï¼Œå…ˆæŠŠæ—¶é—´ç•™ç»™æ–‡ä»¶ç³»ç»Ÿå’Œ mmapã€‚</p>
<h2 id="9-Lab-fs-ç›¸å…³"><a href="#9-Lab-fs-ç›¸å…³" class="headerlink" title="| 9 | Lab fs ç›¸å…³"></a>| 9 | Lab fs ç›¸å…³</h2><h3 id="9-1-LEC-14-note"><a href="#9-1-LEC-14-note" class="headerlink" title="| 9.1 | LEC 14 note"></a>| 9.1 | LEC 14 note</h3><h4 id="9-1-1-Buffer-cache-layer"><a href="#9-1-1-Buffer-cache-layer" class="headerlink" title="|9.1.1| Buffer cache layer"></a>|9.1.1| Buffer cache layer</h4><p><code>bread()</code></p>
<p><code>bwrite()</code></p>
<p><code>brelse()</code></p>
<p><code>balloc()</code></p>
<p><code>bfree()</code></p>
<h4 id="9-1-2-inode-layer-icache"><a href="#9-1-2-inode-layer-icache" class="headerlink" title="|9.1.2| inode layer(icache)"></a>|9.1.2| inode layer(icache)</h4><p><code>ialloc()</code></p>
<p><code>iget()</code></p>
<p><code>ilock()</code></p>
<p><code>iput()</code></p>
<p><code>iupdate()</code></p>
<p><code>bmap()</code>: è¿”å› <code>inode.data.logic_block_number</code> å¯¹åº”çš„å®é™…å—å·(block number)ã€‚</p>
<p><code>itrunc()</code>: é‡Šæ”¾ <code>inode</code> çš„æ•°æ®å ç”¨çš„æ‰€æœ‰å—ã€‚</p>
<p><code>readi()</code></p>
<p><code>writei()</code></p>
<h3 id="9-2-LEC-15-note-amp-Chapter-8"><a href="#9-2-LEC-15-note-amp-Chapter-8" class="headerlink" title="| 9.2 | LEC 15 note &amp; Chapter 8"></a>| 9.2 | LEC 15 note &amp; Chapter 8</h3><h4 id="9-2-1-logging-layer"><a href="#9-2-1-logging-layer" class="headerlink" title="|9.2.1| logging layer"></a>|9.2.1| logging layer</h4><p>æ—¥å¿—(<em>log</em>) æœºåˆ¶åŸç†ï¼š</p>
<blockquote>
<p>write-ahead log rule:</p>
<ul>
<li>install <em>none</em> of a transactionâ€™s writes to disk</li>
<li>until <em>all</em> writes are in the log on disk,</li>
<li>and the logged writes are marked committed.</li>
</ul>
</blockquote>
<p>ç»„æäº¤(<em>group commit</em>)ï¼š</p>
<blockquote>
<ul>
<li><p>the logging system only commits when no file-system system calls are underway.</p>
</li>
<li><p>commit order canâ€™t be changed</p>
</li>
</ul>
</blockquote>
<p>å›ºå®šæ—¥å¿—å¤§å°çš„é—®é¢˜ï¼š</p>
<blockquote>
<ul>
<li><p>ä¸€æ¬¡ <code>write()</code> çš„å¤§å°ä¸èƒ½è¶…è¿‡æ—¥å¿—å®šä¹‰çš„å—çš„æ•°é‡ã€‚</p>
</li>
<li><p>unlinking a large file might write many bitmap blocks and an inode.</p>
</li>
</ul>
</blockquote>
<p><code>begin_op()</code></p>
<p><code>log_write()</code></p>
<p><code>end_op()</code></p>
<p><code>commit()</code></p>
<p><code>write_log()</code>: æŠŠäº‹åŠ¡(<em>transaction</em>)æ¶‰åŠçš„å—(ä¿å­˜åœ¨å†…å­˜ <code>log</code> ç»“æ„ä½“çš„ <code>log.lh.block[]</code>) å†™åˆ°ç£ç›˜çš„å­˜æ”¾æ—¥å¿—å—çš„åŒºåŸŸ(block 2-31)ã€‚</p>
<p><code>write_head()</code>: æäº¤ç‚¹(<em>commit point</em>), æŠŠå†…å­˜ä¸­çš„æ—¥å¿—å¤´å†™åˆ°ç£ç›˜çš„æ—¥å¿—å¤´ã€‚</p>
<p><code>install_trans()</code>: æ ¹æ®æ—¥å¿—å¤´æŠŠç£ç›˜ä¸­çš„æ—¥å¿—å†™åˆ°å¯¹åº”çš„ä½ç½®(<em>home location</em>)ã€‚</p>
<p><code>recover_from_log()</code></p>
<h4 id="9-2-2-Directory-pathname-file-descriptor-layer"><a href="#9-2-2-Directory-pathname-file-descriptor-layer" class="headerlink" title="|9.2.2| Directory, pathname, file descriptor layer"></a>|9.2.2| Directory, pathname, file descriptor layer</h4><p><code>dirlookup()</code></p>
<p><code>dirlink()</code></p>
<p><code>namex()</code>: æ ¹æ® <code>path</code> è¿”å›å¯¹åº” <em>icache</em> åœ°å€ã€‚</p>
<p><code>skipelem()</code>: è¿”å›å­è·¯å¾„ï¼Œè®¾ç½® <em>name</em>ã€‚</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Examples:</span></span><br><span class="line"><span class="comment">//   skipelem(&quot;a/bb/c&quot;, name) = &quot;bb/c&quot;, setting name = &quot;a&quot;</span></span><br><span class="line"><span class="comment">//   skipelem(&quot;///a//bb&quot;, name) = &quot;bb&quot;, setting name = &quot;a&quot;</span></span><br><span class="line"><span class="comment">//   skipelem(&quot;a&quot;, name) = &quot;&quot;, setting name = &quot;a&quot;</span></span><br><span class="line"><span class="comment">//   skipelem(&quot;&quot;, name) = skipelem(&quot;////&quot;, name) = 0</span></span><br></pre></td></tr></table></figure>

<p><code>filealloc()</code></p>
<p><code>filedup()</code></p>
<p><code>fileclose()</code></p>
<p><code>fileread()</code></p>
<p><code>filewrite()</code></p>
<h3 id="9-3-LEC-16-note"><a href="#9-3-LEC-16-note" class="headerlink" title="| 9.3 | LEC 16 note"></a>| 9.3 | LEC 16 note</h3><p>xv6 æ—¥å¿—ç³»ç»Ÿçš„é—®é¢˜ï¼š</p>
<ul>
<li>synchronize: å¿…é¡»ç­‰å½“å‰äº‹åŠ¡å®Œå…¨ç»“æŸï¼Œæ‰èƒ½ç»§ç»­ã€‚</li>
<li>write twice</li>
</ul>
<p>ext3:</p>
<ul>
<li>å¼‚æ­¥(async): ç³»ç»Ÿè°ƒç”¨(syscall)è¿”å›å¹¶ä¸ä»£è¡¨éœ€è¦çš„äº‹åŠ¡æˆåŠŸå®Œæˆï¼Œæ‰€ä»¥ç”¨æˆ·è¿›ç¨‹å¿…é¡»è€ƒè™‘åˆ°è¿™ç§æƒ…å†µ(<code>fsync(fd)</code>)</li>
<li>æ‰¹å¤„ç†(batching)<ul>
<li>ä¸€æ¬¡åªæœ‰ä¸€ä¸ª â€œopen transactionâ€ï¼Œå¯ä»¥åŒ…å«å¤šä¸ª <code>syscall</code></li>
</ul>
</li>
<li>å¹¶å‘(concurrency)<ul>
<li>å½“å‰ â€œopen transactionâ€ çš„æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ç»“æŸåæ‰èƒ½ç»“æŸ(close)è¯¥äº‹åŠ¡ã€‚</li>
<li>ç»“æŸäº‹åŠ¡åä¼šç¼“å­˜åˆ°å†…å­˜ä¸­ï¼ŒæŒ‰é¡ºåºä¾æ¬¡æäº¤(commit)åˆ°ç£ç›˜çš„ log åŒºåŸŸã€‚</li>
<li>å› æ­¤ ext3 ä¸åƒ xv6ï¼Œå¿…é¡»ç­‰å½“å‰äº‹åŠ¡å†™å…¥ç£ç›˜æ—¥å¿—åŒºï¼Œæäº¤ï¼Œ<em>install</em>ï¼Œæ¸…ç©ºæ—¥å¿—åŒºå®Œæˆåå†å¼€å§‹ã€‚</li>
</ul>
</li>
</ul>
<p>ext3 çš„ä¸‰ç§æ¨¡å¼ï¼š</p>
<ul>
<li>journaled data: å’Œ xv6 ä¸€æ ·ï¼Œå…ˆå†™å…¥ç£ç›˜æ—¥å¿—åŒºï¼Œç„¶åå†å†™åŸæœ¬çš„ä½ç½®(<em>home location</em>)</li>
<li>ordered data: åªæŠŠå…ƒæ•°æ®(<em>metadata</em>)å†™å…¥ç£ç›˜æ—¥å¿—åŒºï¼Œè€Œæ–‡ä»¶æ•°æ®ç›´æ¥å†™å…¥åŸæœ¬çš„ä½ç½®ï¼Œä½†æ˜¯å¿…é¡»æ³¨æ„è¦å…ˆå†™æ•°æ®ï¼Œå†å†™å…ƒæ•°æ®ã€‚</li>
<li>writeback</li>
</ul>
<h3 id="9-4-Lab-file-system"><a href="#9-4-Lab-file-system" class="headerlink" title="| 9.4 | Lab: file system"></a>| 9.4 | <u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/labs/fs.html">Lab: file system</a></u></h3><img alt="å›¾ 10" src="/images/image-20240331110325.png" />  

<h4 id="9-4-1-Large-files-moderate"><a href="#9-4-1-Large-files-moderate" class="headerlink" title="| 9.4.1 | Large files (moderate)"></a>| 9.4.1 | Large files (moderate)</h4><p>ğŸ“Œ <u><a target="_blank" rel="noopener" href="https://github.com/sev1n75/xv6-riscv/commit/ec3a188925a48e2465c1741099bc4ab1119a53b0">è¿™éƒ¨åˆ†ä»£ç åœ¨è¿™é‡Œ</a></u></p>
<h4 id="9-4-2-Symbolic-links-moderate"><a href="#9-4-2-Symbolic-links-moderate" class="headerlink" title="| 9.4.2 | Symbolic links (moderate)"></a>| 9.4.2 | Symbolic links (moderate)</h4><p>ğŸ“Œ <u><a target="_blank" rel="noopener" href="https://github.com/sev1n75/xv6-riscv/commit/3ec2e78986e6438f496266c371d31323b1403272">è¿™éƒ¨åˆ†ä»£ç åœ¨è¿™é‡Œ</a></u></p>
<h2 id="10-Lab-mmap-ç›¸å…³"><a href="#10-Lab-mmap-ç›¸å…³" class="headerlink" title="| 10 | Lab mmap ç›¸å…³"></a>| 10 | Lab mmap ç›¸å…³</h2><h3 id="10-1-LEC-17-note"><a href="#10-1-LEC-17-note" class="headerlink" title="| 10.1 | LEC 17 note"></a>| 10.1 | LEC 17 note</h3><p>ä¸€äº›é€šè¿‡ä½¿ç”¨å†…æ ¸æä¾›çš„è™šæ‹Ÿå†…å­˜åŸè¯­&#x2F;ç‰¹æ€§(primitives) å¦‚: <code>trap</code>, <code>prot1,protn</code>, <code>dirty</code>, <code>map2</code> (<code>sigaction()</code>, <code>mprotect()</code>, <code>mmap()</code>)çš„ç®—æ³•ã€‚</p>
<ul>
<li><p><em>VMA</em>(Virtual Memory Area)</p>
<p>è®°å½•å¹¶æè¿°ä¸€æ®µè¿ç»­çš„å†…å­˜åŒºåŸŸï¼ŒåŒ…æ‹¬èµ·å§‹ç»ˆæ­¢åœ°å€ï¼Œæƒé™ï¼Œç›¸å…³æ–‡ä»¶æŒ‡é’ˆç­‰</p>
</li>
</ul>
<h3 id="10-2-LEC-18-note"><a href="#10-2-LEC-18-note" class="headerlink" title="| 10.2 | LEC 18 note"></a>| 10.2 | LEC 18 note</h3><p>micro kernel æš‚æ—¶å¿½ç•¥ã€‚</p>
<h3 id="10-3-LEC-19-note"><a href="#10-3-LEC-19-note" class="headerlink" title="| 10.3 | LEC 19 note"></a>| 10.3 | LEC 19 note</h3><p><strong>Virtual Machine!!!!</strong></p>
<p>è™šæ‹ŸåŒ–éœ€è¦è§£å†³çš„ä¸‰ä¸ªé—®é¢˜ï¼šæ€æ ·å®‰å…¨çš„æœ‰æ•ˆçš„ä½¿å¾—è™šæ‹Ÿæœº(guest VM), æ‰§è¡ŒæŒ‡ä»¤ï¼Œè®¿é—®å†…å­˜ï¼Œè¯»å†™è®¾å¤‡ã€‚</p>
<p>è™šæ‹Ÿæœºä¸èƒ½è¿è¡Œåœ¨å®¿ä¸»(host)å†…æ ¸ä¸­ã€‚</p>
<p>å¯¹åº”ä¸‰ç§è™šæ‹ŸåŒ– <strong>CPU è™šæ‹ŸåŒ–</strong>ï¼Œ<strong>å†…å­˜è™šæ‹ŸåŒ–</strong>ï¼Œ<strong>I&#x2F;O è™šæ‹ŸåŒ–</strong></p>
<p>è¾…åŠ©å‚è€ƒ:ğŸ”— <a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/virtualization/basic-knowledge/basic-knowledge/">CTF Wiki-Pwn-Virtualization-åŸºç¡€çŸ¥è¯†</a></p>
<h4 id="10-3-1-trap-and-emulate"><a href="#10-3-1-trap-and-emulate" class="headerlink" title="| 10.3.1 | trap-and-emulate"></a>| 10.3.1 | trap-and-emulate</h4><p>VMM å®Œå…¨ç”±è½¯ä»¶æ¨¡æ‹Ÿè™šæ‹Ÿæœº(VM)çš„æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯<u>å®Œå…¨è½¯ä»¶è™šæ‹ŸåŒ– CPU</u>æ˜¯å¯è¡Œçš„ï¼Œå¹¶ä¸”ç§»æ¤æ€§å¾ˆå¥½ï¼Œä½†æ˜¯æœ€å¤§çš„é—®é¢˜æ˜¯å®Œå…¨ç”±è½¯ä»¶æ¨¡æ‹Ÿä¼šå¾ˆæ…¢ã€‚</p>
<p>å½“ VM æ‰§è¡Œç‰¹æƒæŒ‡ä»¤()æ—¶ï¼ŒVMM ä» <em>trap</em> ä¸­æ¥æ‰‹ï¼Œæ¨¡æ‹Ÿæ‰§è¡Œç›¸åº”ç‰¹æƒæŒ‡ä»¤ã€‚</p>
<p>æ¯”å¦‚è™šæ‹Ÿæœº <code>ecall</code>ï¼Œä½†æ˜¯ä¼šé™·å…¥(trap)åˆ°å®¿ä¸»æœºå†…æ ¸(host kernel)ï¼Œç„¶åï¼ŒVMM æ¥æ‰‹ï¼ŒæŠŠç›¸å…³çš„ç‰¹æƒå¯„å­˜å™¨(<code>scause</code>, <code>sepc</code>, <code>stvac</code>â€¦)å¤åˆ¶åˆ° VMM é’ˆå¯¹è™šæ‹Ÿæœºæ¨¡æ‹Ÿçš„ç›¸åº”ç‰¹æƒå¯„å­˜å™¨ä¸­</p>
<p>ç„¶å <u>è®¾ç½®å®¿ä¸» <code>sepc</code> ä¸º æ¨¡æ‹Ÿçš„ <code>stvac</code> , è®¾ç½®è™šæ‹Ÿæœºæ¨¡å¼(mode bit)ä¸º <em>supervis mode</em> , ç„¶åå®¿ä¸»æœºæ‰§è¡Œ <code>sret</code> è¿”å›åˆ°è™šæ‹Ÿæœºå†…æ ¸(guest kernel)ã€‚</u></p>
<p>è¿™æ ·è™šæ‹Ÿæœºçš„å†…æ ¸æ‰èƒ½å¤„ç†æ¥è‡ªè™šæ‹Ÿæœºç”¨æˆ·æ€(guest userspace)çš„ <em>trap</em>ã€‚</p>
<p>å½“è™šæ‹Ÿæœºå†…æ ¸å¤„ç†ç»“æŸæ‰§è¡Œ <code>sret</code> çš„æ—¶å€™ï¼ŒåŒæ ·ä¼šé™·å…¥å®¿ä¸»æœºçš„å†…æ ¸(trap into host kernel), (å› ä¸ºè™šæ‹Ÿæœºå†…æ ¸å®é™…ä¸Šæ˜¯è¿è¡Œåœ¨å®¿ä¸»æœºçš„ç”¨æˆ·æ€)ç„¶åå®¿ä¸»æœºå†…æ ¸äº¤ç»™ VMM å¤„ç†ã€‚</p>
<p>VMM æ¨¡æ‹Ÿç›¸åº”æŒ‡ä»¤(æŠŠæ¨¡æ‹Ÿ <code>sepc</code> æ‹·è´åˆ° <code>pc</code>ï¼Œä¿®æ”¹è™šæ‹Ÿæœºä¸ºç”¨æˆ·æ¨¡å¼)å›åˆ°è™šæ‹Ÿæœºç”¨æˆ·æ€ã€‚æ•´ä¸ªè¿‡ç¨‹å°±åƒ guest userspace-&gt; guest kernel space -&gt; guest userspace ä¸€æ ·ã€‚</p>
<p>å¦ä¸€ä¸ªé—®é¢˜é¡µè¡¨(pagetable)ï¼ŒVMM ä¸èƒ½è®©è™šæ‹Ÿæœºè®¾ç½®çœŸæ­£çš„ <code>satp</code>ï¼Œè¿™æ ·ä¼šä½¿å¾—è™šæ‹Ÿæœºå¯ä»¥è®¿é—®ä»»æ„ç‰©ç†å†…å­˜ã€‚åŒæ—¶ VMM éœ€è¦æŠŠçœŸå®çš„ç‰©ç†åœ°å€(Host Physical Address)é’ˆå¯¹æ¯ä¸€ä¸ªè™šæ‹Ÿæœºï¼ŒæŠ½è±¡æˆè™šæ‹Ÿæœºçš„ç‰©ç†åœ°å€(Guest Physical Address)ã€‚</p>
<p>VMM å› æ­¤ç»´æŠ¤ä¸€ä¸ªå¯¹åº”æ˜ å°„è¡¨(shallow pagetable)ç”¨äºè®¾ç½®çœŸæ­£çš„ <code>satp</code> ä½¿ç”¨ MMU ç¿»è¯‘åœ°å€, <em>shallow pagetable</em>çš„å†…å®¹æ˜¯ gva:hpaã€‚</p>
<p>æœ€åæ˜¯è®¾å¤‡é—®é¢˜ã€‚</p>
<ul>
<li>VMM æ¨¡æ‹Ÿè®¾å¤‡ã€‚</li>
<li>VMM è™šæ‹Ÿè®¾å¤‡ï¼Œå¹¶æä¾›æ¥å£ç»™è™šæ‹Ÿæœºã€‚å› è€Œè™šæ‹Ÿæœºçš„è®¾å¤‡é©±åŠ¨å¯ä»¥ä¸ VMM å†…æ”¯æŒçš„è®¾å¤‡è¿›è¡Œé«˜æ•ˆäº¤äº’ï¼Œè€Œä¸æ˜¯éœ€è¦é™·å…¥ VMMã€‚</li>
<li><em>pass-through</em> ä¾‹å¦‚ç½‘å¡ã€‚</li>
</ul>
<h4 id="10-3-2-hardware-support"><a href="#10-3-2-hardware-support" class="headerlink" title="| 10.3.2 | hardware support"></a>| 10.3.2 | hardware support</h4><p>intel VT-x</p>
<ul>
<li>VMCS</li>
<li>EPT</li>
</ul>
<h4 id="10-3-3-Dune-Safe-User-level-Access-to-Privileged-CPU-Features"><a href="#10-3-3-Dune-Safe-User-level-Access-to-Privileged-CPU-Features" class="headerlink" title="| 10.3.3 | Dune: Safe User-level Access to Privileged CPU Features"></a>| 10.3.3 | Dune: Safe User-level Access to Privileged CPU Features</h4><p>ä¸€ä¸ª Linux æ¨¡å—(LKM)ï¼Œç»™æ™®é€šç¨‹åºæä¾›ä½¿ç”¨ intel VT-x çš„æ¥å£ï¼Œå®ç°æˆ–è€…ä¼˜åŒ–æ²™ç›’(sandbox)ï¼Œç”¨æˆ·å†…å­˜ç®¡ç†(memory management)ï¼Œ<em>garbage collector</em> ç­‰ã€‚</p>
<h3 id="10-4-LEC-20-note"><a href="#10-4-LEC-20-note" class="headerlink" title="| 10.4 | LEC 20 note"></a>| 10.4 | LEC 20 note</h3><h3 id="10-5-Lab-mmap"><a href="#10-5-Lab-mmap" class="headerlink" title="| 10.5 | Lab: mmap"></a>| 10.5 | <u><a target="_blank" rel="noopener" href="https://pdos.lcs.mit.edu/6.828/2020/labs/mmap.html">Lab: mmap</a></u></h3><img alt="å›¾ 11" src="/images/image-20240403100745.png" />  

<p><code>MAP_SHARED</code> çš„é—®é¢˜:</p>
<ul>
<li>å¯¹äºä¸¤ä¸ªè¿›ç¨‹åŒæ—¶ <code>MAP_SHARED</code> ç›¸åŒæ–‡ä»¶ï¼Œä¹‹åè¿›ç¨‹ 1 ä¿®æ”¹æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åœ¨ <code>munmap()</code> æ—¶å†™è¿›æ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶ä¸”è¿›ç¨‹ 2 ç”±äºåœ¨æ›´æ–°å‰è°ƒç”¨çš„ <code>mmap()</code>ï¼Œæ‰€ä»¥ä¸èƒ½çœ‹è§æ›´æ–°ï¼Œé™¤éè¿›ç¨‹ 1 è°ƒç”¨ <code>msync()</code> å¹¶ä¸”æŒ‡å®š <code>MS_INVALIDATE</code> æ ‡è®°è¿›ç¨‹ 2 ç›¸åº”åœ°å€æ— æ•ˆï¼Œä½¿å¾—è¿›ç¨‹ 2 é‡æ–°è¯»æ–‡ä»¶ã€‚</li>
<li>æ‰€ä»¥å¯¹äº <code>MAP_SHARED</code> çš„ä¿®æ”¹ï¼Œè¿™é‡Œç›´æ¥å†™å›åŸæ¥çš„ä½ç½®å³å¯ï¼Œä¸ç”¨ç®¡æ˜¯å¦å…¶ä»–è¿›ç¨‹å·²ç» <code>mmap()</code> ç›¸åŒæ–‡ä»¶ã€‚</li>
<li>ä¸è¿‡åœ¨ Linux ä¸Šæµ‹è¯•æ—¶å‘ç°ï¼Œè¿›ç¨‹ 2 èƒ½å¤ŸåŠæ—¶å‘ç°æ”¹å˜ï¼Œåº”è¯¥æ˜¯ Linux åœ¨å®ç°ä¸Šä¸¤ä¸ªè¿›ç¨‹ç”¨çš„åŒä¸€ä¸ªç¼“å†²åŒºçš„ç¼˜æ•…ã€‚</li>
</ul>
<p><code>MAP_PRIVATE</code> çš„é—®é¢˜ï¼š</p>
<ul>
<li>å³ä½¿ <em>fd</em> å¯¹åº”çš„æ–‡ä»¶ä¸å¯å†™ï¼Œä½†æ˜¯å¦‚æœè®¾ç½®äº† <code>MAP_PRIVATE</code> ä»ç„¶å¯ä»¥ã€‚</li>
</ul>
<p><em>addr</em> ä¸º 0 çš„é—®é¢˜:</p>
<ul>
<li>æ­¤æ—¶æ„å‘³ç€ å†…æ ¸å¿…é¡»é€‰æ‹©ä¸€ä¸ªâ€åˆé€‚â€çš„åœ°å€ã€‚</li>
<li>xv6 çš„ <code>sbrk()</code> ä¼šä¸€ç›´å¢åŠ è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œç›´åˆ°æ²¡æœ‰å†…å­˜å¯ä»¥åˆ†é…ã€‚</li>
<li>å¹¶ä¸” <code>mmap()</code> åªæ˜¯æŠŠæ–‡ä»¶æ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œä¸åº”è¯¥å¢åŠ  <code>proc-&gt;sz</code></li>
<li>å› è€Œ <code>mmap()</code> é€‰æ‹©çš„åœ°å€åº”è¯¥å’Œ <code>sbrk()</code> åˆ†å¼€ã€‚</li>
</ul>
<p><em>length</em> å’Œ <em>off</em> çš„é—®é¢˜ï¼š</p>
<ul>
<li><em>length</em> ä¸ç”¨é™åˆ¶ï¼Œå¦‚æœè¶…å‡ºæ–‡ä»¶çš„å¤§å°ï¼Œä¹Ÿæ²¡äº‹ï¼Œå› ä¸ºä¼šæ ¹æ® <em>length</em> åˆ†é…ç‰©ç†å†…å­˜ã€‚</li>
<li><em>off</em> å¤§äºæ–‡ä»¶çš„å¤§å°åˆ™åº”è¯¥è¿”å›é”™è¯¯ã€‚</li>
<li><code>readi()</code>, å’Œ <code>writei()</code> éƒ½åº”è¯¥åŸºäº <em>off</em>ã€‚</li>
</ul>
<p><code>munmp()</code>é—®é¢˜ï¼š</p>
<ul>
<li><code>munmap()</code> ä¹‹åï¼Œè®¿é—® [addr, addr+length) æ˜¯éæ³•çš„ã€‚</li>
<li>å¦‚æœ <em>length</em> ä¸æ˜¯é¡µå¯¹å…¶çš„ï¼Œåº”è¯¥å‘ä¸Šå–æ•´ï¼Œå› ä¸ºä¹‹å‰ <code>mmap()</code> çš„æ—¶å€™ä¸è¶³ä¸€é¡µçš„ä¼šè¡¥é½ã€‚</li>
<li>å¦‚æœ <code>mmap()</code> äº†è¿ç»­çš„ 3 é¡µï¼Œä½†æ˜¯åª <code>munmap()</code> ç¬¬äºŒé¡µï¼Œå…¶ä»–ä¸¤é¡µåº”è¯¥ç»§ç»­æœ‰æ•ˆï¼Œè¿™æ˜¯éœ€è¦å†æ‰¾ä¸€ä¸ª VMAï¼Œä½†æ˜¯ <code>mmaptest</code> æ²¡æœ‰è¿™ç§æƒ…å†µï¼Œæ‰€ä»¥æš‚æ—¶ä¸è€ƒè™‘ã€‚</li>
<li><u><strong>ç”±äºæˆ‘ä»¬æ˜¯å»¶è¿Ÿæ˜ å°„(<em>lazy mmap</em>) æ‰€ä»¥åœ¨ <code>munmap()</code> çš„æ—¶å€™ï¼Œ<code>walk()</code> è¿”å› 0 æˆ–è€… <code>PTE_V</code> æ˜¯ 0 æ˜¯å¾ˆæ­£å¸¸çš„ã€‚</strong></u>ã€‚</li>
</ul>
<p><code>fork()</code> é—®é¢˜ï¼š</p>
<ul>
<li>å­è¿›ç¨‹å¯ä»¥çœ‹è§çˆ¶è¿›ç¨‹ <code>MAP_PRIVATE</code> çš„æ”¹å˜ã€‚</li>
<li>æ‰€ä»¥å­è¿›ç¨‹åº”è¯¥å®Œå…¨å¤åˆ¶ä¸€ä»½çˆ¶è¿›ç¨‹çš„ VMA ç©ºé—´(è¿™é‡Œå°±ä¸å®ç° COW äº†)ã€‚</li>
<li>å¦‚æœå­è¿›ç¨‹åœ¨ <code>uvmcopy()</code> ç¬¬ä¸€ä¸ªä»¥åçš„ VMA å¤±è´¥äº†(æ¯”å¦‚å½“çˆ¶è¿›ç¨‹ mmap äº†å¾ˆå¤§çš„æ–‡ä»¶ï¼Œå¹¶ä¸”éƒ½åˆ†é…äº†å†…å­˜)ï¼Œåº”è¯¥é‡Šæ”¾åœ¨å‰é¢åˆ†é…çš„ VMAï¼Œå¦åˆ™å°±ä¼šæŸå¤±è¿™äº› VMAï¼Œè¿™ä¸ªè¿˜æ²¡å®ç°ã€‚</li>
</ul>
<p>ğŸ“Œ <u><a target="_blank" rel="noopener" href="https://github.com/sev1n75/xv6-riscv/commit/447462ee25dccd2739b8c1c5a7c419938aff2603">è¿™éƒ¨åˆ†ä»£ç åœ¨è¿™é‡Œ</a></u></p>
<h2 id="11-Lab-net-ç›¸å…³"><a href="#11-Lab-net-ç›¸å…³" class="headerlink" title="| 11 | Lab net ç›¸å…³"></a>| 11 | Lab net ç›¸å…³</h2><p>ååŠå­¦æœŸæœ‰ä¸€é—¨ ã€Šç½‘ç»œåè®®æ ˆåˆ†æã€‹çš„è¯¾ï¼Œç•™åœ¨åé¢å§ã€‚</p>
<!-- ### | 11.1 | LEC 21 note

### | 11.2 | <u>[Lab: networking](https://pdos.lcs.mit.edu/6.828/2020/labs/net.html)</u>

## | 12 | Meltdown & RCU

### | 12.1 | LEC 22 note

### | 12.2 | LEC 23 note

## | 13 | æ€»ç»“

### | 13.1 | ä»€ä¹ˆæ˜¯å†…æ ¸ï¼Œä¸ºä»€ä¹ˆéœ€è¦å†…æ ¸

#### | 13.1.1 | ä»€ä¹ˆæ˜¯å†…æ ¸

æœ¬è´¨ä¸Šï¼Œå†…æ ¸åªæ˜¯ä¸€æ®µç¨‹åºè€Œå·²ï¼Œæˆ–è€…è¯´ä¸€ä¸ªè½¯ä»¶ã€‚CPU åŒæ ·ä¹Ÿæ˜¯å–æŒ‡ï¼Œå…¼æŒ‡ï¼Œæ‰§è¡Œï¼Œå¾€å¤å¾ªç¯ã€‚

å’Œæ™®é€šç¨‹åº(ç”¨æˆ·æ€ç¨‹åº)ç›¸æ¯”ï¼Œå†…æ ¸æ‹¥æœ‰æ›´é«˜çš„æƒé™ï¼Œæœ‰è¿›ä¸€æ­¥è®¿é—®ç‰©ç†ç¡¬ä»¶èƒ½åŠ›ã€‚æ¯”å¦‚ RISCVï¼Œå†…æ ¸é€šå¸¸è¿è¡Œåœ¨ *superviser mode*ï¼Œå¯ä»¥è¯»å†™éƒ¨åˆ†ç‰¹æƒå¯„å­˜å™¨ã€‚

#### | 13.1.2 | ä¸ºä»€ä¹ˆéœ€è¦å†…æ ¸

### | 13.2 | å†…æ ¸è¦æ»¡è¶³å“ªäº›éœ€æ±‚ï¼Œå¦‚ä½•å®ç° -->

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/OS/">OS</a><a href="/tags/MIT/">MIT</a><a href="/tags/Experiment/">Experiment</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Deployed by <a href="https://github.com/kaedea/notion-down" target="_blank">notion-down</a> and
    Theme by <a href="https://github.com/kaedea/hexo-theme-hacker" target="_blank">hexo-theme-hacker</a>
    </br>
    
      &copy; 2024
        sev1n75 &lt;sev1n75@qq.com&gt;
          
  </p>
</footer>
    
  </div>
</div>
</body>
</html>