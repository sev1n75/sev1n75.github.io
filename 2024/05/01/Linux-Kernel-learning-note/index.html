<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
    <title>
      Linux-Kernel å­¦ä¹ ç¬”è®° | sev1n75 | Binary Exploit</title>

  
  <meta name="author" content="sev1n75">
  

  
  <meta name="description" content="CTF Pwn é€‰æ‰‹ï¼Œä»¥æ­¤åšå®¢åˆ†äº«æŠ€æœ¯å’Œå­¦ä¹ è¿‡ç¨‹">
  

  
  
  <meta name="keywords" content="Linux Kernel,OS,Memory Management,note">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="Linux-Kernel å­¦ä¹ ç¬”è®°"/>

  <meta property="og:site_name" content="sev1n75"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/images/favicon.png" type="image/png" rel="icon">
  <link href="/images/favicon.png" rel="apple-touch-icon" sizes="76x76">
  <link rel="alternate" href="/atom.xml" title="sev1n75" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  
  <link href="https://fonts.lug.ustc.edu.cn/css?family=Lato|Rubik" rel="stylesheet">
  <script src="/js/pangu-407.min.js"></script>
<meta name="generator" content="Hexo 6.3.0"></head>
<script>
  document.addEventListener(' DOMContentLoaded', () => {
    pangu.autoSpacingPage();
  });
</script>

<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">
        sev1n75's Tech Blog
      </a>
    </h1>
    <p class="site-description">
      
        è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®ï¼Œå¾å°†ä¸Šä¸‹è€Œæ±‚ç´¢
          
    </p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">
            ä¸»é¡µ
          </a></li>
        
        <li><a href="/archives">
            å½’æ¡£
          </a></li>
        
        <li><a href="/tags">
            æ ‡ç­¾
          </a></li>
        
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>Linux-Kernel å­¦ä¹ ç¬”è®°</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2024/05/01/Linux-Kernel-learning-note/" rel="bookmark">
        <time class="entry-date published" datetime="2024-05-01T06:21:05.000Z">
          2024-05-01
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        

<script type="text/javascript">
    function convertRemToPixels(rem) {    
        return rem * parseFloat(getComputedStyle(document.documentElement).fontSize);
    }
    window.onscroll = function() {
        var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        if (scrollTop > convertRemToPixels(40)) {
            document.getElementsByClassName('toc-article')[0].style.visibility = 'visible';
        } else {
            document.getElementsByClassName('toc-article')[0].style.visibility = 'hidden';
        }
    }
</script>


<div id="toc" class="toc-article">
      <div class="toc-content">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0-%E5%89%8D%E8%A8%80"><span class="toc-text">| 0 | å‰è¨€</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Understanding-the-Linux-Virtual-Memory-Manager-online-book-by-Mel-Gorman-2007"><span class="toc-text">| 1 | Understanding the Linux Virtual Memory Manager, online book by Mel Gorman, 2007.</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E7%BB%84%E7%BB%87%E7%89%A9%E7%90%86%E5%86%85%E5%AD%98-1-4-5%E7%AB%A0"><span class="toc-text">| 1.1 | ç»„ç»‡ç‰©ç†å†…å­˜(1-4.5ç« )</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8-4-6%E7%AB%A0"><span class="toc-text">| 1.2 | ç¼ºé¡µå¼‚å¸¸(4.6ç« )</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D-5-8%E7%AB%A0"><span class="toc-text">| 1.3 | å†…å­˜åˆ†é…(5-8ç« )</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E5%85%B6%E4%BB%96-9-13%E7%AB%A0"><span class="toc-text">| 1.4 | å…¶ä»–(9-13ç« )</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Kernel-Exploring-richardweiyang"><span class="toc-text">| 2 | Kernel Exploring, richardweiyang</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%86%85%E6%A0%B8%E5%8A%A0%E8%BD%BD%E5%85%A8%E6%B5%81%E7%A8%8B"><span class="toc-text">| 2.1 | å†…æ ¸åŠ è½½å…¨æµç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86"><span class="toc-text">| 2.2 | å†…å­˜ç®¡ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E5%86%85%E6%A0%B8%E9%A1%B5%E8%A1%A8%E6%88%90%E9%95%BF%E8%AE%B0"><span class="toc-text">| 2.2.1 | å†…æ ¸é¡µè¡¨æˆé•¿è®°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E8%87%AA%E5%BA%95%E5%90%91%E4%B8%8A%E8%AF%9D%E5%86%85%E5%AD%98"><span class="toc-text">| 2.2.2 | è‡ªåº•å‘ä¸Šè¯å†…å­˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%A9%BA%E9%97%B4"><span class="toc-text">| 2.2.3 | è™šæ‹Ÿå†…å­˜ç©ºé—´</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-arttnba3-%E3%80%90OS-0x02-0x04%E3%80%91Linux-%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E9%A1%B5%E3%80%81%E5%8C%BA%E3%80%81%E8%8A%82%E7%82%B9%EF%BC%8CBuddy-System%EF%BC%8CSlub-Allocator"><span class="toc-text">| 3 | arttnba3 -ã€OS.0x02-0x04ã€‘Linux å†…æ ¸å†…å­˜ç®¡ç†-é¡µã€åŒºã€èŠ‚ç‚¹ï¼ŒBuddy Systemï¼ŒSlub Allocator</span></a></li></ol>
      </div>
</div>
<style>
        .toc-level-3 i,
        .toc-level-3 ol {
            display: none !important;
        }
    </style>



        <h2 id="0-å‰è¨€"><a href="#0-å‰è¨€" class="headerlink" title="| 0 | å‰è¨€"></a>| 0 | å‰è¨€</h2><p>Linux Kernel å­¦ä¹ ç¬”è®°ã€‚</p>
<blockquote>
<p>âœ… æœ€è¿‘ä¸€æ¬¡æ›´æ–°ï¼š2024-5-8</p>
</blockquote>
<p>Todo:(ä»¥åé‡åˆ°äº†å†è¯¦ç»†è¡¥å……åˆ°ç¬”è®°é‡Œ)</p>
<ul>
<li><p><u><a target="_blank" rel="noopener" href="https://richardweiyang-2.gitbook.io/kernel-exploring">Kernel Exploring</a></u> - |2|</p>
<ul>
<li>å†…å­˜ç®¡ç†ï¼ˆè™šæ‹Ÿå†…å­˜ç©ºé—´ï¼‰</li>
<li>ä¸­æ–­ä¸å¼‚å¸¸</li>
<li>KVM</li>
<li>cgroup</li>
<li>è€å¸æœºå¸¦ä½ æ¢ç´¢å†…æ ¸ç¼–è¯‘ç³»ç»Ÿ</li>
</ul>
</li>
<li><p>v6 buddy&amp;slub è¯¦ç»†ç†è§£ - |3|</p>
</li>
<li><p><u><a target="_blank" rel="noopener" href="https://hustseclab.gitbook.io/linux-insides-zh">linux-insides-zh</a></u></p>
<ul>
<li>å¼•å¯¼</li>
<li>åˆå§‹åŒ–</li>
</ul>
</li>
<li><p><u><a target="_blank" rel="noopener" href="https://docs.kernel.org/arch/x86/index.html">x86-specific Documentation</a></u></p>
<ul>
<li>29.x86_64 Supportâ€“29.3, 29.4, 29.7, 29.8</li>
<li>15.Control-flow Enforcement Technology (CET) Shadow Stack</li>
<li>21.Page Table Isolation (PTI)</li>
</ul>
</li>
<li><p><u><a target="_blank" rel="noopener" href="https://docs.kernel.org/filesystems/">Filesystems in the Linux kernel</a></u></p>
</li>
<li><p><u><a target="_blank" rel="noopener" href="https://docs.kernel.org/driver-api/">Driver implementerâ€™s API guide</a></u></p>
<ul>
<li>TEE (Trusted Execution Environment) driver API</li>
<li>TTY</li>
</ul>
</li>
<li><p>Page Cache</p>
</li>
<li><p>|1.4| å‰©ä½™å†…å®¹</p>
<!-- - Memblock æ•´ä½“æ¢³ç† mm/memblock.c |1.3| --></li>
<li><p>â€¦</p>
</li>
</ul>
<span id="more"></span>

<h2 id="1-Understanding-the-Linux-Virtual-Memory-Manager-online-book-by-Mel-Gorman-2007"><a href="#1-Understanding-the-Linux-Virtual-Memory-Manager-online-book-by-Mel-Gorman-2007" class="headerlink" title="| 1 | Understanding the Linux Virtual Memory Manager, online book by Mel Gorman, 2007."></a>| 1 | <u><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/gorman/html/understand/understand005.html">Understanding the Linux Virtual Memory Manager</a></u>, online book by Mel Gorman, 2007.</h2><p>è¿™æœ¬ä¹¦ä¸»è¦ä»‹ç» i386 æ¶æ„ä¸‹çš„ v2.4.22 å†…æ ¸ï¼Œæ¯”è¾ƒä¹…è¿œã€‚æ‰€ä»¥ä¸»è¦æ˜¯ä»å®è§‚ä¸Šæ•´ä½“ç†Ÿæ‚‰ Linux å†…æ ¸ç®¡ç†å†…å­˜çš„åŸºæœ¬æµç¨‹å³å¯ï¼Œæ²¡å¿…è¦åœ¨è€ç‰ˆæœ¬çº ç»“ç»†èŠ‚ã€‚<del>å½“éœ€è¦ç†Ÿæ‚‰ç»†èŠ‚å†…å®¹(é€šå¸¸æ˜¯ç›®å‰æœ€æ–°çš„å†…æ ¸)æ—¶ï¼Œæœ‰äº†æ•´ä½“çš„æŠŠæ¡èƒ½å¤Ÿæ›´è½»æ¾ã€‚</del>ï¼ˆå®Œå…¨ä¸ä¼šï¼‰</p>
<blockquote>
<p>å½“ç„¶è¿™ä¹ˆè€ä¸”ç»å…¸çš„ä¹¦åº”è¯¥æ˜¯æœ‰ç¿»è¯‘çš„ <u>ğŸ”— <a target="_blank" rel="noopener" href="https://groups.google.com/g/2012-ustc-linux-kernel/c/oMmfFK-9u84">ç¿»è¯‘ç‰ˆ</a></u>ã€‚</p>
<p>å¤§ä½¬çš„ç¬”è®° <u>ğŸ”— <a target="_blank" rel="noopener" href="https://github.com/lorenzo-stoakes/linux-gorman-book-notes">linux-gorman-book-notes, Lorenzo Stoakes</a></u>ã€‚</p>
</blockquote>
<p>ç¬¬ä¸€ç« ç®€å•ä»‹ç»äº† <em>Configure&amp;Build</em>ï¼Œ<em>Managing the Source</em>ï¼Œ<em>Browsing the Code</em>ï¼Œä¸‰ä¸ªæ–¹é¢ã€‚</p>
<p>ç°åœ¨çš„æ–¹æ³•å’Œåå‡ å¹´å‰æœ‰ä¸€äº›åŒºåˆ«ï¼š</p>
<ul>
<li>é…ç½®å’Œç¼–è¯‘ï¼šä»¥å‰ä½¿ç”¨ <em>autoconf</em> å·¥å…·åŠ ä¸Š <em>configure</em> è„šæœ¬ã€‚ç°åœ¨é€šè¿‡åŸºäº <em>Makefile</em> çš„ <em>Kconfig + Kbuild</em>ã€‚</li>
<li>ç®¡ç†æºç ï¼šè¿™æœ¬ä¹¦åº”è¯¥æ˜¯ 03ï¼Œ04 å¹´å†™çš„ï¼ŒLinus è¿˜æ²¡å¼€å‘ <em>Git</em>ã€‚ä¹¦ä¸Šä»‹ç»äº† <em>Diff+Patch</em>ã€‚ç°åœ¨åŸºæœ¬ä½¿ç”¨ <em>Git</em> ç®¡ç†æºç ã€‚</li>
<li>æµè§ˆä»£ç ï¼šä¹¦ä¸Šæ¨è <em>vim+ctags</em>ï¼Œæˆ–è€… LXRã€‚äººç”Ÿè‹¦çŸ­ï¼Œæˆ‘ç”¨ <em>neovim+telescope+ctags</em> (<code>make cscope/tags</code> å³å¯ç”Ÿæˆ cscope&#x2F;ctags æ–‡ä»¶)ã€‚åœ¨çº¿ç½‘ç«™ <u><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/latest/source">elixir bootlin</a></u></li>
</ul>
<p>åç»­å†…å®¹å°±ä¸»è¦çœ‹ Lorenzo Stoakes çš„ç¬”è®°äº†ã€‚é‡ç‚¹è®°å½•å®è§‚çš„å†…å®¹ï¼Œå’Œè‡ªå·±çš„ç†è§£ï¼Œç»†èŠ‚éƒ¨åˆ†æ¯”å¦‚æŸäº›ç»“æ„ä½“åŸŸçš„æ„ä¹‰ä¹‹ç±»çš„å°±æ²¡å¿…è¦ç…§æŠ„äº†ï¼ŒåŸæ–‡é‡Œéƒ½æœ‰ã€‚</p>
<h3 id="1-1-ç»„ç»‡ç‰©ç†å†…å­˜-1-4-5ç« "><a href="#1-1-ç»„ç»‡ç‰©ç†å†…å­˜-1-4-5ç« " class="headerlink" title="| 1.1 | ç»„ç»‡ç‰©ç†å†…å­˜(1-4.5ç« )"></a>| 1.1 | ç»„ç»‡ç‰©ç†å†…å­˜(1-4.5ç« )</h3><p><strong>2.3</strong> zone åˆå§‹åŒ–: <code>zone_size_init()</code>ï¼Œä¹‹å‰è¿˜è¦è°ƒç”¨ <code>setup_memory()</code> è®¡ç®— zone çš„å¤§å°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// i386</span></span><br><span class="line">start_kernel()</span><br><span class="line">    setup_arch()</span><br><span class="line">        setup_memory() </span><br><span class="line">        paging_init()</span><br><span class="line">            pagetable_init()</span><br><span class="line">            zone_sizes_init()</span><br><span class="line">                free_area_init()</span><br><span class="line">                    free_area_init_core()</span><br></pre></td></tr></table></figure>

<p><strong>2.6</strong> page åˆ° zone çš„æ˜ å°„å…³ç³»</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// linclude/linux/mm.h:344 set_page_zone()</span></span><br><span class="line">page-&gt;flags &amp;= ~(~<span class="number">0UL</span> &lt;&lt; ZONE_SHIFT);   <span class="comment">// ç•™ä¸‹äº†ä½ ZONE_SHIFT ç»™ flag</span></span><br><span class="line">page-&gt;flags |= zone_num &lt;&lt; ZONE_SHIFT;  <span class="comment">// é«˜ä½å­˜æ”¾ zone_num</span></span><br></pre></td></tr></table></figure>

<p><strong>3.2</strong> æè¿°é¡µè¡¨é¡¹(Page Tabel Entry)</p>
<ul>
<li><p>ä¸¤ä¸ªéœ€è¦æ³¨æ„çš„æ ‡å¿—(flag):</p>
<ul>
<li><code>_PAGE_PRESENT</code>: è¡¨ç¤ºè¯¥é¡µä»åœ¨å†…å­˜ä¸­ï¼Œæ²¡æœ‰è¢«æ¢å‡º(swapped out)ã€‚</li>
<li><code>_PAGE_PROTNONE</code>: è¡¨ç¤º non-present é¡µï¼Œç”¨æ¥åŒºåˆ«è¢«æ¢å‡ºçš„é¡µã€‚</li>
</ul>
</li>
<li><p><code>pte_present(x)</code>: å½“è¯¥é¡µè¢«æ¢å‡ºæ—¶è¿”å›0ã€‚(å­˜åœ¨ <code>_PAGE_PRESENT</code> æ²¡è®¾ç½®è€Œ <code>_PAGE_PROTNONE</code> è¢«è®¾ç½®çš„æƒ…å†µå—)</p>
</li>
</ul>
<p><strong>3.6</strong> åˆ†é¡µ(<em>paging</em>)åˆå§‹åŒ–: <code>pagetable_init()</code></p>
<ul>
<li><code>arch/i386/kernel/head.S:44 startup_32</code> åˆå§‹åŒ–é¡µè¡¨ï¼ŒåŒ…å«ä¸¤ä¸ªé¡µ(<code>pg0, pg1</code>)</li>
<li>è°ƒç”¨ <code>pagetable_init()</code>ï¼ˆè°ƒç”¨é“¾è§ä¸Šé¢ 2.3 èŠ‚ç¬”è®°ï¼‰ åˆå§‹åŒ–è®¿é—® <code>ZONE_DMA</code> å’Œ <code>ZONE_NORMAL</code> æ‰€éœ€çš„é¡µè¡¨ã€‚</li>
</ul>
<h3 id="1-2-ç¼ºé¡µå¼‚å¸¸-4-6ç« "><a href="#1-2-ç¼ºé¡µå¼‚å¸¸-4-6ç« " class="headerlink" title="| 1.2 | ç¼ºé¡µå¼‚å¸¸(4.6ç« )"></a>| 1.2 | ç¼ºé¡µå¼‚å¸¸(4.6ç« )</h3><ul>
<li><p>æœ‰ä¸¤ç§ï¼šä¸¥é‡(major)å’Œè½»å¾®(miner)ã€‚å½“å¿…é¡»ä»ç£ç›˜è¯»æ•°æ®çš„æ—¶ç¼ºé¡µé”™è¯¯æ˜¯ä¸¥é‡(major)çš„é”™è¯¯ã€‚</p>
</li>
<li><p>ç¼ºé¡µé”™è¯¯çš„å‡ ç§æƒ…å†µï¼š</p>
<p>åºå·. ç¨‹åº¦ - æè¿° - è§£å†³æ–¹æ³•</p>
<ol>
<li>è½»å¾® - åœ°å€åœ¨å†…å­˜åŒºåŸŸ(memory region&#x2F;VMA)æœ‰æ•ˆï¼Œä½†é¡µé¢æœªåˆ†é… - åˆ†é…é¡µã€‚</li>
<li>è½»å¾® - åœ°å€åœ¨å†…å­˜åŒºåŸŸæ— æ•ˆï¼Œä½†ä½äºå¯æ‰©å±•åŒºåŸŸï¼ˆå¦‚æ ˆï¼‰æ—è¾¹ - æ‰©å±•åŒºåŸŸå¹¶åˆ†é…é¡µã€‚</li>
<li>è½»å¾® - é¡µé¢å·²è¢«æ¢å‡º(swapped out)ï¼Œä½†å­˜åœ¨äºäº¤æ¢ç¼“å­˜(swap cache)ä¸­ - åœ¨è¿›ç¨‹é¡µè¡¨ä¸­é‡æ–°å»ºç«‹é¡µé¢å¹¶åˆ é™¤å¯¹è¯¥ç¼“å­˜çš„å¼•ç”¨è®¡æ•°(ref count)ã€‚</li>
<li>ä¸¥é‡ - é¡µé¢äº¤æ¢åˆ°åå¤‡å­˜å‚¨(backing storage)ä¸­ - æ‰¾åˆ°è¯¥é¡µï¼Œç„¶åä»ç£ç›˜è¯»å‡ºæ¥ã€‚</li>
<li>è½»å¾® - å†™ä¸€ä¸ªåªè¯»çš„é¡µ - å¦‚æœè¯¥é¡µæ˜¯ COW é¡µï¼Œåˆ™å¤åˆ¶ç„¶åæ ‡è®°ä¸ºå¯å†™åˆ†é…ç»™è¿›ç¨‹ï¼Œå¦åˆ™å‘é€ <code>SIGSEGV</code>ã€‚</li>
<li>é”™è¯¯ - åœ°å€æ‰€åœ¨å†…å­˜åŒºåŸŸæ— æ•ˆæˆ–è¿›ç¨‹æ— æƒè®¿é—® - å‘é€ <code>SIGSEGV</code>ã€‚</li>
<li>è½»å¾® - å¼‚å¸¸åœ°å€ä½äºå†…æ ¸åœ°å€ç©ºé—´ - å¦‚åœ¨ vmalloc åŒºåŸŸï¼Œåˆ™å½“å‰è¿›ç¨‹é¡µè¡¨å°†æ ¹æ® <code>init_mm</code> ä¿å­˜çš„é¡µè¡¨è¿›è¡Œæ›´æ–°ã€‚åŒæ—¶è¿™æ˜¯æœ‰æ•ˆçš„å†…æ ¸ç¼ºé¡µå¼‚å¸¸ã€‚</li>
<li>é”™è¯¯ - åœ¨å†…æ ¸æ¨¡å¼ä¸‹ï¼Œç¼ºé¡µåœ°å€ä½äºç”¨æˆ·åœ°å€ç©ºé—´ - è¿™ä¸åº”è¯¥å‘ç”Ÿï¼Œå¦‚æœå‘ç”Ÿæ„å‘³ç€å†…æ ¸ä»£ç æœªæ­£ç¡®ä½¿ç”¨æ¥è‡ªä»ç”¨æˆ·ç©ºé—´çš„åœ°å€ä»è€Œå¯¼è‡´ç¼ºé¡µå¼‚å¸¸ã€‚éœ€è¦éå¸¸ä¸¥è‚ƒåœ°å¯¹å¾…ã€‚</li>
</ol>
</li>
</ul>
<p><strong>å¤„ç†</strong>ç¼ºé¡µå¼‚å¸¸</p>
<ul>
<li><p>ç¼ºé¡µå¼‚å¸¸çš„é¡¶å±‚å‡½æ•°(page fault handler) <code>do_page_fault()</code>:</p>
<p>è´Ÿè´£ç¡®å®šå‘ç”Ÿäº†å“ªç§ç±»å‹çš„å¼‚å¸¸ï¼Œåˆ¤æ–­æ­£ç¡®æ€§(æ¯”å¦‚å¦‚æœå†…å­˜åŒºåŸŸæ— æ•ˆï¼Œä½†æ˜¯ç¬¦åˆæƒ…å†µ <code>2.</code>ï¼Œåˆ™ä¼šè°ƒç”¨ <code>expand_stack(vma, address)</code>)ç„¶åè°ƒç”¨ <code>handle_mm_fault()</code>ã€‚</p>
<p>ä¾èµ–ä¸åŒçš„ CPU æ¶æ„ã€‚</p>
<p><u><a target="_blank" rel="noopener" href="https://github.com/lorenzo-stoakes/linux-gorman-book-notes/blob/master/4.md#461-handing-a-page-fault">ğŸ”— å‡½æ•°å¤„ç†æµç¨‹å›¾</a></u></p>
</li>
<li><p><code>handel_mm_fault()</code></p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">handle_mm_fault() --------&gt; handel_pte_fault()</span><br><span class="line">                                 |</span><br><span class="line">                                /|\</span><br><span class="line">                               / | \</span><br><span class="line">                              /  |  \</span><br><span class="line">                             +   |   \</span><br><span class="line">                             |   |    \</span><br><span class="line">                             v   |     \</span><br><span class="line">                   do_no_page()  |      \</span><br><span class="line">                                 v       +</span><br><span class="line">                      do_swap_page()     | </span><br><span class="line">                                         v</span><br><span class="line">                               do_wp_page()</span><br></pre></td></tr></table></figure>

<p><code>handel_pte_fault()</code> è§£å†³äº†ä»¥ä¸‹å‡ ç§å¼‚å¸¸ï¼š</p>
<ul>
<li>é¡µé¢ä¸å­˜åœ¨: <code>do_no_page()</code><ul>
<li><code>1. 6. 7. 8.</code></li>
</ul>
</li>
<li>é¡µé¢è¢«æ¢å‡º: <code>do_swap_page()</code><ul>
<li><code>3. 4.</code></li>
</ul>
</li>
<li>é¡µé¢ä¸å¯è¯»: <code>do_wp_page()</code><ul>
<li><code>5. 6.</code></li>
</ul>
</li>
<li>å½“é¡µé¢åœ¨å†…å­˜ä¸­ä¸”å¯è¯»æ—¶ä¹Ÿä¼šé‡åˆ°é”™è¯¯ï¼Œè¿™ç§æƒ…å†µå‘ç”Ÿåœ¨æŸäº›æ²¡æœ‰ 3 çº§é¡µè¡¨çš„ä½“ç³»ç»“æ„ä¸­</li>
</ul>
</li>
<li><p>æ³¨æ„ï¼š</p>
<ul>
<li>å†…æ ¸é€šè¿‡è¯¥åŒºåŸŸçš„ VMA æ˜¯å¦å¯å†™åˆ¤æ–­ COW é¡µé¢ï¼Œæ— éœ€ PTE_C æ ‡è¯†ä½(flag)</li>
<li>VMA å¯ä»¥é€šè¿‡ <code>v_op</code> æ³¨å†Œ <code>nopage()</code> ç‰¹æ®Šçš„å¤„ç†å‡½æ•°ã€‚é»˜è®¤ <code>do_anonymous_page()</code></li>
</ul>
</li>
</ul>
<h3 id="1-3-å†…å­˜åˆ†é…-5-8ç« "><a href="#1-3-å†…å­˜åˆ†é…-5-8ç« " class="headerlink" title="| 1.3 | å†…å­˜åˆ†é…(5-8ç« )"></a>| 1.3 | å†…å­˜åˆ†é…(5-8ç« )</h3><p><strong>5.</strong> Boot Memory Allocator</p>
<ul>
<li><p>åœ¨å†…æ ¸å¯åŠ¨é˜¶æ®µï¼Œå†…å­˜è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼ŒåŒæ—¶å…¶ä»–çš„å†…å­˜åˆ†é…å™¨ä¹Ÿéœ€è¦ä¸€äº›å†…å­˜æ¥åˆå§‹åŒ–è‡ªå·±ï¼Œæ‰€ä»¥ Boot Memory Allocator å°±æ˜¯è´Ÿè´£åœ¨å†…æ ¸å¯åŠ¨çš„æ—©æœŸç®€å•åˆ†é…å†…å­˜çš„ã€‚</p>
<p>ä½†æ˜¯è¿™ä¸ªæœºåˆ¶å¤§æ¦‚åœ¨ v4 ç‰ˆæœ¬çš„å†…æ ¸è¢« <em>Memblock</em> æŠ€æœ¯å–ä»£äº†ã€‚<u><a target="_blank" rel="noopener" href="https://tinylab.org/lwn-761215/">ğŸ”— å‚è€ƒé“¾æ¥</a></u></p>
</li>
</ul>
<p><strong>6. Buddy System</strong> ç‰©ç†å†…å­˜åˆ†é…</p>
<ul>
<li>åˆ†é…(alloc): <code>__alloc_pages()</code></li>
<li>é‡Šæ”¾(free): <code>__free_pages_ok()</code></li>
<li>GFP(Get Free Page) Flags:<ul>
<li>å†³å®š allocator å’Œ <code>kswapd</code> åœ¨åˆ†é…å’Œé‡Šæ”¾é¡µçš„è¡Œä¸ºã€‚</li>
<li>GFP åˆ†ä¸ºä¸‰ç»„ï¼š<em>zone modifiers</em>, <em>action modifiers</em>, <em>high-level action modifiers</em> (ä½çº§ action modifiers çš„ç»„åˆ)</li>
</ul>
</li>
</ul>
<p><strong>7. è™šæ‹Ÿè¿ç»­ä½†ç‰©ç†éè¿ç»­</strong>å†…å­˜åˆ†é…</p>
<ul>
<li><code>____VMALLOC_RESERVE = 128 &lt;&lt; 20</code> è¡¨ç¤º <code>vmalloc()</code> èƒ½åˆ†é…çš„æœ€å°å¤§å°ã€‚</li>
<li>ç”±äº <code>vmalloc()</code> çš„ç‰¹æ€§é™åˆ¶ï¼Œå…¶åœ¨å†…æ ¸ä¸­å¾ˆå°‘ä½¿ç”¨ã€‚</li>
<li>é€šè¿‡ <code>vm_struct</code> ç»“æ„ä½“è¡¨ç¤º</li>
</ul>
<p><strong>8. Slab Allocator</strong> ç¼“å­˜å±‚</p>
<ul>
<li><u><a href="#3-3-%E3%80%90OS-0x04%E3%80%91Linux-%E5%86%85%E6%A0%B8%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E6%B5%85%E6%9E%90-III-Slub-Allocator">| 3.3 |</a></u></li>
</ul>
<h3 id="1-4-å…¶ä»–-9-13ç« "><a href="#1-4-å…¶ä»–-9-13ç« " class="headerlink" title="| 1.4 | å…¶ä»–(9-13ç« )"></a>| 1.4 | å…¶ä»–(9-13ç« )</h3><p>åè¡¥</p>
<ul>
<li><p><strong>9</strong> Highmem ç®¡ç†</p>
<p>64 ä½ä¸æ¶‰åŠ</p>
</li>
<li><p><strong>10-11</strong> æ¢é¡µ</p>
</li>
<li><p><strong>12</strong> å…±äº«å†…å­˜è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ</p>
</li>
<li><p><strong>13</strong> å†…å­˜ä¸è¶³(OOM)ç®¡ç†</p>
</li>
</ul>
<!-- ## | 2 | <u>[linux-mm-notes, Lorenzo Stoakes](https://github.com/lorenzo-stoakes/linux-mm-notes/tree/master)</u>

å…³äº amd64 æ¶æ„ï¼Œv6 å†…æ ¸çš„å†…å­˜ç®¡ç†æ¢³ç†ã€‚ä½†æ˜¯ä½œè€…å†™åˆ°ä¸€åŠå‡†å¤‡å†™ä¸€æœ¬ä¹¦ï¼Œæ‰€ä»¥å°±æ²¡å…¬å¼€åç»­å†…å®¹ã€‚

### | 2.1 | å†…æ ¸å†…å­˜åˆ†å¸ƒ(Kernel Memory Layout)

å¤ªä¹±äº†ï¼Œç†ä¸æ¸…ï¼Œçœ‹ä¸è¿›å»ã€‚

- è¡¥å……é˜…è¯»ï¼š<u>ğŸ”—[Linux Kernel Doc-Subsystems-Memory Management-Page Tables](https://docs.kernel.org/mm/page_tables.html)</u>

### | 2.2 | ç‰©ç†å†…å­˜ç»„ç»‡ä¸åˆ†é…

- NUMA çš„ä¾‹å­ï¼šä¸€ä¸ªä¸»æ¿ä¸Šå¤šä¸ªå†…å­˜æ’æ§½å¯ä»¥æ’ä¸åŒçš„å†…å­˜æ¡ã€‚ä¸åŒçš„æ’æ§½é—´é€šä¿¡æ¯”è¾ƒæ…¢ï¼Œæ‰€ä»¥æ¯ä¸ªæ’æ§½æŠ½è±¡æˆä¸€ä¸ª *node*ï¼Œå°½é‡åœ¨ *node* å†…éƒ¨åˆ†é…å†…å­˜ï¼Œæé«˜æ•ˆç‡ã€‚ -->

<h2 id="2-Kernel-Exploring-richardweiyang"><a href="#2-Kernel-Exploring-richardweiyang" class="headerlink" title="| 2 | Kernel Exploring, richardweiyang"></a>| 2 | <u><a target="_blank" rel="noopener" href="https://richardweiyang-2.gitbook.io/kernel-exploring">Kernel Exploring</a></u>, richardweiyang</h2><h3 id="2-1-å†…æ ¸åŠ è½½å…¨æµç¨‹"><a href="#2-1-å†…æ ¸åŠ è½½å…¨æµç¨‹" class="headerlink" title="| 2.1 | å†…æ ¸åŠ è½½å…¨æµç¨‹"></a>| 2.1 | å†…æ ¸åŠ è½½å…¨æµç¨‹</h3><ul>
<li><p>Boot loader æŠŠå‹ç¼©å†…æ ¸é•œåƒï¼ˆbzImageï¼‰åŠ è½½åˆ°å†…æ ¸</p>
<p>Boot loader æŒ‰ç…§åè®®æŠŠ bzImage åŠ è½½åˆ°å†…å­˜ï¼Œåˆ†ä¸ºï¼ˆ<code>setup.bin</code>, <code>vmlinux.bin</code>ï¼‰ä¸¤éƒ¨åˆ†ã€‚</p>
<p>ä¸åŒçš„ Boot loader å¯åŠ¨æ—¶ï¼Œä¼šåŠ¨æ€çš„å‘ bzImage çš„ <code>Type_of_loader</code> å­—æ®µå†™å…¥ä¿¡æ¯(0xTV)ï¼Œ<u><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/arch/x86/boot.html">å‚è€ƒå†…æ ¸æ–‡æ¡£</a></u>ã€‚</p>
<p>åŠ è½½åæ§åˆ¶æµåˆ° <code>arch/x86/boot/header.S</code> ä¸­çš„ <code>_start</code>ã€‚</p>
</li>
<li><p>ä»å®æ¨¡å¼è¿›å…¥ä¿æŠ¤æ¨¡å¼</p>
<p><code>_start</code>: ä» <code>start_of_setup:</code> æ ‡å·åå®Œæˆè®¾ç½®æ®µå¯„å­˜å™¨ã€è®¾ç½®å †å’Œæ ˆã€è®¾ç½® .bss æ®µï¼Œç„¶åè·³è½¬åˆ° main å‡½æ•° <code>calll main</code>ï¼Œè·³è½¬åˆ° <code>arch/x86/boot/main.c</code> çš„ <code>main()</code>ã€‚</p>
<p><code>main()</code>: å°†å¯åŠ¨å‚æ•°æ‹·è´åˆ°â€zeropageâ€ï¼Œæ§åˆ¶å°åˆå§‹åŒ–ï¼Œå †åˆå§‹åŒ–ï¼Œæ£€æŸ¥CPUç±»å‹ï¼Œå†…å­˜åˆ†å¸ƒä¾¦æµ‹Â·Â·Â·ï¼Œæœ€åè°ƒç”¨ <code>go_to_protected_mode()</code>ï¼Œè·³è½¬ <code>arch/x86/boot/compressed/head_64.S</code> ä¸­çš„ <code>startup_32</code>ã€‚</p>
</li>
<li><p>è¿‡æ¸¡åˆ° 64 ä½æ¨¡å¼</p>
<p><code>startup_32</code>: åšä¸€äº›åŒ…æ‹¬è¿›å…¥ 64 ä½çš„å‡†å¤‡å·¥ä½œåœ¨å†…çš„åˆå§‹åŒ–åï¼Œè·³è½¬ <code>startup_64</code>ã€‚</p>
</li>
<li><p>è§£å‹ bzImageï¼ˆbzImage &#x3D;&gt; vmlinux)</p>
<p><code>startup_64</code> è°ƒç”¨ <code>extract_kernel</code> è§£å‹æ–°å†…æ ¸ï¼Œè¿”å› vmlinux å…¥å£åœ°å€ï¼Œä¿å­˜åœ¨ rax ä¸­ï¼Œç„¶å <code>jmp *%rax</code>ã€‚</p>
<blockquote>
<p>åœ¨æ²¡æœ‰é…ç½® CONFIG_RELOCATABLE çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç›®æ ‡å°†æŠŠå‹ç¼©çš„å†…æ ¸è§£å‹ç¼©åˆ° CONFIG_PHYSICAL_START è¿™ä¸ªåœ°å€ã€‚è¿™ä¸ªåœ°å€çš„é»˜è®¤é…ç½®æ˜¯ 0x1000000ã€‚</p>
</blockquote>
<p>0x1000000 å³ <code>ehdr.e_entry</code>ï¼Œé€šè¿‡ <code>readelf -h vmlinux</code> æŸ¥çœ‹ã€‚</p>
</li>
<li><p>è¡¥å……ï¼šåŠ è½½ä¹‹å</p>
<p>vmlinux å…¥å£å¯¹åº” <code>arch/x86/kernel/head_64.S</code> çš„ <code>startup_64</code>ã€‚</p>
<p><code>startup_64</code> æœ€å <code>jmp 0x1f</code>ï¼Œæ ¹æ®è°ƒè¯•ä¼šè·³è½¬åˆ° <code>secondary_startup_64</code> ä¸­é—´ä½ç½®ã€‚åœ¨è®¾ç½®å¥½é¡µè¡¨å <code>jmp *%rax</code> è·³è½¬åˆ°è™šæ‹Ÿåœ°å€ï¼ˆå¦‚<code>0xffffffff810000bf</code>ï¼‰ï¼Œå®é™…ä¸Šå°±æ˜¯ä¸‹ä¸€è¡ŒæŒ‡ä»¤ï¼ˆå¦‚ç‰©ç†åœ°å€ <code>0x10000bf</code>ï¼‰ï¼Œç›¸å½“äºç»§ç»­æ‰§è¡Œï¼Œåªæ˜¯è®¾ç½®äº† cr3 å¯„å­˜å™¨ï¼Œå¼€å§‹åˆ†é¡µã€‚</p>
<p>æœ€åè·³è½¬åˆ° initial_code å³ <code>x86_64_start_kernel</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// v6.2 arch/x86/kernel/head_64.S</span></span><br><span class="line"><span class="number">355</span> movq  <span class="title function_">initial_code</span><span class="params">(%rip)</span>, %rax</span><br><span class="line">356 pushq $__KERNEL_CS  <span class="meta"># set correct cs</span></span><br><span class="line">357 pushq %rax    <span class="meta"># target address in negative space</span></span><br><span class="line">358 lretq</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">418 <span class="title function_">SYM_DATA</span><span class="params">(initial_code,  .quad x86_64_start_kernel)</span></span><br></pre></td></tr></table></figure>

<p>å‰©ä¸‹çš„å†…å®¹ç•™åœ¨<strong>åˆå§‹åŒ–</strong>æ—¶å†ç»†çœ‹ã€‚</p>
</li>
</ul>
<h3 id="2-2-å†…å­˜ç®¡ç†"><a href="#2-2-å†…å­˜ç®¡ç†" class="headerlink" title="| 2.2 | å†…å­˜ç®¡ç†"></a>| 2.2 | å†…å­˜ç®¡ç†</h3><h4 id="2-2-1-å†…æ ¸é¡µè¡¨æˆé•¿è®°"><a href="#2-2-1-å†…æ ¸é¡µè¡¨æˆé•¿è®°" class="headerlink" title="| 2.2.1 | å†…æ ¸é¡µè¡¨æˆé•¿è®°"></a>| 2.2.1 | å†…æ ¸é¡µè¡¨æˆé•¿è®°</h4><p>åè¡¥</p>
<h4 id="2-2-2-è‡ªåº•å‘ä¸Šè¯å†…å­˜"><a href="#2-2-2-è‡ªåº•å‘ä¸Šè¯å†…å­˜" class="headerlink" title="| 2.2.2 | è‡ªåº•å‘ä¸Šè¯å†…å­˜"></a>| 2.2.2 | è‡ªåº•å‘ä¸Šè¯å†…å­˜</h4><p><strong>e820</strong> ä»ç¡¬ä»¶è·å–å†…å­˜åˆ†å¸ƒ</p>
<p>e820 æ˜¯ x86 å¹³å°ç”¨äºæ£€æµ‹ç‰©ç†å†…å­˜åˆ†å¸ƒçš„ç¡¬ä»¶ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://richardweiyang-2.gitbook.io/kernel-exploring/nei-cun-guan-li/00-memory_a_bottom_up_view/01-e820_retrieve_memory_from_hw</span></span><br><span class="line"><span class="comment">/* Retrieve the e820 table from BIOS */</span></span><br><span class="line">main(), arch/x86/boot/main.c, called from arch/x86/boot/header.S</span><br><span class="line">      <span class="title function_">detect_memory</span><span class="params">()</span></span><br><span class="line">           <span class="title function_">detect_memory_e820</span><span class="params">()</span>, save bios info to boot_params.e820_entries</span><br><span class="line"></span><br><span class="line"><span class="comment">/* store and sort e820 table to kernel area */</span></span><br><span class="line"><span class="title function_">start_kernel</span><span class="params">()</span></span><br><span class="line">      <span class="title function_">setup_arch</span><span class="params">()</span></span><br><span class="line">           <span class="title function_">e820__memory_setup</span><span class="params">()</span>,</span><br><span class="line">                 x86_init.resources.<span class="title function_">memory_setup</span><span class="params">()</span> -&gt; <span class="title function_">e820__memory_setup_default</span><span class="params">()</span>, store and sort e820 table</span><br><span class="line">                 <span class="title function_">e820__print_table</span><span class="params">()</span></span><br><span class="line">           <span class="title function_">e820__reserve_setup_data</span><span class="params">()</span>;</span><br><span class="line">           e820__finish_early_params();</span><br><span class="line">           e820_add_kernel_range();</span><br><span class="line">           e820__memblock_setup();</span><br></pre></td></tr></table></figure>

<p><strong>memblock</strong> åˆ†é…åˆæœŸå†…å­˜</p>
<p><strong>SPARSEMEM</strong> å†…å­˜æ¨¡å‹</p>
<p>æˆ‘çš„ç†è§£ï¼Œå†…å­˜æ¨¡å‹å°±æ˜¯å®šä¹‰äº† <code>struct page</code> ç»“æ„ä½“ä»¥ä½•ç§æ–¹å¼ä¿å­˜ï¼Œç”¨äºæ˜ å°„ page ç»“æ„ä½“ä¸ç‰©ç†å†…å­˜æœºåˆ¶ã€‚</p>
<blockquote>
<p>åœ¨æ²¡æœ‰ä½¿ç”¨ SPARSEMEM å‰ï¼Œpage ç»“æ„ä½“æ˜¯ä¸€ä¸ªè¿ç»­æ•°ç»„ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœæ•´ä¸ªç³»ç»Ÿæœ€å¤§ä¼šæ”¯æŒå¤šå°‘å†…å­˜ï¼Œéƒ½å¾—é¢„å…ˆåˆ†é…å¥½ç©ºé—´ã€‚å“ªæ€•ä¸­é—´æœ‰ä¸€æ®µç‰©ç†å†…å­˜æ˜¯ç©ºçš„ï¼Œä¹Ÿå¾—ç•™ç€ã€‚</p>
</blockquote>
<p>SPARSEMEM å¼•å…¥ <code>section</code> æ¦‚å¿µï¼Œx86_64 å¹³å°ä¸Šï¼Œsection å¤§å°æ˜¯ (2^27) &#x3D; 128Mã€‚ä¹Ÿå°±æ˜¯æŠŠ 2^(27-12ï¼‰ä¸ª page ç»“æ„ä½“æ”¾åœ¨ä¸€èµ·ä¿å­˜ã€‚</p>
<p>å†…æ ¸é€šè¿‡ <code>__pfn_to_page() __page_to_pfn()</code> ä¸¤ä¸ªå®è¿›è¡Œè½¬åŒ–ã€‚</p>
<p><strong>NUMA</strong> ä¿¡æ¯è·å–</p>
<p><strong>Node-Zone-Page</strong> ç»“æ„</p>
<p><strong>Buddy system</strong> </p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">// https://richardweiyang-2.gitbook.io/kernel-exploring/nei-cun-guan-li/00-memory_a_bottom_up_view/05-node_zone_page</span><br><span class="line">      struct zone</span><br><span class="line">      +------------------------------+      The buddy system</span><br><span class="line">      |free_area[MAX_ORDER]  0...10  |</span><br><span class="line">      |   (struct free_area)         |</span><br><span class="line">      |   +--------------------------+</span><br><span class="line">      |   |nr_free                   |  number of available pages</span><br><span class="line">      |   |(unsigned long)           |  in this zone</span><br><span class="line">      |   |                          |</span><br><span class="line">      |   +--------------------------+</span><br><span class="line">      |   |                          |           free_area[0]</span><br><span class="line">      |   |free_list[MIGRATE_TYPES]  |  Order0   +-----------------------+</span><br><span class="line">      |   |(struct list_head)        |  Pages    |free_list              |</span><br><span class="line">      |   |                          |           |  (struct list_head)   |</span><br><span class="line">      |   | enum migratetype(        |           +-----------------------+</span><br><span class="line">      |   | include/linux/mmzone.h)  |</span><br><span class="line">      |   |                          |           free_area[1]</span><br><span class="line">      |   |                          |  Order1   +-----------------------+</span><br><span class="line">      |   |                          |  Pages    |free_list              |</span><br><span class="line">      |   |                          |           |  (struct list_head)   |</span><br><span class="line">      |   |                          |           +-----------------------+</span><br><span class="line">      |   |                          |</span><br><span class="line">      |   |                          |              .</span><br><span class="line">      |   |                          |              .</span><br><span class="line">      |   |                          |              .</span><br><span class="line">      |   |                          |</span><br><span class="line">      |   |                          |</span><br><span class="line">      |   |                          |           free_area[10]</span><br><span class="line">      |   |                          |  Order10  +-----------------------+</span><br><span class="line">      |   |                          |  Pages    |free_list              |</span><br><span class="line">      |   |                          |           |  (struct list_head)   |</span><br><span class="line">      |   |                          |           +-----------------------+</span><br><span class="line">      |   |                          |</span><br><span class="line">      +---+--------------------------+</span><br></pre></td></tr></table></figure>

<ul>
<li>Compound Page</li>
</ul>
<p><strong>GFP</strong> (<code>include/linux/gfp_types.h</code>)ï¼ŒåŸºæœ¬å¯ä»¥åˆ†æˆä¸‹é¢ä¸‰ç±»ï¼š</p>
<ul>
<li><p><code>___GFP_xxx</code>: Plain integer GFP bitmasks.</p>
</li>
<li><p><code>__GFP_xxx</code>: åŸºæœ¬ä¸Šå°±æ˜¯å¯¹ <code>___GFP_xxx</code> çš„åŒ…è£…ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> __GFP_ATOMIC	((__force gfp_t)___GFP_ATOMIC)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>GFP_xxx</code>: å¯¹ <code>__GFP_xxx</code> çš„ç»„åˆï¼Œç”¨äºè¡¨ç¤ºæ›´é€šå¸¸çš„æƒ…å†µã€‚</p>
</li>
</ul>
<p><strong>per_cpu_pageset</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/linux/mmzone.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @count: é“¾è¡¨é‡Œè¿˜å‰©çš„é¡µ</span></span><br><span class="line"><span class="comment">* @high: é“¾è¡¨ä¿å­˜çš„é¡µæ•°é‡çš„æœ€å¤§å€¼</span></span><br><span class="line"><span class="comment">* @batch: å¦‚æœæ²¡æœ‰é¡µäº†ï¼Œä» buddy é‡Œå– batch ä¸ªé¡µ</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pages</span> &#123;</span></span><br><span class="line">	<span class="type">spinlock_t</span> lock;	<span class="comment">/* Protects lists field */</span></span><br><span class="line">	<span class="type">int</span> count;		<span class="comment">/* number of pages in the list */</span></span><br><span class="line">	<span class="type">int</span> high;		<span class="comment">/* high watermark, emptying needed */</span></span><br><span class="line">	<span class="type">int</span> high_min;		<span class="comment">/* min high watermark */</span></span><br><span class="line">	<span class="type">int</span> high_max;		<span class="comment">/* max high watermark */</span></span><br><span class="line">	<span class="type">int</span> batch;		<span class="comment">/* chunk size for buddy add/remove */</span></span><br><span class="line">	u8 flags;		<span class="comment">/* protected by pcp-&gt;lock */</span></span><br><span class="line">	u8 alloc_factor;	<span class="comment">/* batch scaling factor during allocate */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">	u8 expire;		<span class="comment">/* When 0, remote pagesets are drained */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">short</span> free_count;	<span class="comment">/* consecutive free count */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Lists of pages, one per migrate type stored on the pcp-lists */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">lists</span>[<span class="title">NR_PCP_LISTS</span>];</span></span><br><span class="line">&#125; ____cacheline_aligned_in_smp;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> &#123;</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pages</span>	__<span class="title">percpu</span> *<span class="title">per_cpu_pageset</span>;</span>  <span class="comment">// æ³¨æ„è¿™é‡Œæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œç»“æ„ä½“ä¿å­˜åœ¨å…¶ä»–åœ°æ–¹</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_zonestat</span>	__<span class="title">percpu</span> *<span class="title">per_cpu_zonestats</span>;</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>slub</strong> çš„ç†å¿µ</p>
<ul>
<li><p>åˆ†ç±»</p>
</li>
<li><p>é¢„å–</p>
</li>
</ul>
<h4 id="2-2-3-è™šæ‹Ÿå†…å­˜ç©ºé—´"><a href="#2-2-3-è™šæ‹Ÿå†…å­˜ç©ºé—´" class="headerlink" title="| 2.2.3 | è™šæ‹Ÿå†…å­˜ç©ºé—´"></a>| 2.2.3 | è™šæ‹Ÿå†…å­˜ç©ºé—´</h4><p>åè¡¥</p>
<h2 id="3-arttnba3-ã€OS-0x02-0x04ã€‘Linux-å†…æ ¸å†…å­˜ç®¡ç†-é¡µã€åŒºã€èŠ‚ç‚¹ï¼ŒBuddy-Systemï¼ŒSlub-Allocator"><a href="#3-arttnba3-ã€OS-0x02-0x04ã€‘Linux-å†…æ ¸å†…å­˜ç®¡ç†-é¡µã€åŒºã€èŠ‚ç‚¹ï¼ŒBuddy-Systemï¼ŒSlub-Allocator" class="headerlink" title="| 3 | arttnba3 -ã€OS.0x02-0x04ã€‘Linux å†…æ ¸å†…å­˜ç®¡ç†-é¡µã€åŒºã€èŠ‚ç‚¹ï¼ŒBuddy Systemï¼ŒSlub Allocator"></a>| 3 | arttnba3 -ã€OS.0x02-0x04ã€‘Linux å†…æ ¸å†…å­˜ç®¡ç†-é¡µã€åŒºã€èŠ‚ç‚¹ï¼ŒBuddy Systemï¼ŒSlub Allocator</h2><p>åè¡¥</p>
<p>è®²çš„å¤ªç»†èŠ‚äº†ï¼Œæ„Ÿè§‰ä¸å¤ªé€‚åˆåˆšå¼€å§‹çœ‹ã€‚</p>
<p>a3 å‰ä¸¤ç¯‡ç”¨çš„ v5.11 ç‰ˆæœ¬çš„å†…æ ¸ï¼Œåä¸€ç¯‡ç”¨çš„ v6.2ã€‚</p>
<!--
### | 4.1 | <u>[ã€OS.0x02ã€‘Linux å†…æ ¸å†…å­˜ç®¡ç†I - é¡µã€åŒºã€èŠ‚ç‚¹]()</u>, arttnba3

#### | 4.1.1 | å†…å­˜æ¨¡å‹

- Linux é’ˆå¯¹å†…å­˜çš„ç»„ç»‡ï¼Œæœ‰ä¸‰ç§ï¼ˆä¸¤ç§ï¼Ÿï¼‰æ¨¡å‹ï¼Œå®šä¹‰åœ¨ `include/asm-generic/memory_model.h`:

  `CONFIG_FLATMEM`, `CONFIG_SPARSEMEM_VMEMMAP`, `CONFIG_SPARSEMEM`(v6.2 æ²¡æœ‰ Discontiguous æ¨¡å‹)

  Sparse Memory virtual memmap æ¨¡å‹æœ€å¸¸ç”¨ï¼Œæ˜¯ä¸ºè§£å†³ Sparsemem æ¨¡å‹ `pfn_to_page()` è®¡ç®—æ¯”åŸæ¥çš„æ…¢çš„é—®é¢˜ã€‚

#### | 4.1.2 | watermark

### | 4.2 | <u>[ã€OS.0x03ã€‘Linuxå†…æ ¸å†…å­˜ç®¡ç†II - Buddy System](https://arttnba3.cn/2022/06/30/OS-0X03-LINUX-KERNEL-MEMORY-5.11-PART-II/)</u>, arttnba3

#### | 4.2.1 | GFP(Get Free Page)æ ‡å¿—ä½

- `GFP_KERNEL_ACCOUNT`
- `GFP_KERNEL`

#### | 4.2.2 | `struct alloc_context`

#### | 4.2.2 | `__alloc_page()`

### | 4.3 | <u>[ã€OS.0x04ã€‘Linux å†…æ ¸å†…å­˜ç®¡ç†æµ…æ III - Slub Allocator](https://arttnba3.cn/2023/02/24/OS-0X04-LINUX-KERNEL-MEMORY-6.2-PART-III/)</u>, arttnba3
-->


      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/Linux-Kernel/">Linux Kernel</a><a href="/tags/OS/">OS</a><a href="/tags/Memory-Management/">Memory Management</a><a href="/tags/note/">note</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Deployed by <a href="https://github.com/kaedea/notion-down" target="_blank">notion-down</a> and
    Theme by <a href="https://github.com/kaedea/hexo-theme-hacker" target="_blank">hexo-theme-hacker</a>
    </br>
    
      &copy; 2024
        sev1n75 &lt;sev1n75@qq.com&gt;
          
  </p>
</footer>
    
  </div>
</div>
</body>
</html>